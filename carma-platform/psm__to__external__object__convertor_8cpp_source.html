<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-platform: motion_computation/src/psm_to_external_object_convertor.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Carma-platform<span id="projectnumber">&#160;v4.2.0</span>
   </div>
   <div id="projectbrief">CARMA Platform is built on robot operating system (ROS) and utilizes open source software (OSS) that enables Cooperative Driving Automation (CDA) features to allow Automated Driving Systems to interact and cooperate with infrastructure and other vehicles through communication.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('psm__to__external__object__convertor_8cpp_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle"><div class="title">psm_to_external_object_convertor.cpp</div></div>
</div><!--header-->
<div class="contents">
<a href="psm__to__external__object__convertor_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span> </div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="preprocessor">#include &lt;carma_perception_msgs/msg/external_object.hpp&gt;</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="preprocessor">#include &lt;carma_v2x_msgs/msg/psm.hpp&gt;</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="preprocessor">#include &lt;<a class="code" href="psm__to__external__object__helpers_8hpp.html">motion_computation/impl/psm_to_external_object_helpers.hpp</a>&gt;</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#include &lt;<a class="code" href="message__conversions_8hpp.html">motion_computation/message_conversions.hpp</a>&gt;</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="preprocessor">#include &lt;rclcpp/rclcpp.hpp&gt;</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#include &lt;rclcpp/logging.hpp&gt;</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="preprocessor">#include &lt;rclcpp/logger.hpp&gt;</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#include &lt;tf2/LinearMath/Transform.h&gt;</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#include &lt;boost/date_time/posix_time/posix_time.hpp&gt;</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="preprocessor">#include &lt;lanelet2_extension/regulatory_elements/CarmaTrafficSignal.h&gt;</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="preprocessor">#include &lt;tf2_geometry_msgs/tf2_geometry_msgs.h&gt;</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="preprocessor">#include &lt;wgs84_utils/wgs84_utils.h&gt;</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span> </div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacemotion__computation.html">motion_computation</a> {</div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> </div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="keyword">namespace </span>conversion {</div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span> </div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion.html#a9884e63460f3d5f5e2b755354984dc29">   19</a></span><span class="keywordtype">void</span> <a class="code hl_function" href="namespacemotion__computation_1_1conversion.html#a9884e63460f3d5f5e2b755354984dc29">convert</a>(<span class="keyword">const</span> carma_v2x_msgs::msg::PSM&amp; in_msg, carma_perception_msgs::msg::ExternalObject&amp; out_msg,</div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span>             <span class="keyword">const</span> std::string&amp; map_frame_id, <span class="keywordtype">double</span> pred_period, <span class="keywordtype">double</span> pred_step_size,</div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span> </div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>             <span class="keyword">const</span> lanelet::projection::LocalFrameProjector&amp; map_projector, <span class="keyword">const</span> tf2::Quaternion&amp; ned_in_map_rotation, </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>             rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock) {</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span> </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>  out_msg.dynamic_obj = <span class="keyword">true</span>;  <span class="comment">// If a PSM is sent then the object is dynamic</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>                               <span class="comment">// since its a living thing</span></div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::DYNAMIC_OBJ_PRESENCE;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span>  <span class="comment">// Generate a unique object id from the psm id</span></div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>  out_msg.id = 0;</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = in_msg.id.id.size() - 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt;= 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>--) {  <span class="comment">// using signed iterator to handle empty case</span></div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>    <span class="comment">// each byte of the psm id gets placed in one byte of the object id.</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>    <span class="comment">// This should result in very large numbers which will be unlikely to</span></div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span>    <span class="comment">// conflict with standard detections</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>    out_msg.id |= in_msg.id.id[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] &lt;&lt; (8 * <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>  }</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::ID_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span> </div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span>  <span class="comment">// Additionally, store the id in the bsm_id field</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>  out_msg.bsm_id = in_msg.id.id;</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::BSM_ID_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span> </div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>  <span class="comment">// Compute the timestamp</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span> </div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>  <span class="keyword">auto</span> psm_timestamp = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">impl::get_psm_timestamp</a>(in_msg, node_clock-&gt;get_clock());</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>  out_msg.header.stamp = builtin_interfaces::msg::Time(psm_timestamp);</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>  out_msg.header.frame_id = map_frame_id;</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span> </div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>  <span class="comment">// Set the type</span></div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span> </div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span>  <span class="keywordflow">if</span> (in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PEDESTRIAN ||</div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>      in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PUBLIC_SAFETY_WORKER ||</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>      in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::AN_ANIMAL)  <span class="comment">// Treat animals</span></div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>                                                                                    <span class="comment">// like people</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>                                                                                    <span class="comment">// since we have</span></div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>                                                                                    <span class="comment">// no internal</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span>                                                                                    <span class="comment">// class for that</span></div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>  {</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>    out_msg.object_type = carma_perception_msgs::msg::ExternalObject::PEDESTRIAN;</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span> </div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>    <span class="comment">// Default pedestrian size</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>    <span class="comment">// Assume a</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>    <span class="comment">// ExternalObject dimensions are half actual size</span></div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>    <span class="comment">// Here we assume 1.0, 1.0, 2.0</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>    out_msg.size.x = 0.5;</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>    out_msg.size.y = 0.5;</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>    out_msg.size.z = 1.0;</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PEDALCYCLIST) {</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>    out_msg.object_type =</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>        carma_perception_msgs::msg::ExternalObject::MOTORCYCLE;  <span class="comment">// Currently external object cannot represent bicycles,</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>                                                                 <span class="comment">// but motor cycle seems like the next best choice</span></div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>    <span class="comment">// Default bicycle size</span></div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>    out_msg.size.x = 1.0;</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>    out_msg.size.y = 0.5;</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>    out_msg.size.z = 1.0;</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>    out_msg.object_type = carma_perception_msgs::msg::ExternalObject::UNKNOWN;</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span> </div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>    <span class="comment">// Default pedestrian size</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>    out_msg.size.x = 0.5;</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>    out_msg.size.y = 0.5;</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>    out_msg.size.z = 1.0;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>  }</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::SIZE_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span> </div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>  <span class="comment">// Set the velocity</span></div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span> </div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>  out_msg.velocity.twist.linear.x = in_msg.speed.velocity;</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::VELOCITY_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>  <span class="comment">// NOTE: The velocity covariance is not provided in the PSM. In order to</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>  <span class="comment">// compute it you need at least two PSM messages</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>  <span class="comment">//     Tracking and associating PSM messages would be an increase in</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>  <span class="comment">//     complexity for this conversion which is not warranted without an</span></div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>  <span class="comment">//     existing use case for the velocity covariance. If a use case is</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>  <span class="comment">//     presented for it, such an addition can be made at that time.</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span> </div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span> </div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>  <span class="keywordtype">double</span> largest_position_std = 0.0;</div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>  <span class="keywordtype">double</span> lat_variance = 0.0;</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>  <span class="keywordtype">double</span> lon_variance = 0.0;</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>  <span class="keywordtype">double</span> heading_variance = 0.0;  <span class="comment">// Yaw variance is not available so mark as</span></div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>                             <span class="comment">// impossible perfect case</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>  <span class="keywordtype">double</span> position_confidence = 0.0;  <span class="comment">// Default will be 10% confidence. If the position accuracy is</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>                                      <span class="comment">// available then this value will be updated</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span> </div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>    <span class="comment">// A standard deviation which is larger than the acceptable value to give</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>  <span class="comment">// 95% confidence interval on fitting the pedestrian within one 3.7m lane</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>  <span class="keyword">constexpr</span> <span class="keywordtype">double</span> MAX_POSITION_STD = 1.85;</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>  </div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>  <span class="keywordflow">if</span> ((in_msg.accuracy.presence_vector | carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) &amp;&amp;</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>      (in_msg.accuracy.presence_vector | carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE)) {</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    <span class="comment">// Both accuracies available</span></div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span> </div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>    <span class="comment">// Compute the position covariance</span></div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>    <span class="comment">// For computing confidence we will use the largest provided standard</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>    <span class="comment">// deviation of position</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>    largest_position_std = std::max(in_msg.accuracy.semi_major, in_msg.accuracy.semi_minor);</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>    lat_variance = in_msg.accuracy.semi_minor * in_msg.accuracy.semi_minor;</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>    lon_variance = in_msg.accuracy.semi_major * in_msg.accuracy.semi_major;</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>    heading_variance = in_msg.accuracy.orientation * in_msg.accuracy.orientation;</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span> </div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>    <span class="comment">// NOTE: ExternalObject.msg does not clearly define what is meant by</span></div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>    <span class="comment">// position confidence</span></div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>    <span class="comment">//     Here we are providing a linear scale based on the positional accuracy</span></div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>    <span class="comment">//     where 0 confidence would denote A standard deviation which is larger</span></div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>    <span class="comment">//     than the acceptable value to give 95% confidence interval on fitting</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    <span class="comment">//     the pedestrian within one 3.7m lane</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>    <span class="comment">// Set the confidence</span></div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span>    <span class="comment">// Without a way of getting the velocity confidence from the PSM we will use</span></div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>    <span class="comment">// the position confidence for both</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_msg.accuracy.presence_vector | carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) {</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>    <span class="comment">// Position accuracy available</span></div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span> </div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span> </div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>    largest_position_std = std::max(in_msg.accuracy.semi_major, in_msg.accuracy.semi_minor);</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>    lat_variance = in_msg.accuracy.semi_minor * in_msg.accuracy.semi_minor;</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>    lon_variance = in_msg.accuracy.semi_major * in_msg.accuracy.semi_major;</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>    heading_variance = 1.0;  <span class="comment">// Yaw variance is not available so mark as</span></div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>                             <span class="comment">// impossible perfect case</span></div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span> </div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>    <span class="comment">// Same calculation as shown in above condition. See that for description</span></div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>    out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>    </div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (in_msg.accuracy.presence_vector |</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>             carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE) {</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>    <span class="comment">// Orientation accuracy available</span></div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span> </div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>    lat_variance = 1.0;</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>    lon_variance = 1.0;</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span> </div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>    heading_variance = in_msg.accuracy.orientation * in_msg.accuracy.orientation;</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>  }</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>  <span class="keywordflow">else</span>{ <span class="comment">//No accuracies available</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>    lat_variance = 1.0;</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>    lon_variance = 1.0;</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>    heading_variance = 1.0;</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>  }</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span> </div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>  <span class="comment">// Compute the pose</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>  lanelet::GPSPoint gps_point({in_msg.position.latitude, in_msg.position.longitude, in_msg.position.elevation});</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span>  out_msg.pose = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">impl::pose_from_gnss</a>(map_projector, ned_in_map_rotation, gps_point,</div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>                                      in_msg.heading.heading, lat_variance, lon_variance, heading_variance);</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::POSE_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span> </div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>  <span class="comment">// Compute predictions</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>  <span class="comment">// For prediction, if the prediction is available we will sample it</span></div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>  <span class="comment">// If not then assume linear motion</span></div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span> </div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>  std::vector&lt;geometry_msgs::msg::Pose&gt; predicted_poses;</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span> </div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>  <span class="keywordflow">if</span> (in_msg.presence_vector &amp; carma_v2x_msgs::msg::PSM::HAS_PATH_PREDICTION) {</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>    <span class="comment">// Based on the vehicle frame used in j2735 positive should be to the right</span></div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>    <span class="comment">// and negative to the left</span></div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>    predicted_poses =</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>        <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">impl::sample_2d_path_from_radius</a>(out_msg.pose.pose, out_msg.velocity.twist.linear.x,</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>                                         -in_msg.path_prediction.radius_of_curvature, pred_period, pred_step_size);</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>    predicted_poses =</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>        <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">impl::sample_2d_linear_motion</a>(out_msg.pose.pose, out_msg.velocity.twist.linear.x, pred_period, pred_step_size);</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>  }</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span> </div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>  out_msg.predictions = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">impl::predicted_poses_to_predicted_state</a>(predicted_poses, out_msg.velocity.twist.linear.x, rclcpp::Time(out_msg.header.stamp),</div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>                                                                 rclcpp::Duration(pred_step_size * 1e9), map_frame_id,  out_msg.confidence,</div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>                                                                 out_msg.confidence);</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::PREDICTION_PRESENCE_VECTOR;</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>}</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span> </div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span><span class="keyword">namespace </span>impl {</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">  203</a></span>std::vector&lt;geometry_msgs::msg::Pose&gt; <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">sample_2d_path_from_radius</a>(<span class="keyword">const</span> geometry_msgs::msg::Pose&amp; pose, <span class="keywordtype">double</span> velocity,</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>                                                                 <span class="keywordtype">double</span> radius_of_curvature, <span class="keywordtype">double</span> period,</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>                                                                 <span class="keywordtype">double</span> step_size) {</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>  std::vector&lt;geometry_msgs::msg::Pose&gt; output;</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>  output.reserve((period / step_size) + 1);</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span> </div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>  tf2::Vector3 pose_in_map_translation(pose.position.x, pose.position.y, pose.position.z);</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>  tf2::Quaternion pose_in_map_quat(pose.orientation.x, pose.orientation.y, pose.orientation.z, pose.orientation.w);</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>  tf2::Transform pose_in_map(pose_in_map_quat, pose_in_map_translation);</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span> </div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>  <span class="comment">// The radius of curvature originates from the frame of the provided pose</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>  <span class="comment">// So the turning center is at (0, r)</span></div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>  <span class="keywordtype">double</span> center_x_in_pose = 0;</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>  <span class="keywordtype">double</span> center_y_in_pose = radius_of_curvature;</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span> </div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>  <span class="keywordtype">double</span> total_dt = 0;</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span> </div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>  <span class="keywordflow">while</span> (total_dt &lt; period) {</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>    <span class="comment">// Compute the 2d position and orientation in the Pose frame</span></div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span>    total_dt += step_size;</div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>    <span class="keywordtype">double</span> delta_arc_length = velocity * total_dt;  <span class="comment">// Assumes perfect point motion along curve</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span> </div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>    <span class="keywordtype">double</span> turning_angle = delta_arc_length / radius_of_curvature;</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>    <span class="keywordtype">double</span> dx_from_center = radius_of_curvature * sin(turning_angle);</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>    <span class="keywordtype">double</span> dy_from_center = radius_of_curvature * cos(turning_angle);</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span> </div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a> = center_x_in_pose + dx_from_center;</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>    <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a> = center_y_in_pose + dy_from_center;</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span> </div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>    tf2::Vector3 position(<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>, <a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a>, 0);</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span> </div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>    tf2::Quaternion quat;</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>    quat.setRPY(0, 0, turning_angle);</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span> </div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>    <span class="comment">// Convert the position and orientation in the pose frame to the map frame</span></div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span>    tf2::Transform pose_to_sample(quat, position);</div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>    tf2::Transform map_to_sample = pose_in_map * pose_to_sample;</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span> </div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>    geometry_msgs::msg::Pose sample_pose;</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span> </div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>    sample_pose.position.x = map_to_sample.getOrigin().x();</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span>    sample_pose.position.y = map_to_sample.getOrigin().y();</div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>    sample_pose.position.z = pose.orientation.z;  <span class="comment">// Reuse the z position from the initial pose</span></div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span> </div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>    sample_pose.orientation.x = map_to_sample.getRotation().x();</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>    sample_pose.orientation.y = map_to_sample.getRotation().y();</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>    sample_pose.orientation.z = map_to_sample.getRotation().z();</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>    sample_pose.orientation.w = map_to_sample.getRotation().w();</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span> </div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>    output.emplace_back(sample_pose);</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>  }</div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span> </div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>  <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>}</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span> </div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">  258</a></span>std::vector&lt;geometry_msgs::msg::Pose&gt; <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">sample_2d_linear_motion</a>(<span class="keyword">const</span> geometry_msgs::msg::Pose&amp; pose, <span class="keywordtype">double</span> velocity,</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>                                                              <span class="keywordtype">double</span> period, <span class="keywordtype">double</span> step_size) {</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>  std::vector&lt;geometry_msgs::msg::Pose&gt; output;</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>  output.reserve((period / step_size) + 1);</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span> </div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>  tf2::Vector3 pose_in_map_translation(pose.position.x, pose.position.y, pose.position.z);</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>  tf2::Quaternion pose_in_map_quat(pose.orientation.x, pose.orientation.y, pose.orientation.z, pose.orientation.w);</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span> </div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>  tf2::Transform pose_in_map(pose_in_map_quat, pose_in_map_translation);</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span> </div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>  <span class="keywordtype">double</span> total_dt = 0;</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span> </div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>  <span class="keywordflow">while</span> (total_dt &lt; period) {</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>    <span class="comment">// Compute the 2d position and orientation in the Pose frame</span></div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>    total_dt += step_size;</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>    <span class="keywordtype">double</span> dx_from_start = velocity * total_dt;  <span class="comment">// Assuming linear motion in pose frame</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span> </div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>    <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a> = pose.position.x + dx_from_start;</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span> </div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span>    tf2::Vector3 position(<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>, 0, 0);</div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span> </div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>    <span class="comment">// Convert the position and orientation in the pose frame to the map frame</span></div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>    tf2::Transform pose_to_sample(tf2::Quaternion::getIdentity(), position);</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>    tf2::Transform map_to_sample = pose_in_map * pose_to_sample;</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span> </div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>    geometry_msgs::msg::Pose sample_pose;</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span> </div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>    sample_pose.position.x = map_to_sample.getOrigin().x();</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>    sample_pose.position.y = map_to_sample.getOrigin().y();</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>    sample_pose.position.z = map_to_sample.getOrigin().z();</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span> </div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>    sample_pose.orientation.x = map_to_sample.getRotation().x();</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span>    sample_pose.orientation.y = map_to_sample.getRotation().y();</div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>    sample_pose.orientation.z = map_to_sample.getRotation().z();</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>    sample_pose.orientation.w = map_to_sample.getRotation().w();</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span> </div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>    output.emplace_back(sample_pose);</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>  }</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span> </div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>  <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>}</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span> </div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span><span class="comment">// NOTE heading will need to be set after calling this</span></div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span> </div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">  302</a></span>geometry_msgs::msg::PoseWithCovariance <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">pose_from_gnss</a>(<span class="keyword">const</span> lanelet::projection::LocalFrameProjector&amp; projector,</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>                                                 <span class="keyword">const</span> tf2::Quaternion&amp; ned_in_map_rotation, <span class="keyword">const</span> lanelet::GPSPoint&amp; gps_point,</div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>                                                 <span class="keyword">const</span> <span class="keywordtype">double</span>&amp; heading, <span class="keyword">const</span> <span class="keywordtype">double</span> lat_variance,</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>                                                 <span class="keyword">const</span> <span class="keywordtype">double</span> lon_variance, <span class="keyword">const</span> <span class="keywordtype">double</span> heading_variance) {</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span>  lanelet::BasicPoint3d map_point = projector.forward(gps_point);</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span> </div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>  RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), <span class="stringliteral">&quot;map_point: &quot;</span> &lt;&lt; map_point.x() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; map_point.y() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; map_point.z());</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span> </div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>  <span class="keywordflow">if</span> (fabs(map_point.x()) &gt; 10000.0 ||</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>      fabs(map_point.y()) &gt; 10000.0) {  <span class="comment">// Above 10km from map origin earth curvature will start to have a negative</span></div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>                                        <span class="comment">// impact on system performance</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span> </div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>    RCLCPP_WARN_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), </div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>        <span class="stringliteral">&quot;Distance from map origin is larger than supported by system &quot;</span></div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>        <span class="stringliteral">&quot;assumptions. Strongly advise &quot;</span></div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>        <span class="stringliteral">&quot;alternative map origin be used. &quot;</span>);</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>  }</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span> </div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span>  <span class="comment">// This logic assumes that the orientation difference between an NED frame</span></div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>  <span class="comment">// located at the map origin and an NED frame located at the GNSS point are</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>  <span class="comment">// sufficiently small that they can be ignored. Therefore it is assumed the</span></div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>  <span class="comment">// heading report of the GNSS system regardless of its postion in the map</span></div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span>  <span class="comment">// without change in its orientation will give the same result (as far as we</span></div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>  <span class="comment">// are concered).</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span> </div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>  tf2::Quaternion R_m_n(ned_in_map_rotation);  <span class="comment">// Rotation of NED frame in map</span></div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>                                               <span class="comment">// frame</span></div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>  tf2::Quaternion R_n_h;                       <span class="comment">// Rotation of sensor heading report in NED frame</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>  R_n_h.setRPY(0, 0, heading * wgs84_utils::DEG2RAD);</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span> </div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>  tf2::Quaternion R_m_s = R_m_n * R_n_h;  <span class="comment">// Rotation of sensor in map frame under assumption that</span></div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>                                          <span class="comment">// distance from map origin is sufficiently small so as to</span></div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>                                          <span class="comment">// ignore local changes in NED orientation</span></div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span> </div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span> </div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>  RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), <span class="stringliteral">&quot;R_m_n (x,y,z,w) : ( &quot;</span> &lt;&lt; R_m_n.x() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_n.y() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_n.z() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_n.w());</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span> </div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>  RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), <span class="stringliteral">&quot;R_n_h (x,y,z,w) : ( &quot;</span> &lt;&lt; R_n_h.x() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_n_h.y() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_n_h.z() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_n_h.w());</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span> </div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>  RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), <span class="stringliteral">&quot;R_m_s (x,y,z,w) : ( &quot;</span> &lt;&lt; R_m_s.x() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_s.y() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_s.z() &lt;&lt; <span class="stringliteral">&quot;, &quot;</span> &lt;&lt; R_m_s.w());</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span> </div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>  tf2::Transform T_m_s(R_m_s, tf2::Vector3(map_point.x(), map_point.y(),</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>                                           map_point.z()));  <span class="comment">// Reported position and orientation</span></div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>                                                             <span class="comment">// of sensor frame in map frame</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span> </div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span> </div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>        tf2::Transform T_m_n_no_heading(R_m_n, tf2::Vector3(0, 0, 0)); <span class="comment">// Used to transform the covariance</span></div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span> </div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>        <span class="comment">// This covariance represents the covariance of the NED frame N-lat,</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>        <span class="comment">// E-lon, heading- angle east of north This means that the covariance is</span></div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span>        <span class="comment">// in the NED frame, and needs to be transformed to the map frame</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>        <span class="comment">// clang-format off</span></div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>        std::array&lt;double, 36&gt; input_covariance = { </div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>          lat_variance, 0, 0,  0, 0, 0,</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>          0, lon_variance, 0,  0, 0, 0,</div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>          0, 0, 1,  0, 0, 0,</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>          0,  0,  0,  1,  0, 0,</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>          0,  0,  0,  0,  1, 0, </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>          0,  0,  0,  0,  0, heading_variance</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>        };</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span>        <span class="comment">// clang-format on</span></div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span> </div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>        std::array&lt;double, 36&gt; new_cov =</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>            <a class="code hl_function" href="namespacecovariance__helper.html#af38530465ec3a2a40b4e9be14032f65e">tf2::transformCovariance</a>(input_covariance,</div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>                                     <span class="comment">// Per the usage of transformCovariance in tf2_geometry_msgs</span></div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>                                     <span class="comment">// this frame should be the transform between the map which the pose</span></div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>                                     <span class="comment">// is in an the target frame.</span></div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>                                     T_m_n_no_heading);</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span> </div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>        <span class="comment">// Populate message</span></div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>        geometry_msgs::msg::PoseWithCovariance pose;</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>        pose.pose.position.x = T_m_s.getOrigin().getX();</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>        pose.pose.position.y = T_m_s.getOrigin().getY();</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>        pose.pose.position.z = T_m_s.getOrigin().getZ();</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span> </div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>        pose.pose.orientation.x = T_m_s.getRotation().getX();</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>        pose.pose.orientation.y = T_m_s.getRotation().getY();</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>        pose.pose.orientation.z = T_m_s.getRotation().getZ();</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>        pose.pose.orientation.w = T_m_s.getRotation().getW();</div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span> </div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span>        pose.covariance = new_cov;</div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span> </div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>        <span class="keywordflow">return</span> pose;</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>}</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span> </div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span> </div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">  391</a></span>std::vector&lt;carma_perception_msgs::msg::PredictedState&gt; <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">predicted_poses_to_predicted_state</a>(</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>    <span class="keyword">const</span> std::vector&lt;geometry_msgs::msg::Pose&gt;&amp; poses, <span class="keywordtype">double</span> constant_velocity, <span class="keyword">const</span> rclcpp::Time&amp; start_time,</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>    <span class="keyword">const</span> rclcpp::Duration&amp; step_size, <span class="keyword">const</span> std::string&amp; frame, <span class="keywordtype">double</span> initial_pose_confidence,</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>    <span class="keywordtype">double</span> initial_vel_confidence) {</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span>  std::vector&lt;carma_perception_msgs::msg::PredictedState&gt; output;</div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>  output.reserve(poses.size());</div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span> </div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>  rclcpp::Time time(start_time);</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span> </div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>  <span class="keywordflow">for</span> (<span class="keyword">auto</span> p : poses) {</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>    time += step_size;</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>    carma_perception_msgs::msg::PredictedState pred_state;</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>    pred_state.header.stamp = time;</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span>    pred_state.header.frame_id = frame;</div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span> </div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>    pred_state.predicted_position = p;</div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>    pred_state.predicted_position_confidence = 0.9 * initial_pose_confidence;  <span class="comment">// Reduce confidence by 10 % per timestep</span></div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span>    initial_pose_confidence = pred_state.predicted_position_confidence;</div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span> </div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span>    pred_state.predicted_velocity.linear.x = constant_velocity;</div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>    pred_state.predicted_velocity_confidence = 0.9 * initial_vel_confidence;  <span class="comment">// Reduce confidence by 10 % per</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>                                                                                     <span class="comment">// timestep</span></div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>    initial_vel_confidence = pred_state.predicted_velocity_confidence;</div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span> </div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>    output.push_back(pred_state);</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>  }</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span> </div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span>  <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>}</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span> </div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno"><a class="line" href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">  421</a></span>rclcpp::Time <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">get_psm_timestamp</a>(<span class="keyword">const</span> carma_v2x_msgs::msg::PSM&amp; in_msg, rclcpp::Clock::SharedPtr clock) {</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span>    boost::posix_time::ptime utc_time_of_current_psm;</div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span> </div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>  <span class="comment">// Get the utc epoch start time</span></div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>  <span class="keyword">static</span> <span class="keyword">const</span> boost::posix_time::ptime inception_boost(boost::posix_time::time_from_string(<span class="stringliteral">&quot;1970-01-01 00:00:00.000&quot;</span>));</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span> </div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>  <span class="comment">// Determine if the utc time of the path history can be used instead of the</span></div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>  <span class="comment">// sec_mark The sec_mark is susceptible to large error on minute transitions</span></div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span>  <span class="comment">// due to missing &quot;minute of the year&quot; field If the second mark in the path</span></div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>  <span class="comment">// history is identical and the full utc time is provided with ms resolution</span></div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>  <span class="comment">// then it can be assumed the initial_position is the same as the PSM data and</span></div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>  <span class="comment">// the utc_time can be used instead of sec_mark</span></div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>  <span class="comment">// clang-format off</span></div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>  <span class="keywordflow">if</span> ((in_msg.presence_vector &amp; </div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span>        carma_v2x_msgs::msg::PSM::HAS_PATH_HISTORY) &amp;&amp;</div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>        (in_msg.path_history.presence_vector &amp; </div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>        carma_v2x_msgs::msg::PathHistory::HAS_INITIAL_POSITION) &amp;&amp;</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::YEAR) &amp;&amp;</div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::MONTH) &amp;&amp;</div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::DAY) &amp;&amp;</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::HOUR) &amp;&amp;</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::MINUTE) &amp;&amp;</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>        (in_msg.path_history.initial_position.utc_time.presence_vector &amp; j2735_v2x_msgs::msg::DDateTime::SECOND) &amp;&amp;</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>      (in_msg.sec_mark.millisecond == in_msg.path_history.initial_position.utc_time.second.millisecond)) {</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span>    <span class="comment">// clang-format on</span></div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>),</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span>                        <span class="stringliteral">&quot;Using UTC time of path history to determine PSM &quot;</span></div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>                        <span class="stringliteral">&quot;timestamp. Assumed valid since UTC is fully specified &quot;</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>                        <span class="stringliteral">&quot;and sec_mark == utc_time.seconds in this message.&quot;</span>);</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span> </div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>    boost::posix_time::time_duration time_of_day = boost::posix_time::hours(in_msg.path_history.initial_position.utc_time.hour.hour) +</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>                                                   boost::posix_time::minutes(in_msg.path_history.initial_position.utc_time.minute.minute) +</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>                                                   boost::posix_time::milliseconds(in_msg.path_history.initial_position.utc_time.second.millisecond);</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span> </div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>    boost::gregorian::date utc_day(in_msg.path_history.initial_position.utc_time.year.year,</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>                                   in_msg.path_history.initial_position.utc_time.month.month,</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>                                   in_msg.path_history.initial_position.utc_time.day.day);</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span> </div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span>    utc_time_of_current_psm = boost::posix_time::ptime(utc_day) + time_of_day;</div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>  } <span class="keywordflow">else</span> {  <span class="comment">// If the utc time of the path history cannot be used to account for minute</span></div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>            <span class="comment">// change over, then we have to default to the sec mark</span></div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span> </div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>    RCLCPP_WARN_STREAM_THROTTLE(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>), *clock.get(), rclcpp::Duration(5, 0).nanoseconds(),</div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>                                <span class="stringliteral">&quot;PSM PathHistory utc timstamp does not match &quot;</span></div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>                                <span class="stringliteral">&quot;sec_mark. Unable to determine the minute of &quot;</span></div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span>                                <span class="stringliteral">&quot;the year used for PSM data. Assuming local &quot;</span></div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>                                <span class="stringliteral">&quot;clock is exactly synced. This is NOT &quot;</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>                                <span class="stringliteral">&quot;ADVISED.&quot;</span>);</div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span> </div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>    <span class="comment">// Get the current ROS time</span></div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>    <span class="keyword">auto</span> current_time = clock-&gt;now();</div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span> </div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>    <span class="comment">// Convert the ros time to a boost duration</span></div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>    boost::posix_time::time_duration duration_since_inception(lanelet::time::durationFromSec(current_time.seconds()));</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span> </div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>    <span class="comment">// Get the current ROS time in UTC</span></div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>    <span class="keyword">auto</span> curr_time_boost = inception_boost + duration_since_inception;</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span> </div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>    <span class="comment">// Get duration of current day</span></div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>    <span class="keyword">auto</span> duration_in_day_till_current_time = curr_time_boost.time_of_day();</div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span> </div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno">  482</span>    <span class="comment">// Extract hours and minutes</span></div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span>    <span class="keywordtype">long</span> hour_count_in_day = duration_in_day_till_current_time.hours() ;</div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>    <span class="keywordtype">long</span> minute_count_in_hour = duration_in_day_till_current_time.minutes();</div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span> </div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>    <span class="comment">// Get the duration of the minute in the day</span></div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span>    <span class="keyword">auto</span> start_of_minute_in_day = boost::posix_time::hours(hour_count_in_day) + boost::posix_time::minutes(minute_count_in_hour);</div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span> </div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>    <span class="comment">// Get the start of the day in ROS time</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>    boost::posix_time::ptime start_of_day(curr_time_boost.date());</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span> </div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>    <span class="comment">// Ge the start of the current minute in ROS time</span></div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>    boost::posix_time::ptime utc_start_of_current_minute = start_of_day + start_of_minute_in_day;</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span> </div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>    <span class="comment">// Compute the UTC PSM stamp from the sec_mark using ROS time as the clock</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span> </div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>    boost::posix_time::time_duration s_in_cur_minute = boost::posix_time::milliseconds(in_msg.sec_mark.millisecond);</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span> </div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>    utc_time_of_current_psm = utc_start_of_current_minute + s_in_cur_minute;</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span>  }</div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span> </div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>  boost::posix_time::time_duration nsec_since_epoch = utc_time_of_current_psm - inception_boost;</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span> </div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span>  <span class="keywordflow">if</span> (nsec_since_epoch.is_special()) {</div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>    RCLCPP_ERROR_STREAM(rclcpp::get_logger(<span class="stringliteral">&quot;motion_computation::conversion&quot;</span>),</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span>                        <span class="stringliteral">&quot;Computed psm nsec_since_epoch is special (computation &quot;</span></div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>                        <span class="stringliteral">&quot;failed). Value effectively undefined.&quot;</span>);</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>  }</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span> </div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>  <span class="keywordflow">return</span> rclcpp::Time(nsec_since_epoch.total_nanoseconds());</div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span> </div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>}</div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span>}  <span class="comment">// namespace impl</span></div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span> </div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>}  <span class="comment">// namespace conversion</span></div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>}  <span class="comment">// namespace motion_computation</span></div>
<div class="ttc" id="amessage__conversions_8hpp_html"><div class="ttname"><a href="message__conversions_8hpp.html">message_conversions.hpp</a></div></div>
<div class="ttc" id="anamespacecovariance__helper_html_af38530465ec3a2a40b4e9be14032f65e"><div class="ttname"><a href="namespacecovariance__helper.html#af38530465ec3a2a40b4e9be14032f65e">covariance_helper::transformCovariance</a></div><div class="ttdeci">geometry_msgs::msg::PoseWithCovariance::_covariance_type transformCovariance(const geometry_msgs::msg::PoseWithCovariance::_covariance_type &amp;cov_in, const tf2::Transform &amp;transform)</div><div class="ttdoc">Transform the covariance matrix of a PoseWithCovariance message to a new frame.</div><div class="ttdef"><b>Definition:</b> <a href="covariance__helper_8h_source.html#l00057">covariance_helper.h:57</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a48389a44ecd9e272dbbcdebea32601fb"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">motion_computation::conversion::impl::sample_2d_path_from_radius</a></div><div class="ttdeci">std::vector&lt; geometry_msgs::msg::Pose &gt; sample_2d_path_from_radius(const geometry_msgs::msg::Pose &amp;pose, double velocity, double radius_of_curvature, double period, double step_size)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00203">psm_to_external_object_convertor.cpp:203</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a50c675cb23fd3a743226b22287b32945"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">motion_computation::conversion::impl::pose_from_gnss</a></div><div class="ttdeci">geometry_msgs::msg::PoseWithCovariance pose_from_gnss(const lanelet::projection::LocalFrameProjector &amp;projector, const tf2::Quaternion &amp;ned_in_map_rotation, const lanelet::GPSPoint &amp;gps_point, const double &amp;heading, const double lat_variance, const double lon_variance, const double heading_variance)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00302">psm_to_external_object_convertor.cpp:302</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a7cf9dd84c4528278ce20562def3047c3"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">motion_computation::conversion::impl::predicted_poses_to_predicted_state</a></div><div class="ttdeci">std::vector&lt; carma_perception_msgs::msg::PredictedState &gt; predicted_poses_to_predicted_state(const std::vector&lt; geometry_msgs::msg::Pose &gt; &amp;poses, double constant_velocity, const rclcpp::Time &amp;start_time, const rclcpp::Duration &amp;step_size, const std::string &amp;frame, double initial_pose_confidence, double initial_vel_confidence)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00391">psm_to_external_object_convertor.cpp:391</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_adcf6c7b8fa415af10c0cc489388fce40"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">motion_computation::conversion::impl::get_psm_timestamp</a></div><div class="ttdeci">rclcpp::Time get_psm_timestamp(const carma_v2x_msgs::msg::PSM &amp;in_msg, rclcpp::Clock::SharedPtr clock)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00421">psm_to_external_object_convertor.cpp:421</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_ae5e3a18881b54fc666c13199ea6c7073"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">motion_computation::conversion::impl::sample_2d_linear_motion</a></div><div class="ttdeci">std::vector&lt; geometry_msgs::msg::Pose &gt; sample_2d_linear_motion(const geometry_msgs::msg::Pose &amp;pose, double velocity, double period, double step_size)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00258">psm_to_external_object_convertor.cpp:258</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_html_a9884e63460f3d5f5e2b755354984dc29"><div class="ttname"><a href="namespacemotion__computation_1_1conversion.html#a9884e63460f3d5f5e2b755354984dc29">motion_computation::conversion::convert</a></div><div class="ttdeci">void convert(const carma_v2x_msgs::msg::PSM &amp;in_msg, carma_perception_msgs::msg::ExternalObject &amp;out_msg, const std::string &amp;map_frame_id, double pred_period, double pred_step_size, const lanelet::projection::LocalFrameProjector &amp;map_projector, const tf2::Quaternion &amp;ned_in_map_rotation, rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00019">psm_to_external_object_convertor.cpp:19</a></div></div>
<div class="ttc" id="anamespacemotion__computation_html"><div class="ttname"><a href="namespacemotion__computation.html">motion_computation</a></div><div class="ttdef"><b>Definition:</b> <a href="mobility__path__to__external__object__helpers_8hpp_source.html#l00011">mobility_path_to_external_object_helpers.hpp:11</a></div></div>
<div class="ttc" id="anamespaceprocess__bag_html_af102a02c97622dd30b0dbf7bafb0d199"><div class="ttname"><a href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">process_bag.i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="process__bag_8py_source.html#l00059">process_bag.py:59</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_a05bdb238bfbf3836fb0aa69c5aa1bb48"><div class="ttname"><a href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">process_traj_logs.y</a></div><div class="ttdeci">y</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00129">process_traj_logs.py:129</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_af3ba6144a2d35a4990f1a8d04632a052"><div class="ttname"><a href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">process_traj_logs.x</a></div><div class="ttdeci">x</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00128">process_traj_logs.py:128</a></div></div>
<div class="ttc" id="apsm__to__external__object__helpers_8hpp_html"><div class="ttname"><a href="psm__to__external__object__helpers_8hpp.html">psm_to_external_object_helpers.hpp</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_63e6aad264477fa7f28f31d2fc233dbe.html">motion_computation</a></li><li class="navelem"><a class="el" href="dir_54c025c2a7d69c52f0ce93d682ccc770.html">src</a></li><li class="navelem"><a class="el" href="psm__to__external__object__convertor_8cpp.html">psm_to_external_object_convertor.cpp</a></li>
    <li class="footer">Generated on Sun Jun 4 2023 23:39:02 for Carma-platform by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
