<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-streets: intersection_model</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Carma-streets<span id="projectnumber">&#160;v4.2.0</span>
   </div>
   <div id="projectbrief">CARMA Streets is a component of CARMA ecosystem that improves the efficiency and performance of the Transportation Systems Management and Operations (TSMO) strategies.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_intersection_model_readme.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title"><a class="el" href="namespaceintersection__model.html">intersection_model</a> </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md18"></a>
A Library to read lanelet2 osm map</h1>
<p >This library will read and lanelet2 osm map and take in a configurable bounding box to mark the intersection being managed. The library will store the appropriate lanelet2 objects inside this bound box including entry lanes into the intersection, linking lanes through the intersection and any regulatory elements (stop bars, stop signs, traffic lights, speed limits) inside the intersection. The <a class="el" href="namespaceintersection__model.html">intersection_model</a> had methods to translate GPS location data into lane specific information like lanelet id and distance to the end of the lane for services like the message_service to provide lane. The <a class="el" href="namespaceintersection__model.html">intersection_model</a> will also return the intersection lanelet2 objects to services that need them to make sense of the lane specific updates the message_service provides.</p>
<h2><a class="anchor" id="autotoc_md19"></a>
Steps to Build intersection_model locally</h2>
<div class="fragment"><div class="line">apt-get update  &amp;&amp; apt-get install -y cmake libboost1.65-all-dev git autotools-dev automake sqlite3 libsqlite3-dev curl libpugixml-dev libgeographic-dev qtbase5-dev qtbase5-dev-tools libqhttpengine-dev libssl-dev</div>
<div class="line"> </div>
<div class="line"># Clone and install googletest, librdkafka, spdlog and rapidjson in the ext/ directory</div>
<div class="line">cd carma-streets root directory</div>
<div class="line">mkdir ext/</div>
<div class="line">cd ext/</div>
<div class="line">git clone https://github.com/google/googletest/</div>
<div class="line">cd googletest/</div>
<div class="line">cmake .</div>
<div class="line">make</div>
<div class="line">sudo make install</div>
<div class="line"> </div>
<div class="line">cd /ext</div>
<div class="line">git clone https://github.com/edenhill/librdkafka</div>
<div class="line">cd  librdkafka/</div>
<div class="line">./configure --prefix=/usr</div>
<div class="line">make</div>
<div class="line">sudo make install</div>
<div class="line"> </div>
<div class="line">cd ext/</div>
<div class="line">git clone https://github.com/gabime/spdlog.git</div>
<div class="line">cd spdlog/</div>
<div class="line">mkdir build </div>
<div class="line">cd  build</div>
<div class="line">cmake .. &amp;&amp; make -j</div>
<div class="line">sudo make install</div>
<div class="line"> </div>
<div class="line">cd ext</div>
<div class="line">git clone  https://github.com/Tencent/rapidjson</div>
<div class="line">cd  rapidjson/</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">cmake .. &amp;&amp; make -j</div>
<div class="line">sudo make install</div>
<div class="line"> </div>
<div class="line"># Install kafka-clients library</div>
<div class="line">cd carma-streets/kafka_clients</div>
<div class="line">mkdir build/</div>
<div class="line">cd build</div>
<div class="line">make ..</div>
<div class="line">make</div>
<div class="line">sudo make install</div>
<div class="line"> </div>
<div class="line"># Install PROJ, a package for coordinate transformations</div>
<div class="line">sudo git clone https://github.com/OSGeo/PROJ.git   carma-streets/ext/PROJ --branch 6.2.1 &amp;&amp; \</div>
<div class="line">        cd /home/carma-streets/PROJ &amp;&amp; \</div>
<div class="line">        sudo ./autogen.sh &amp;&amp; \</div>
<div class="line">        sudo ./configure &amp;&amp; \</div>
<div class="line">        sudo make &amp;&amp; \</div>
<div class="line">        sudo make install</div>
<div class="line">        </div>
<div class="line"># Download a cmake module for PROJ</div>
<div class="line">cd /usr/share/cmake-3.10/Modules &amp;&amp; sudo curl -O https://raw.githubusercontent.com/mloskot/cmake-modules/master/modules/FindPROJ4.cmake</div>
<div class="line"> </div>
<div class="line">ENV DEBIAN_FRONTEND=noninteractive</div>
<div class="line"> </div>
<div class="line">sudo apt update &amp;&amp; \</div>
<div class="line">    sudo apt install -y lsb-release &amp;&amp; \</div>
<div class="line">    sudo sh -c &#39;echo &quot;deb http://packages.ros.org/ros/ubuntu $(lsb_release -sc) main&quot; &gt; /etc/apt/sources.list.d/ros-latest.list&#39; &amp;&amp; \</div>
<div class="line">    curl -s https://raw.githubusercontent.com/ros/rosdistro/master/ros.asc | sudo apt-key add -</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Install CARMA Ready Lanelet2</div>
<div class="line"># Lanelet2 is written on the assumption ROS exists. Therefore some special steps are needed for compilation</div>
<div class="line"># First catkin_make must be installed. The version needed is only available with the ros-melodic-catkin build</div>
<div class="line"># This means the ros source list must be added to sudo to allow this installation</div>
<div class="line"># Additionally, the python-rospkg package managment tool is required for catkin to work properly </div>
<div class="line">RUN sudo DEBIAN_FRONTEND=noninteractive apt update &amp;&amp; \</div>
<div class="line">    sudo DEBIAN_FRONTEND=noninteractive apt install -y ros-melodic-catkin &amp;&amp; \</div>
<div class="line">    echo &quot;source /opt/ros/melodic/setup.bash&quot; &gt;&gt; /root/.bashrc &amp;&amp; \</div>
<div class="line">    echo &quot;source /home/carma-streets/install/setup.bash&quot; &gt;&gt; /root/.bashrc</div>
<div class="line"> </div>
<div class="line"># Once catkin is installed only the required lanelet2 packages will be pulled in from carma</div>
<div class="line"># NOTE: The lanelet2_python package requires additional dependencies that have not yet been installed so it is removed for now</div>
<div class="line">cd carma-streets/</div>
<div class="line">mkdir carma_lanelet2 &amp;&amp; \</div>
<div class="line">    cd carma_lanelet2 &amp;&amp; \</div>
<div class="line">    mkdir src &amp;&amp; \</div>
<div class="line">    cd src &amp;&amp; \</div>
<div class="line">    git init &amp;&amp; \</div>
<div class="line">    echo &quot;temp&quot; &amp;&amp; \</div>
<div class="line">    git remote add origin -f https://github.com/usdot-fhwa-stol/autoware.ai.git &amp;&amp; \</div>
<div class="line">    git config core.sparsecheckout true &amp;&amp; \</div>
<div class="line">    echo &quot;common/hardcoded_params/*&quot; &gt;&gt; .git/info/sparse-checkout &amp;&amp; \</div>
<div class="line">    echo &quot;common/lanelet2_extension/*&quot; &gt;&gt; .git/info/sparse-checkout &amp;&amp; \</div>
<div class="line">    echo &quot;lanelet2/*&quot; &gt;&gt; .git/info/sparse-checkout &amp;&amp; \</div>
<div class="line">    echo &quot;mrt_cmake_modules/*&quot; &gt;&gt; .git/info/sparse-checkout &amp;&amp; \</div>
<div class="line">    git pull --depth 1 origin refactor_lanelet2_extension &amp;&amp; \</div>
<div class="line">    git checkout refactor_lanelet2_extension &amp;&amp; \</div>
<div class="line">    rm -r lanelet2/lanelet2_python &amp;&amp; \</div>
<div class="line">    rm -r lanelet2/lanelet2_examples</div>
<div class="line"> </div>
<div class="line">cd carma_lanelet2/</div>
<div class="line"> </div>
<div class="line"># In order to trick lanelet2 into building the ROS_VERSION environment variable must be set</div>
<div class="line"># In order to fully decouple lanelet2_extension from ros the LANELET2_EXTENSION_LOGGER_TYPE environment variable must be set</div>
<div class="line">source /opt/ros/melodic/setup.bash &amp;&amp; \</div>
<div class="line">    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y python-rospkg &amp;&amp; \</div>
<div class="line">    sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libeigen3-dev &amp;&amp; \</div>
<div class="line">    ROS_VERSION=1 LANELET2_EXTENSION_LOGGER_TYPE=1 catkin_make install</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"># Install intersection_model</div>
<div class="line">cd carma-streets/intersection_model</div>
<div class="line">mkdir build</div>
<div class="line">cd build</div>
<div class="line">RUN cmake ..</div>
<div class="line">RUN make</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md20"></a>
Steps to Build intersection_model using Docker</h2>
<div class="fragment"><div class="line">Navigate to /carma-streets/ directory</div>
<div class="line">docker build -t intersection_model -f intersection_model/Dockerfile .</div>
</div><!-- fragment --> <h2><a class="anchor" id="autotoc_md21"></a>
API definition</h2>
<ol type="1">
<li>intersection model is a service used the expose intersection geometry information from MAP and lanelet2 osm map to carma-streets services that require this information via REST server.</li>
<li>Intersection Geometry consists of list of entry, link, and departure lanelets which have the following fields: <div class="fragment"><div class="line">intersection_info:</div>
<div class="line">      type: object</div>
<div class="line">      properties:</div>
<div class="line">        id:</div>
<div class="line">          type: integer</div>
<div class="line">        name:</div>
<div class="line">          type: string</div>
<div class="line">        entry_lanelets:</div>
<div class="line">          $ref: &quot;#/components/schemas/lanelet_array&quot;</div>
<div class="line">        link_lanelets:</div>
<div class="line">          $ref: &quot;#/components/schemas/lanelet_array&quot;</div>
<div class="line">        departure_lanelets:</div>
<div class="line">          $ref: &quot;#/components/schemas/lanelet_array&quot;</div>
<div class="line">        </div>
<div class="line">lanelet_array:</div>
<div class="line">    description: The array of lanelets</div>
<div class="line">    type: array</div>
<div class="line">    items:</div>
<div class="line">        $ref: &quot;#/components/schemas/lanelet_info&quot;</div>
<div class="line"> </div>
<div class="line">lanelet_info:</div>
<div class="line">    description: The information of lanelet </div>
<div class="line">    type: object</div>
<div class="line">    properties:</div>
<div class="line">      id:</div>
<div class="line">        type: integer</div>
<div class="line">      speed_limit:</div>
<div class="line">        type: number</div>
<div class="line">        description: Unit of measure is m/s</div>
<div class="line">      conflict_lanelet_ids:</div>
<div class="line">        type: array</div>
<div class="line">        items:</div>
<div class="line">          type: integer</div>
<div class="line">        description: List of unique identifers for lanelets that have conflicts</div>
<div class="line">      length:</div>
<div class="line">        type: number</div>
<div class="line">        description: The length of lanelet. Unit of measure is meter</div>
<div class="line">      turn_direction:</div>
<div class="line">        type: string</div>
<div class="line">        description: Turn direction of intersection lane</div>
<div class="line">      signal_group_id: </div>
<div class="line">        type: integer</div>
<div class="line">        description: The matching signal group send by the SPAT message for this lanelet</div>
<div class="line">      connecting_lanelet_ids:</div>
<div class="line">        description: List of unique identifers for following lanelets that are connecting the depature and entry lanelets</div>
<div class="line">        type: array</div>
<div class="line">        items:</div>
<div class="line">          type: integer</div>
</div><!-- fragment --></li>
<li>Intesection model handler and router classes inherit from the default handler and router classes from the generated library in streets_utils/streets_api folder. </li>
</ol>
<h2><a class="anchor" id="autotoc_md22"></a>
Notes</h2>
<p >When running unit test for the intersection model, making sure the correct osm file is upload under the <a class="el" href="namespaceintersection__model.html">intersection_model</a> directory. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed May 24 2023 18:09:11 for Carma-streets by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
