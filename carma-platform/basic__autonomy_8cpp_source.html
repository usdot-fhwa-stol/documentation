<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-platform: basic_autonomy/src/basic_autonomy.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Carma-platform<span id="projectnumber">&#160;v4.2.0</span>
   </div>
   <div id="projectbrief">CARMA Platform is built on robot operating system (ROS) and utilizes open source software (OSS) that enables Cooperative Driving Automation (CDA) features to allow Automated Driving Systems to interact and cooperate with infrastructure and other vehicles through communication.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('basic__autonomy_8cpp_source.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle"><div class="title">basic_autonomy.cpp</div></div>
</div><!--header-->
<div class="contents">
<a href="basic__autonomy_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">/*</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment"> * Copyright (C) 2021-2022 LEIDOS.</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment"> *</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span><span class="comment"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not</span></div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="comment"> * use this file except in compliance with the License. You may obtain a copy of</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span><span class="comment"> * the License at</span></div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="comment"> *</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="comment"> * http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="comment"> *</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="comment"> * Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="comment"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="comment"> * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="comment"> * License for the specific language governing permissions and limitations under</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="comment"> * the License.</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="comment"> */</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span> </div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="preprocessor">#include &lt;<a class="code" href="basic__autonomy_2include_2basic__autonomy_2log_2log_8hpp.html">basic_autonomy/log/log.hpp</a>&gt;</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="preprocessor">#include &lt;<a class="code" href="helper__functions_8hpp.html">basic_autonomy/helper_functions.hpp</a>&gt;</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span> </div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacebasic__autonomy.html">basic_autonomy</a></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span>{</div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span>    <span class="keyword">namespace </span>waypoint_generation</div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span>    {</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#acdcd3bb44d31aa6405b30f151ea35ae4">   24</a></span>         std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#acdcd3bb44d31aa6405b30f151ea35ae4">create_geometry_profile</a>(<span class="keyword">const</span> std::vector&lt;carma_planning_msgs::msg::Maneuver&gt; &amp;maneuvers, <span class="keywordtype">double</span> max_starting_downtrack,<span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm,</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span>                                                                   carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer,<span class="keyword">const</span> carma_planning_msgs::msg::VehicleState&amp; state,</div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span>                                                                   <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">GeneralTrajConfig</a> &amp;general_config, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config){</div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span>            std::vector&lt;PointSpeedPair&gt; points_and_target_speeds;</div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span> </div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span>            <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span>            std::unordered_set&lt;lanelet::Id&gt; visited_lanelets;</div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span> </div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;VehDowntrack:&quot;</span>&lt;&lt;max_starting_downtrack);</div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>            <span class="keywordflow">for</span>(<span class="keyword">const</span> <span class="keyword">auto</span> &amp;maneuver : maneuvers)</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span>            {</div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span>                <span class="keywordtype">double</span> starting_downtrack = <a class="code hl_define" href="approaching__emergency__vehicle__plugin__node_8hpp.html#a066f948508e087006568cb6c9b0674a7">GET_MANEUVER_PROPERTY</a>(maneuver, start_dist);</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span> </div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span>                <span class="keywordflow">if</span>(first){</div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>                    starting_downtrack = std::min(starting_downtrack, max_starting_downtrack);</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span>                    first = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span>                }</div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Used downtrack: &quot;</span> &lt;&lt; starting_downtrack);</div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span> </div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span>                <span class="keywordflow">if</span>(maneuver.type == carma_planning_msgs::msg::Maneuver::LANE_FOLLOWING){</div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>),<span class="stringliteral">&quot;Creating Lane Follow Geometry&quot;</span>);</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span>                    std::vector&lt;PointSpeedPair&gt; lane_follow_points = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa3500af9146c0d9c80cb1b4101be01e5">create_lanefollow_geometry</a>(maneuver, starting_downtrack, wm, general_config, detailed_config, visited_lanelets);</div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span>                    points_and_target_speeds.insert(points_and_target_speeds.end(), lane_follow_points.begin(), lane_follow_points.end());</div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span>                }</div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(maneuver.type == carma_planning_msgs::msg::Maneuver::LANE_CHANGE){</div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Creating Lane Change Geometry&quot;</span>);</div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>                    std::vector&lt;PointSpeedPair&gt; lane_change_points = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af992a6cbbdafd6e86d73976a65164e94">get_lanechange_points_from_maneuver</a>(maneuver, starting_downtrack, wm, ending_state_before_buffer, state, general_config, detailed_config);</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>                    points_and_target_speeds.insert(points_and_target_speeds.end(), lane_change_points.begin(), lane_change_points.end());</div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>                }</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>                <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span>                    <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;This maneuver type is not supported&quot;</span>);</div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>                }</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span> </div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>            }</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span> </div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>            <span class="comment">//Add buffer ending to lane follow points at the end of maneuver(s) end dist</span></div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>            <span class="keywordflow">if</span>(maneuvers.back().type == carma_planning_msgs::msg::Maneuver::LANE_FOLLOWING){</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span>                points_and_target_speeds = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ad56958ee3bb11064df00a37cbf948b8d">add_lanefollow_buffer</a>(wm, points_and_target_speeds, maneuvers, ending_state_before_buffer, detailed_config);</div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span> </div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span>            }</div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>            <span class="keywordflow">return</span> points_and_target_speeds;</div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span> </div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>        }</div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span> </div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa3500af9146c0d9c80cb1b4101be01e5">   68</a></span>        std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa3500af9146c0d9c80cb1b4101be01e5">create_lanefollow_geometry</a>(<span class="keyword">const</span> carma_planning_msgs::msg::Maneuver &amp;maneuver, <span class="keywordtype">double</span> starting_downtrack,</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span>                                                                <span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">GeneralTrajConfig</a> &amp;general_config,</div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span>                                                                <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config, std::unordered_set&lt;lanelet::Id&gt; &amp;visited_lanelets)</div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>        {</div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>            <span class="keywordflow">if</span>(maneuver.type != carma_planning_msgs::msg::Maneuver::LANE_FOLLOWING){</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Create_lanefollow called on a maneuver type which is not LANE_FOLLOW&quot;</span>);</div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>            }</div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>            std::vector&lt;PointSpeedPair&gt; points_and_target_speeds;</div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span> </div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>            carma_planning_msgs::msg::LaneFollowingManeuver lane_following_maneuver = maneuver.lane_following_maneuver;</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span> </div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>            <span class="keywordflow">if</span> (maneuver.lane_following_maneuver.lane_ids.empty())</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>            {</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;No lanelets are defined for lanefollow maneuver&quot;</span>);</div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>            }</div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span> </div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>            std::vector&lt;lanelet::ConstLanelet&gt; lanelets = { wm-&gt;getMap()-&gt;laneletLayer.get(stoi(lane_following_maneuver.lane_ids[0]))}; <span class="comment">// Accept first lanelet reguardless</span></div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; lane_following_maneuver.lane_ids.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++) <span class="comment">// Iterate over remaining lanelets and check if they are followers of the previous lanelet</span></div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>            {</div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>                <span class="keyword">auto</span> ll_id = lane_following_maneuver.lane_ids[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>                <span class="keywordtype">int</span> cur_id = stoi(ll_id);</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>                <span class="keyword">auto</span> cur_ll = wm-&gt;getMap()-&gt;laneletLayer.get(cur_id);</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>                <span class="keyword">auto</span> following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(lanelets.back());</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>                <span class="keywordtype">bool</span> is_follower = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>                <span class="keywordflow">for</span> (<span class="keyword">auto</span> follower_ll : following_lanelets )</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span>                {</div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span>                    <span class="keywordflow">if</span> (follower_ll.id() == cur_ll.id())</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>                    {</div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>                        is_follower = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>                    }</div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>                }</div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span> </div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>                <span class="keywordflow">if</span> (!is_follower)</div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>                {</div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>                    <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Invalid list of lanelets they are not followers&quot;</span>);</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span>                }</div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span> </div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>                lanelets.push_back(cur_ll); <span class="comment">// Keep lanelet</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span> </div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span>            }</div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span> </div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>            <span class="comment">// Add extra lanelet to ensure there are sufficient points for buffer</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>            <span class="keyword">auto</span> extra_following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(lanelets.back());</div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span> </div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>            <span class="keywordflow">for</span> (<span class="keyword">auto</span> llt : wm-&gt;getRoute()-&gt;shortestPath())</div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>            {</div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>                <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; extra_following_lanelets.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>                {</div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>                    <span class="keywordflow">if</span> (llt.id() == extra_following_lanelets[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].id())</div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>                    {</div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>                        lanelets.push_back(extra_following_lanelets[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]);</div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>                    }</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span>                }</div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>            }</div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span> </div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>            <span class="keywordflow">if</span> (lanelets.empty())</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>            {</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>                RCLCPP_ERROR_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Detected no lanelets between starting downtrack: &quot;</span>&lt;&lt; starting_downtrack &lt;&lt; <span class="stringliteral">&quot;, and lane_following_maneuver.end_dist: &quot;</span>&lt;&lt; lane_following_maneuver.end_dist);</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Detected no lanelets between starting_downtrack and end_dist&quot;</span>);</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>            }</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span> </div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Maneuver&quot;</span>);</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span> </div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>            lanelet::BasicLineString2d downsampled_centerline;</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>            <span class="comment">// 400 value here is an arbitrary attempt at improving inlane-cruising performance by reducing copy operations.</span></div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>            <span class="comment">// Value picked based on annecdotal evidence from STOL system testing</span></div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>            downsampled_centerline.reserve(400);</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span> </div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>            <span class="comment">//getLaneletsBetween is inclusive of lanelets between its two boundaries</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>            <span class="comment">//which may return lanechange lanelets, so</span></div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>            <span class="comment">//exclude lanechanges and plan for only the straight part</span></div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>            <span class="keywordtype">size_t</span> curr_idx = 0;</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>            <span class="keyword">auto</span> following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(lanelets[curr_idx]);</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>            lanelet::ConstLanelets straight_lanelets;</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span> </div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>            <span class="keywordflow">if</span>(lanelets.size() &lt;= 1) <span class="comment">//no lane change anyways if only size 1</span></div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span>            {</div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Detected one straight lanelet Id:&quot;</span> &lt;&lt; lanelets[curr_idx].<span class="keywordtype">id</span>());</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>                straight_lanelets = lanelets;</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>            }</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>            {</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span>                <span class="comment">// skip all lanechanges until lane follow starts</span></div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span>                <span class="keywordflow">while</span> (curr_idx + 1 &lt; lanelets.size() &amp;&amp;</div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>                        std::find(following_lanelets.begin(),following_lanelets.end(), lanelets[curr_idx + 1]) == following_lanelets.end())</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span>                {</div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;As there were no directly following lanelets after this, skipping lanelet id: &quot;</span> &lt;&lt; lanelets[curr_idx].<span class="keywordtype">id</span>());</div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>                    curr_idx ++;</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span>                    following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(lanelets[curr_idx]);</div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>                }</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span> </div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Added lanelet Id for lane follow: &quot;</span> &lt;&lt; lanelets[curr_idx].<span class="keywordtype">id</span>());</div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span>                <span class="comment">// guaranteed to have at least one &quot;straight&quot; lanelet (e.g the last one in the list)</span></div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>                straight_lanelets.push_back(lanelets[curr_idx]);</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>                      <span class="comment">// add all lanelets on the straight road until next lanechange</span></div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>                <span class="keywordflow">while</span> (curr_idx + 1 &lt; lanelets.size() &amp;&amp;</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>                        std::find(following_lanelets.begin(),following_lanelets.end(), lanelets[curr_idx + 1]) != following_lanelets.end())</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span>                {</div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>                    curr_idx++;</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Added lanelet Id forlane follow: &quot;</span> &lt;&lt; lanelets[curr_idx].<span class="keywordtype">id</span>());</div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>                    straight_lanelets.push_back(lanelets[curr_idx]);</div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>                    following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(lanelets[curr_idx]);</div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>                }</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span> </div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>            }</div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span> </div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span>            <span class="keywordflow">for</span> (<span class="keyword">auto</span> l : straight_lanelets)</div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>            {</div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Processing lanelet ID: &quot;</span> &lt;&lt; l.id());</div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>                <span class="keywordflow">if</span> (visited_lanelets.find(l.id()) == visited_lanelets.end())</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>                {</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span> </div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span>                    <span class="keywordtype">bool</span> is_turn = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>                    <span class="keywordflow">if</span>(l.hasAttribute(<span class="stringliteral">&quot;turn_direction&quot;</span>)) {</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>                        std::string turn_direction = l.attribute(<span class="stringliteral">&quot;turn_direction&quot;</span>).value();</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>                        is_turn = turn_direction.compare(<span class="stringliteral">&quot;left&quot;</span>) == 0 || turn_direction.compare(<span class="stringliteral">&quot;right&quot;</span>) == 0;</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>                    }</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span> </div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span>                    lanelet::BasicLineString2d centerline = l.centerline2d().basicLineString();</div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>                    lanelet::BasicLineString2d downsampled_points;</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span>                    <span class="keywordflow">if</span> (is_turn) {</div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>                        downsampled_points = carma_ros2_utils::containers::downsample_vector(centerline, general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a57b1703c6bbc6043c489280ca1c34041">turn_downsample_ratio</a>);</div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>                    } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>                        downsampled_points = carma_ros2_utils::containers::downsample_vector(centerline, general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a0ad2d91d1f739942213d5bfe7f0e861f">default_downsample_ratio</a>);</div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>                    }</div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span> </div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>                    <span class="keywordflow">if</span>(downsampled_centerline.size() != 0 &amp;&amp; downsampled_points.size() != 0 <span class="comment">// If this is not the first lanelet and the points are closer than 1m drop the first point to prevent overlap</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>                    &amp;&amp; lanelet::geometry::distance2d(downsampled_points.front(), downsampled_centerline.back()) &lt;1.2){</div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>                        downsampled_points = lanelet::BasicLineString2d(downsampled_points.begin() + 1, downsampled_points.end());</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>                    }</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span> </div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span>                    downsampled_centerline = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#ae7d5ca280140dce2bf7bcfb78bdfd55d">carma_wm::geometry::concatenate_line_strings</a>(downsampled_centerline, downsampled_points);</div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>                    visited_lanelets.insert(l.id());</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span>                }</div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>            }</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span> </div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>            <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>            <span class="keywordflow">for</span> (<span class="keyword">auto</span> p : downsampled_centerline)</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>            {</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>                <span class="keywordflow">if</span> (first &amp;&amp; !points_and_target_speeds.empty())</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>                {</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>                    first = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span>                    <span class="keywordflow">continue</span>; <span class="comment">// Skip the first point if we have already added points from a previous maneuver to avoid duplicates</span></div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>                }</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>                <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html">PointSpeedPair</a> pair;</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>                pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#a628d9d3853745335b42ad940136d88ac">point</a> = p;</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>                pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#aafb815247d0179093dcd47c9e9be3428">speed</a> = lane_following_maneuver.end_speed;</div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>                points_and_target_speeds.push_back(pair);</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>            }</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span> </div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>            <span class="keywordflow">return</span> points_and_target_speeds;</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span> </div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>        }</div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span> </div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#ad56958ee3bb11064df00a37cbf948b8d">  225</a></span>        std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ad56958ee3bb11064df00a37cbf948b8d">add_lanefollow_buffer</a>(<span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm, std::vector&lt;PointSpeedPair&gt;&amp; points_and_target_speeds, <span class="keyword">const</span> std::vector&lt;carma_planning_msgs::msg::Maneuver&gt; &amp;maneuvers,</div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>             carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config){</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span> </div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span> </div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>            <span class="keywordtype">double</span> starting_route_downtrack = wm-&gt;routeTrackPos(points_and_target_speeds.front().point).downtrack;</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span> </div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>            <span class="comment">// Always try to add the maximum buffer. Even if the route ends it may still be possible to add buffered points.</span></div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>            <span class="comment">// This does mean that downstream components might not be able to assume the buffer points are on the route</span></div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>            <span class="comment">// though this is not likely to be an issue as they are buffer only</span></div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>            <span class="keywordtype">double</span> ending_downtrack = maneuvers.back().lane_following_maneuver.end_dist + detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a>;</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span> </div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Add lanefollow buffer: ending_downtrack: &quot;</span> &lt;&lt; ending_downtrack &lt;&lt; <span class="stringliteral">&quot;, maneuvers.back().lane_following_maneuver.end_dist: &quot;</span> &lt;&lt; maneuvers.back().lane_following_maneuver.end_dist &lt;&lt;</div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>                            <span class="stringliteral">&quot;, detailed_config.buffer_ending_downtrack: &quot;</span> &lt;&lt; detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a>);</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span> </div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>            <span class="keywordtype">size_t</span> max_i = points_and_target_speeds.size() - 1;</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span>            <span class="keywordtype">size_t</span> unbuffered_idx = points_and_target_speeds.size() - 1;</div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>            <span class="keywordtype">bool</span> found_unbuffered_idx = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>            <span class="keywordtype">double</span> dist_accumulator = starting_route_downtrack;</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>            lanelet::BasicPoint2d prev_point;</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span> </div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span>            boost::optional&lt;lanelet::BasicPoint2d&gt; delta_point;</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; points_and_target_speeds.size(); ++<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>) {</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>                <span class="keyword">auto</span> current_point = points_and_target_speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].point;</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span> </div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> == 0) {</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>                    prev_point = current_point;</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span>                }</div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span> </div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>                <span class="keywordtype">double</span> delta_d = lanelet::geometry::distance2d(prev_point, current_point);</div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span> </div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>                dist_accumulator += delta_d;</div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Index i: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt;&lt; <span class="stringliteral">&quot;, delta_d: &quot;</span> &lt;&lt; delta_d &lt;&lt; <span class="stringliteral">&quot;, dist_accumulator:&quot;</span> &lt;&lt; dist_accumulator &lt;&lt;<span class="stringliteral">&quot;, current_point.x():&quot;</span> &lt;&lt; current_point.x() &lt;&lt;</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>                <span class="stringliteral">&quot;current_point.y():&quot;</span> &lt;&lt; current_point.y());</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>                <span class="keywordflow">if</span> (dist_accumulator &gt; maneuvers.back().lane_following_maneuver.end_dist &amp;&amp; !found_unbuffered_idx)</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>                {</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span>                    unbuffered_idx = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> - 1;</div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Found index unbuffered_idx at: &quot;</span> &lt;&lt; unbuffered_idx);</div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>                    found_unbuffered_idx = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>                }</div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span> </div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>                <span class="keywordflow">if</span> (dist_accumulator &gt; ending_downtrack) {</div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>                    max_i = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>;</div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Max_i breaking at: i: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt;&lt; <span class="stringliteral">&quot;, max_i: &quot;</span> &lt;&lt; max_i);</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>                }</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span> </div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>                <span class="comment">// If there are no more points to add but we haven&#39;t reached the ending downtrack then</span></div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>                <span class="comment">// construct an extrapolated straight line from the final point and keep adding to this line until the downtrack is met</span></div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span>                <span class="comment">// Since this is purely needed to allow for a spline fit edge case, it should have minimal impact on the actual steering behavior of the vehicle</span></div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> == points_and_target_speeds.size() - 1) <span class="comment">// dist_accumulator &lt; ending_downtrack is guaranteed by earlier conditional</span></div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>                {</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span> </div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Extending trajectory using buffer beyond end of target lanelet&quot;</span>);</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span>                    <span class="keywordtype">int</span> j = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> - 1;</div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>                    <span class="keywordflow">while</span> (delta_d &lt; epsilon_ &amp;&amp; j &gt;= 0 &amp;&amp; !delta_point)</div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>                    {</div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>                        RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Looking at index j: &quot;</span> &lt;&lt; j &lt;&lt; <span class="stringliteral">&quot;, where i: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>                        prev_point = points_and_target_speeds.at(j).point;</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span>                        j--;</div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>                        delta_d = lanelet::geometry::distance2d(prev_point, current_point);</div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>                    }</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span> </div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>                    <span class="keywordflow">if</span> (j &lt; 0 &amp;&amp; delta_d &lt; <a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a05408c147e288f4120ad1a8c90dd3241">epsilon_</a>) <span class="comment">//a very rare case where only duplicate points exist in the entire trajectory, so it wasn&#39;t possible to extend</span></div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span> </div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>                    <span class="keywordflow">if</span> (!delta_point) { <span class="comment">// Set the step size based on last two distinct points</span></div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>                        delta_point = (current_point - prev_point) * 0.25; <span class="comment">// Use a smaller step size then default to help ensure enough points are generated;</span></div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>                    }</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span> </div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>                    <span class="comment">// Create an extrapolated new point</span></div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>                    <span class="keyword">auto</span> new_point = current_point + delta_point.get();</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span> </div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>                    <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html">PointSpeedPair</a> new_pair;</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>                    new_pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#a628d9d3853745335b42ad940136d88ac">point</a> = new_point;</div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>                    new_pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#aafb815247d0179093dcd47c9e9be3428">speed</a> = points_and_target_speeds.back().speed;</div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span> </div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span> </div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span>                    points_and_target_speeds.push_back(new_pair);</div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>                }</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span> </div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>                prev_point = current_point;</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span>            }</div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span> </div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>            ending_state_before_buffer.x_pos_global = points_and_target_speeds[unbuffered_idx].point.x();</div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>            ending_state_before_buffer.y_pos_global = points_and_target_speeds[unbuffered_idx].point.y();</div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Here ending_state_before_buffer.x_pos_global: &quot;</span> &lt;&lt; ending_state_before_buffer.x_pos_global &lt;&lt;</div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>            <span class="stringliteral">&quot;, and y_pos_global&quot;</span> &lt;&lt; ending_state_before_buffer.y_pos_global);</div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span> </div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>            std::vector&lt;PointSpeedPair&gt; constrained_points(points_and_target_speeds.begin(), points_and_target_speeds.begin() + max_i);</div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span> </div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>            <span class="keywordflow">return</span> constrained_points;</div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>        }</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span> </div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a2219ab96db87781023137bdb45af1ea2">  319</a></span>        std::vector&lt;lanelet::BasicPoint2d&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a2219ab96db87781023137bdb45af1ea2">create_lanechange_geometry</a>(lanelet::Id starting_lane_id, lanelet::Id ending_lane_id, <span class="keywordtype">double</span> starting_downtrack, <span class="keywordtype">double</span> ending_downtrack,</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>                                                                   <span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm, <span class="keywordtype">int</span> downsample_ratio, <span class="keywordtype">double</span> buffer_ending_downtrack)</div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>        {</div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>            std::vector&lt;lanelet::BasicPoint2d&gt; centerline_points;</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span> </div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>            <span class="comment">//Get starting lanelet and ending lanelets</span></div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>            lanelet::ConstLanelet starting_lanelet = wm-&gt;getMap()-&gt;laneletLayer.get(starting_lane_id);</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span>            lanelet::ConstLanelet ending_lanelet = wm-&gt;getMap()-&gt;laneletLayer.get(ending_lane_id);</div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span> </div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>            lanelet::ConstLanelets starting_lane;</div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>            starting_lane.push_back(starting_lanelet);</div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span> </div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>            std::vector&lt;lanelet::BasicPoint2d&gt; reference_centerline;</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span>            <span class="comment">// 400 value here is an arbitrary attempt at improving performance by reducing copy operations.</span></div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span>            <span class="comment">// Value picked based on annecdotal evidence from STOL system testing</span></div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>            reference_centerline.reserve(400);</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>            <span class="keywordtype">bool</span> shared_boundary_found = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>            <span class="keywordtype">bool</span> is_lanechange_left = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span> </div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>            lanelet::BasicLineString2d current_lanelet_centerline = starting_lanelet.centerline2d().basicLineString();</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>            lanelet::ConstLanelet current_lanelet = starting_lanelet;</div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>            reference_centerline.insert(reference_centerline.end(), current_lanelet_centerline.begin(), current_lanelet_centerline.end());</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span> </div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Searching for shared boundary with starting lanechange lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(current_lanelet.id()) &lt;&lt; <span class="stringliteral">&quot; and ending lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(ending_lanelet.id()));</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>            <span class="keywordflow">while</span>(!shared_boundary_found){</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>                <span class="comment">//Assumption- Adjacent lanelets share lane boundary</span></div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>                <span class="keywordflow">if</span>(current_lanelet.leftBound() == ending_lanelet.rightBound()){</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(current_lanelet.id()) &lt;&lt; <span class="stringliteral">&quot; shares left boundary with &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(ending_lanelet.id()));</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span>                    is_lanechange_left = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span>                    shared_boundary_found = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span>                }</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span> </div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>                <span class="keywordflow">else</span> <span class="keywordflow">if</span>(current_lanelet.rightBound() == ending_lanelet.leftBound()){</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(current_lanelet.id()) &lt;&lt; <span class="stringliteral">&quot; shares right boundary with &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(ending_lanelet.id()));</div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span>                    shared_boundary_found = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>                }</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span> </div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>                <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>                    <span class="comment">//If there are no following lanelets on route, lanechange should be completing before reaching it</span></div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span>                    <span class="keywordflow">if</span>(wm-&gt;getMapRoutingGraph()-&gt;following(current_lanelet, <span class="keyword">false</span>).empty())</div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span>                    {</div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span>                        <span class="comment">// Maneuver requires we travel further before completing lane change, but no routable lanelet directly ahead</span></div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>                        <span class="comment">//In this case we have reached a lanelet which does not have a routable lanelet ahead + isn&#39;t adjacent to the lanelet where lane change ends</span></div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span>                        <span class="comment">//A lane change should have already happened at this point</span></div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span>                        <span class="keywordflow">throw</span>(std::invalid_argument(<span class="stringliteral">&quot;No following lanelets from current lanelet reachable without a lane change, incorrectly chosen end lanelet&quot;</span>));</div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>                    }</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span> </div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>                    current_lanelet = wm-&gt;getMapRoutingGraph()-&gt;following(current_lanelet, <span class="keyword">false</span>).front();</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span>                    <span class="keywordflow">if</span>(current_lanelet.id() == starting_lanelet.id()){</div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span>                        <span class="comment">//Looped back to starting lanelet</span></div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>                        <span class="keywordflow">throw</span>(std::invalid_argument(<span class="stringliteral">&quot;No lane change in path&quot;</span>));</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>                    }</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Now checking for shared lane boundary with lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(current_lanelet.id()) &lt;&lt; <span class="stringliteral">&quot; and ending lanelet &quot;</span> &lt;&lt; <a class="code hl_function" href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">std::to_string</a>(ending_lanelet.id()));</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>                    <span class="keyword">auto</span> current_lanelet_linestring = current_lanelet.centerline2d().basicLineString();</div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>                    <span class="comment">//Concatenate linestring starting from + 1 to avoid overlap</span></div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>                    reference_centerline.insert(reference_centerline.end(), current_lanelet_linestring.begin() + 1, current_lanelet_linestring.end());</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>                    starting_lane.push_back(current_lanelet);</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>                }</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>            }</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span> </div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>            <span class="comment">// Create the target lane centerline using lanelets adjacent to the lanechange lanelets in the starting lane</span></div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span>            std::vector&lt;lanelet::BasicPoint2d&gt; target_lane_centerline;</div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span>            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0;<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>&lt;starting_lane.size();++<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>){</div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span>                lanelet::ConstLanelet curr_end_lanelet;</div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span> </div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>                <span class="keywordflow">if</span>(is_lanechange_left){</div>
<div class="line"><a id="l00385" name="l00385"></a><span class="lineno">  385</span> </div>
<div class="line"><a id="l00386" name="l00386"></a><span class="lineno">  386</span>                    <span class="comment">//get left lanelet</span></div>
<div class="line"><a id="l00387" name="l00387"></a><span class="lineno">  387</span>                    <span class="keywordflow">if</span>(wm-&gt;getMapRoutingGraph()-&gt;left(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>])){</div>
<div class="line"><a id="l00388" name="l00388"></a><span class="lineno">  388</span>                        curr_end_lanelet = wm-&gt;getMapRoutingGraph()-&gt;left(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]).get();</div>
<div class="line"><a id="l00389" name="l00389"></a><span class="lineno">  389</span>                    }</div>
<div class="line"><a id="l00390" name="l00390"></a><span class="lineno">  390</span>                    <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00391" name="l00391"></a><span class="lineno">  391</span>                        curr_end_lanelet = wm-&gt;getMapRoutingGraph()-&gt;adjacentLeft(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]).get();</div>
<div class="line"><a id="l00392" name="l00392"></a><span class="lineno">  392</span>                    }</div>
<div class="line"><a id="l00393" name="l00393"></a><span class="lineno">  393</span>                }</div>
<div class="line"><a id="l00394" name="l00394"></a><span class="lineno">  394</span>                <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00395" name="l00395"></a><span class="lineno">  395</span> </div>
<div class="line"><a id="l00396" name="l00396"></a><span class="lineno">  396</span>                    <span class="comment">//get right lanelet</span></div>
<div class="line"><a id="l00397" name="l00397"></a><span class="lineno">  397</span>                    <span class="keywordflow">if</span>(wm-&gt;getMapRoutingGraph()-&gt;right(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>])){</div>
<div class="line"><a id="l00398" name="l00398"></a><span class="lineno">  398</span>                        curr_end_lanelet = wm-&gt;getMapRoutingGraph()-&gt;right(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]).get();</div>
<div class="line"><a id="l00399" name="l00399"></a><span class="lineno">  399</span>                    }</div>
<div class="line"><a id="l00400" name="l00400"></a><span class="lineno">  400</span>                    <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00401" name="l00401"></a><span class="lineno">  401</span>                        curr_end_lanelet = wm-&gt;getMapRoutingGraph()-&gt;adjacentRight(starting_lane[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]).get();</div>
<div class="line"><a id="l00402" name="l00402"></a><span class="lineno">  402</span>                    }</div>
<div class="line"><a id="l00403" name="l00403"></a><span class="lineno">  403</span>                }</div>
<div class="line"><a id="l00404" name="l00404"></a><span class="lineno">  404</span> </div>
<div class="line"><a id="l00405" name="l00405"></a><span class="lineno">  405</span>                <span class="keyword">auto</span> target_lane_linestring = curr_end_lanelet.centerline2d().basicLineString();</div>
<div class="line"><a id="l00406" name="l00406"></a><span class="lineno">  406</span>                <span class="comment">//Concatenate linestring starting from + 1 to avoid overlap</span></div>
<div class="line"><a id="l00407" name="l00407"></a><span class="lineno">  407</span>                target_lane_centerline.insert(target_lane_centerline.end(), target_lane_linestring.begin() + 1, target_lane_linestring.end());</div>
<div class="line"><a id="l00408" name="l00408"></a><span class="lineno">  408</span> </div>
<div class="line"><a id="l00409" name="l00409"></a><span class="lineno">  409</span>            }</div>
<div class="line"><a id="l00410" name="l00410"></a><span class="lineno">  410</span> </div>
<div class="line"><a id="l00411" name="l00411"></a><span class="lineno">  411</span>            <span class="comment">//Downsample centerlines</span></div>
<div class="line"><a id="l00412" name="l00412"></a><span class="lineno">  412</span>            <span class="comment">// 400 value here is an arbitrary attempt at improving performance by reducing copy operations.</span></div>
<div class="line"><a id="l00413" name="l00413"></a><span class="lineno">  413</span>            <span class="comment">// Value picked based on annecdotal evidence from STOL system testing</span></div>
<div class="line"><a id="l00414" name="l00414"></a><span class="lineno">  414</span> </div>
<div class="line"><a id="l00415" name="l00415"></a><span class="lineno">  415</span>            std::vector&lt;lanelet::BasicPoint2d&gt; downsampled_starting_centerline;</div>
<div class="line"><a id="l00416" name="l00416"></a><span class="lineno">  416</span>            downsampled_starting_centerline.reserve(400);</div>
<div class="line"><a id="l00417" name="l00417"></a><span class="lineno">  417</span>            downsampled_starting_centerline = carma_ros2_utils::containers::downsample_vector(reference_centerline, downsample_ratio);</div>
<div class="line"><a id="l00418" name="l00418"></a><span class="lineno">  418</span> </div>
<div class="line"><a id="l00419" name="l00419"></a><span class="lineno">  419</span>            std::vector&lt;lanelet::BasicPoint2d&gt; downsampled_target_centerline;</div>
<div class="line"><a id="l00420" name="l00420"></a><span class="lineno">  420</span>            downsampled_target_centerline.reserve(400);</div>
<div class="line"><a id="l00421" name="l00421"></a><span class="lineno">  421</span>            downsampled_target_centerline = carma_ros2_utils::containers::downsample_vector(target_lane_centerline, downsample_ratio);</div>
<div class="line"><a id="l00422" name="l00422"></a><span class="lineno">  422</span> </div>
<div class="line"><a id="l00423" name="l00423"></a><span class="lineno">  423</span>            <span class="comment">// Constrain centerlines to starting and ending downtrack</span></div>
<div class="line"><a id="l00424" name="l00424"></a><span class="lineno">  424</span>            <span class="keywordtype">int</span> start_index_starting_centerline = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">waypoint_generation::get_nearest_index_by_downtrack</a>(downsampled_starting_centerline, wm, starting_downtrack);</div>
<div class="line"><a id="l00425" name="l00425"></a><span class="lineno">  425</span>            carma_planning_msgs::msg::VehicleState start_state;</div>
<div class="line"><a id="l00426" name="l00426"></a><span class="lineno">  426</span>            start_state.x_pos_global = downsampled_starting_centerline[start_index_starting_centerline].x();</div>
<div class="line"><a id="l00427" name="l00427"></a><span class="lineno">  427</span>            start_state.y_pos_global = downsampled_starting_centerline[start_index_starting_centerline].y();</div>
<div class="line"><a id="l00428" name="l00428"></a><span class="lineno">  428</span>            <span class="keywordtype">int</span> start_index_target_centerline = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a924ac023f1b51e791ca1b61b9194f44a">waypoint_generation::get_nearest_point_index</a>(downsampled_target_centerline, start_state);</div>
<div class="line"><a id="l00429" name="l00429"></a><span class="lineno">  429</span> </div>
<div class="line"><a id="l00430" name="l00430"></a><span class="lineno">  430</span>            <span class="keywordtype">int</span> end_index_target_centerline = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">waypoint_generation::get_nearest_index_by_downtrack</a>(downsampled_target_centerline, wm, ending_downtrack);</div>
<div class="line"><a id="l00431" name="l00431"></a><span class="lineno">  431</span>            carma_planning_msgs::msg::VehicleState end_state;</div>
<div class="line"><a id="l00432" name="l00432"></a><span class="lineno">  432</span>            end_state.x_pos_global = downsampled_target_centerline[end_index_target_centerline].x();</div>
<div class="line"><a id="l00433" name="l00433"></a><span class="lineno">  433</span>            end_state.y_pos_global = downsampled_target_centerline[end_index_target_centerline].y();</div>
<div class="line"><a id="l00434" name="l00434"></a><span class="lineno">  434</span>            <span class="keywordtype">int</span> end_index_starting_centerline = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a924ac023f1b51e791ca1b61b9194f44a">waypoint_generation::get_nearest_point_index</a>(downsampled_starting_centerline, end_state);</div>
<div class="line"><a id="l00435" name="l00435"></a><span class="lineno">  435</span> </div>
<div class="line"><a id="l00436" name="l00436"></a><span class="lineno">  436</span>            std::vector&lt;lanelet::BasicPoint2d&gt; constrained_start_centerline(downsampled_starting_centerline.begin() + start_index_starting_centerline, downsampled_starting_centerline.begin() + end_index_starting_centerline);</div>
<div class="line"><a id="l00437" name="l00437"></a><span class="lineno">  437</span>            std::vector&lt;lanelet::BasicPoint2d&gt; constrained_target_centerline(downsampled_target_centerline.begin() + start_index_target_centerline, downsampled_target_centerline.begin() + end_index_target_centerline);</div>
<div class="line"><a id="l00438" name="l00438"></a><span class="lineno">  438</span> </div>
<div class="line"><a id="l00439" name="l00439"></a><span class="lineno">  439</span>            <span class="comment">// If constrained centerlines are not the same size - resample to ensure same size along both centerlines</span></div>
<div class="line"><a id="l00440" name="l00440"></a><span class="lineno">  440</span>            <span class="keywordflow">if</span>(constrained_start_centerline.size() != constrained_target_centerline.size())</div>
<div class="line"><a id="l00441" name="l00441"></a><span class="lineno">  441</span>            {</div>
<div class="line"><a id="l00442" name="l00442"></a><span class="lineno">  442</span>                <span class="keyword">auto</span> centerlines = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a19cf5cf882789e1e9ed3e92d0105a8de">resample_linestring_pair_to_same_size</a>(constrained_start_centerline, constrained_target_centerline);</div>
<div class="line"><a id="l00443" name="l00443"></a><span class="lineno">  443</span>                constrained_start_centerline = centerlines[0];</div>
<div class="line"><a id="l00444" name="l00444"></a><span class="lineno">  444</span>                constrained_target_centerline = centerlines[1];</div>
<div class="line"><a id="l00445" name="l00445"></a><span class="lineno">  445</span> </div>
<div class="line"><a id="l00446" name="l00446"></a><span class="lineno">  446</span>            }</div>
<div class="line"><a id="l00447" name="l00447"></a><span class="lineno">  447</span> </div>
<div class="line"><a id="l00448" name="l00448"></a><span class="lineno">  448</span>            <span class="comment">//Create Trajectory geometry</span></div>
<div class="line"><a id="l00449" name="l00449"></a><span class="lineno">  449</span>            <span class="keywordtype">double</span> delta_step = 1.0 / constrained_start_centerline.size();</div>
<div class="line"><a id="l00450" name="l00450"></a><span class="lineno">  450</span> </div>
<div class="line"><a id="l00451" name="l00451"></a><span class="lineno">  451</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; constrained_start_centerline.size(); ++<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>)</div>
<div class="line"><a id="l00452" name="l00452"></a><span class="lineno">  452</span>            {</div>
<div class="line"><a id="l00453" name="l00453"></a><span class="lineno">  453</span>                lanelet::BasicPoint2d current_position;</div>
<div class="line"><a id="l00454" name="l00454"></a><span class="lineno">  454</span>                lanelet::BasicPoint2d start_lane_pt = constrained_start_centerline[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00455" name="l00455"></a><span class="lineno">  455</span>                lanelet::BasicPoint2d target_lane_pt = constrained_target_centerline[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00456" name="l00456"></a><span class="lineno">  456</span>                <span class="keywordtype">double</span> delta = delta_step * <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>;</div>
<div class="line"><a id="l00457" name="l00457"></a><span class="lineno">  457</span>                current_position.x() = target_lane_pt.x() * delta + (1 - delta) * start_lane_pt.x();</div>
<div class="line"><a id="l00458" name="l00458"></a><span class="lineno">  458</span>                current_position.y() = target_lane_pt.y() * delta + (1 - delta) * start_lane_pt.y();</div>
<div class="line"><a id="l00459" name="l00459"></a><span class="lineno">  459</span> </div>
<div class="line"><a id="l00460" name="l00460"></a><span class="lineno">  460</span>                centerline_points.push_back(current_position);</div>
<div class="line"><a id="l00461" name="l00461"></a><span class="lineno">  461</span>            }</div>
<div class="line"><a id="l00462" name="l00462"></a><span class="lineno">  462</span> </div>
<div class="line"><a id="l00463" name="l00463"></a><span class="lineno">  463</span>            <span class="comment">// Add points from the remaining length of the target lanelet to provide sufficient distance for adding buffer</span></div>
<div class="line"><a id="l00464" name="l00464"></a><span class="lineno">  464</span>            <span class="keywordtype">double</span> dist_to_target_lane_end = lanelet::geometry::distance2d(centerline_points.back(), downsampled_target_centerline.back());</div>
<div class="line"><a id="l00465" name="l00465"></a><span class="lineno">  465</span>            centerline_points.insert(centerline_points.end(), downsampled_target_centerline.begin() + end_index_target_centerline, downsampled_target_centerline.end());</div>
<div class="line"><a id="l00466" name="l00466"></a><span class="lineno">  466</span> </div>
<div class="line"><a id="l00467" name="l00467"></a><span class="lineno">  467</span>            <span class="comment">// If the additional distance from the remaining length of the target lanelet does not provide more than the required</span></div>
<div class="line"><a id="l00468" name="l00468"></a><span class="lineno">  468</span>            <span class="comment">// buffer_ending_downtrack, then also add points from the lanelet following the target lanelet</span></div>
<div class="line"><a id="l00469" name="l00469"></a><span class="lineno">  469</span>            <span class="keywordflow">if</span> (dist_to_target_lane_end &lt; buffer_ending_downtrack) {</div>
<div class="line"><a id="l00470" name="l00470"></a><span class="lineno">  470</span>                <span class="keyword">auto</span> following_lanelets = wm-&gt;getMapRoutingGraph()-&gt;following(ending_lanelet, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00471" name="l00471"></a><span class="lineno">  471</span>                <span class="keywordflow">if</span>(!following_lanelets.empty()){</div>
<div class="line"><a id="l00472" name="l00472"></a><span class="lineno">  472</span>                    <span class="comment">//Arbitrarily choosing first following lanelet for buffer since points are only being used to fit spline</span></div>
<div class="line"><a id="l00473" name="l00473"></a><span class="lineno">  473</span>                    <span class="keyword">auto</span> following_lanelet_centerline = following_lanelets.front().centerline2d().basicLineString();</div>
<div class="line"><a id="l00474" name="l00474"></a><span class="lineno">  474</span>                    centerline_points.insert(centerline_points.end(), following_lanelet_centerline.begin(),</div>
<div class="line"><a id="l00475" name="l00475"></a><span class="lineno">  475</span>                                                                                following_lanelet_centerline.end());</div>
<div class="line"><a id="l00476" name="l00476"></a><span class="lineno">  476</span>                }</div>
<div class="line"><a id="l00477" name="l00477"></a><span class="lineno">  477</span>            }</div>
<div class="line"><a id="l00478" name="l00478"></a><span class="lineno">  478</span> </div>
<div class="line"><a id="l00479" name="l00479"></a><span class="lineno">  479</span>            <span class="keywordflow">return</span> centerline_points;</div>
<div class="line"><a id="l00480" name="l00480"></a><span class="lineno">  480</span>        }</div>
<div class="line"><a id="l00481" name="l00481"></a><span class="lineno">  481</span> </div>
<div class="line"><a id="l00482" name="l00482"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a19cf5cf882789e1e9ed3e92d0105a8de">  482</a></span>       std::vector&lt;std::vector&lt;lanelet::BasicPoint2d&gt;&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a19cf5cf882789e1e9ed3e92d0105a8de">resample_linestring_pair_to_same_size</a>(std::vector&lt;lanelet::BasicPoint2d&gt;&amp; line_1, std::vector&lt;lanelet::BasicPoint2d&gt;&amp; line_2){</div>
<div class="line"><a id="l00483" name="l00483"></a><span class="lineno">  483</span> </div>
<div class="line"><a id="l00484" name="l00484"></a><span class="lineno">  484</span>            <span class="keyword">auto</span> start_time = std::chrono::high_resolution_clock::now(); <span class="comment">// Start timing the execution time for planning so it can be logged</span></div>
<div class="line"><a id="l00485" name="l00485"></a><span class="lineno">  485</span> </div>
<div class="line"><a id="l00486" name="l00486"></a><span class="lineno">  486</span>            std::vector&lt;std::vector&lt;lanelet::BasicPoint2d&gt;&gt; output;</div>
<div class="line"><a id="l00487" name="l00487"></a><span class="lineno">  487</span> </div>
<div class="line"><a id="l00488" name="l00488"></a><span class="lineno">  488</span>            <span class="comment">//Fit centerlines to a spline</span></div>
<div class="line"><a id="l00489" name="l00489"></a><span class="lineno">  489</span>            std::unique_ptr&lt;smoothing::SplineI&gt; fit_curve_1 = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">compute_fit</a>(line_1); <span class="comment">// Compute splines based on curve points</span></div>
<div class="line"><a id="l00490" name="l00490"></a><span class="lineno">  490</span>            <span class="keywordflow">if</span> (!fit_curve_1)</div>
<div class="line"><a id="l00491" name="l00491"></a><span class="lineno">  491</span>            {</div>
<div class="line"><a id="l00492" name="l00492"></a><span class="lineno">  492</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Could not fit a spline curve along the starting_lane centerline points!&quot;</span>);</div>
<div class="line"><a id="l00493" name="l00493"></a><span class="lineno">  493</span>            }</div>
<div class="line"><a id="l00494" name="l00494"></a><span class="lineno">  494</span> </div>
<div class="line"><a id="l00495" name="l00495"></a><span class="lineno">  495</span>            std::unique_ptr&lt;smoothing::SplineI&gt; fit_curve_2 = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">compute_fit</a>(line_2); <span class="comment">// Compute splines based on curve points</span></div>
<div class="line"><a id="l00496" name="l00496"></a><span class="lineno">  496</span>            <span class="keywordflow">if</span> (!fit_curve_2)</div>
<div class="line"><a id="l00497" name="l00497"></a><span class="lineno">  497</span>            {</div>
<div class="line"><a id="l00498" name="l00498"></a><span class="lineno">  498</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Could not fit a spline curve along the ending_lane centerline points!&quot;</span>);</div>
<div class="line"><a id="l00499" name="l00499"></a><span class="lineno">  499</span>            }</div>
<div class="line"><a id="l00500" name="l00500"></a><span class="lineno">  500</span> </div>
<div class="line"><a id="l00501" name="l00501"></a><span class="lineno">  501</span>            <span class="comment">//Sample spline to get centerlines of equal size</span></div>
<div class="line"><a id="l00502" name="l00502"></a><span class="lineno">  502</span>            std::vector&lt;lanelet::BasicPoint2d&gt; all_sampling_points_line1;</div>
<div class="line"><a id="l00503" name="l00503"></a><span class="lineno">  503</span>            std::vector&lt;lanelet::BasicPoint2d&gt; all_sampling_points_line2;</div>
<div class="line"><a id="l00504" name="l00504"></a><span class="lineno">  504</span> </div>
<div class="line"><a id="l00505" name="l00505"></a><span class="lineno">  505</span>            <span class="keywordtype">size_t</span> total_point_size = std::min(line_1.size(), line_2.size());</div>
<div class="line"><a id="l00506" name="l00506"></a><span class="lineno">  506</span> </div>
<div class="line"><a id="l00507" name="l00507"></a><span class="lineno">  507</span>            all_sampling_points_line1.reserve(1 + total_point_size * 2);</div>
<div class="line"><a id="l00508" name="l00508"></a><span class="lineno">  508</span>            std::vector&lt;double&gt; downtracks_raw_line1 = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(line_1);</div>
<div class="line"><a id="l00509" name="l00509"></a><span class="lineno">  509</span>            <span class="comment">//int total_step_along_curve1 = static_cast&lt;int&gt;(downtracks_raw_line1.back() / 2.0);</span></div>
<div class="line"><a id="l00510" name="l00510"></a><span class="lineno">  510</span>            <span class="comment">//double step_threshold_line1 = (double)total_step_along_curve1 / (double)total_point_size;</span></div>
<div class="line"><a id="l00511" name="l00511"></a><span class="lineno">  511</span>            <span class="comment">//TODO: are we missing some computation here?  step_threshold_line1 and step_threshold_line2 are not used anywhere</span></div>
<div class="line"><a id="l00512" name="l00512"></a><span class="lineno">  512</span>            <span class="comment">//      and these calcs can be deleted (see below also).</span></div>
<div class="line"><a id="l00513" name="l00513"></a><span class="lineno">  513</span> </div>
<div class="line"><a id="l00514" name="l00514"></a><span class="lineno">  514</span>            all_sampling_points_line2.reserve(1 + total_point_size * 2);</div>
<div class="line"><a id="l00515" name="l00515"></a><span class="lineno">  515</span>            std::vector&lt;double&gt; downtracks_raw_line2 = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(line_2);</div>
<div class="line"><a id="l00516" name="l00516"></a><span class="lineno">  516</span>            <span class="comment">//TODO: unused variable: int total_step_along_curve2 = static_cast&lt;int&gt;(downtracks_raw_line2.back() / 2.0);</span></div>
<div class="line"><a id="l00517" name="l00517"></a><span class="lineno">  517</span>            <span class="comment">//TODO: unused variable: double step_threshold_line2 = (double)total_step_along_curve2 / (double)total_point_size;</span></div>
<div class="line"><a id="l00518" name="l00518"></a><span class="lineno">  518</span> </div>
<div class="line"><a id="l00519" name="l00519"></a><span class="lineno">  519</span>            <span class="keywordtype">double</span> scaled_steps_along_curve = 0.0; <span class="comment">// from 0 (start) to 1 (end) for the whole trajectory</span></div>
<div class="line"><a id="l00520" name="l00520"></a><span class="lineno">  520</span> </div>
<div class="line"><a id="l00521" name="l00521"></a><span class="lineno">  521</span> </div>
<div class="line"><a id="l00522" name="l00522"></a><span class="lineno">  522</span>            all_sampling_points_line2.reserve(1 + total_point_size * 2);</div>
<div class="line"><a id="l00523" name="l00523"></a><span class="lineno">  523</span> </div>
<div class="line"><a id="l00524" name="l00524"></a><span class="lineno">  524</span>            <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0;<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>&lt;total_point_size; ++<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>){</div>
<div class="line"><a id="l00525" name="l00525"></a><span class="lineno">  525</span>                lanelet::BasicPoint2d p1 = (*fit_curve_1)(scaled_steps_along_curve);</div>
<div class="line"><a id="l00526" name="l00526"></a><span class="lineno">  526</span>                lanelet::BasicPoint2d p2 = (*fit_curve_2)(scaled_steps_along_curve);</div>
<div class="line"><a id="l00527" name="l00527"></a><span class="lineno">  527</span>                all_sampling_points_line1.push_back(p1);</div>
<div class="line"><a id="l00528" name="l00528"></a><span class="lineno">  528</span>                all_sampling_points_line2.push_back(p2);</div>
<div class="line"><a id="l00529" name="l00529"></a><span class="lineno">  529</span> </div>
<div class="line"><a id="l00530" name="l00530"></a><span class="lineno">  530</span>                scaled_steps_along_curve += 1.0 / total_point_size;  <span class="comment">//adding steps_along_curve_step_size</span></div>
<div class="line"><a id="l00531" name="l00531"></a><span class="lineno">  531</span>            }</div>
<div class="line"><a id="l00532" name="l00532"></a><span class="lineno">  532</span> </div>
<div class="line"><a id="l00533" name="l00533"></a><span class="lineno">  533</span>            output.push_back(all_sampling_points_line1);</div>
<div class="line"><a id="l00534" name="l00534"></a><span class="lineno">  534</span>            output.push_back(all_sampling_points_line2);</div>
<div class="line"><a id="l00535" name="l00535"></a><span class="lineno">  535</span> </div>
<div class="line"><a id="l00536" name="l00536"></a><span class="lineno">  536</span>            <span class="keyword">auto</span> end_time = std::chrono::high_resolution_clock::now();</div>
<div class="line"><a id="l00537" name="l00537"></a><span class="lineno">  537</span> </div>
<div class="line"><a id="l00538" name="l00538"></a><span class="lineno">  538</span>            <span class="keyword">auto</span> duration = std::chrono::duration_cast&lt;std::chrono::milliseconds&gt;(end_time - start_time);</div>
<div class="line"><a id="l00539" name="l00539"></a><span class="lineno">  539</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;ExecutionTime for resample lane change centerlines: &quot;</span> &lt;&lt; duration.count() &lt;&lt; <span class="stringliteral">&quot; milliseconds&quot;</span>);</div>
<div class="line"><a id="l00540" name="l00540"></a><span class="lineno">  540</span> </div>
<div class="line"><a id="l00541" name="l00541"></a><span class="lineno">  541</span>            <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l00542" name="l00542"></a><span class="lineno">  542</span>        }</div>
<div class="line"><a id="l00543" name="l00543"></a><span class="lineno">  543</span> </div>
<div class="line"><a id="l00544" name="l00544"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#af992a6cbbdafd6e86d73976a65164e94">  544</a></span>        std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af992a6cbbdafd6e86d73976a65164e94">get_lanechange_points_from_maneuver</a>(<span class="keyword">const</span> carma_planning_msgs::msg::Maneuver &amp;maneuver, <span class="keywordtype">double</span> starting_downtrack,</div>
<div class="line"><a id="l00545" name="l00545"></a><span class="lineno">  545</span>                                                                   <span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm, carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer,</div>
<div class="line"><a id="l00546" name="l00546"></a><span class="lineno">  546</span>                                                                    <span class="keyword">const</span> carma_planning_msgs::msg::VehicleState &amp;state, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">GeneralTrajConfig</a> &amp;general_config,<span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config)</div>
<div class="line"><a id="l00547" name="l00547"></a><span class="lineno">  547</span>        {</div>
<div class="line"><a id="l00548" name="l00548"></a><span class="lineno">  548</span>            <span class="keywordflow">if</span>(maneuver.type != carma_planning_msgs::msg::Maneuver::LANE_CHANGE){</div>
<div class="line"><a id="l00549" name="l00549"></a><span class="lineno">  549</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Create_lanechange called on a maneuver type which is not LANE_CHANGE&quot;</span>);</div>
<div class="line"><a id="l00550" name="l00550"></a><span class="lineno">  550</span>            }</div>
<div class="line"><a id="l00551" name="l00551"></a><span class="lineno">  551</span>            std::vector&lt;PointSpeedPair&gt; points_and_target_speeds;</div>
<div class="line"><a id="l00552" name="l00552"></a><span class="lineno">  552</span>            std::unordered_set&lt;lanelet::Id&gt; visited_lanelets;</div>
<div class="line"><a id="l00553" name="l00553"></a><span class="lineno">  553</span> </div>
<div class="line"><a id="l00554" name="l00554"></a><span class="lineno">  554</span>            carma_planning_msgs::msg::LaneChangeManeuver lane_change_maneuver = maneuver.lane_change_maneuver;</div>
<div class="line"><a id="l00555" name="l00555"></a><span class="lineno">  555</span>            <span class="keywordtype">double</span> ending_downtrack = lane_change_maneuver.end_dist;</div>
<div class="line"><a id="l00556" name="l00556"></a><span class="lineno">  556</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Maneuver ending downtrack:&quot;</span>&lt;&lt;ending_downtrack);</div>
<div class="line"><a id="l00557" name="l00557"></a><span class="lineno">  557</span>            <span class="keywordflow">if</span>(starting_downtrack &gt;= ending_downtrack)</div>
<div class="line"><a id="l00558" name="l00558"></a><span class="lineno">  558</span>            {</div>
<div class="line"><a id="l00559" name="l00559"></a><span class="lineno">  559</span>                <span class="keywordflow">throw</span>(std::invalid_argument(<span class="stringliteral">&quot;Start distance is greater than or equal to ending distance&quot;</span>));</div>
<div class="line"><a id="l00560" name="l00560"></a><span class="lineno">  560</span>            }</div>
<div class="line"><a id="l00561" name="l00561"></a><span class="lineno">  561</span> </div>
<div class="line"><a id="l00562" name="l00562"></a><span class="lineno">  562</span>            <span class="comment">//get route between starting and ending downtracks - downtracks should be constant for complete length of maneuver</span></div>
<div class="line"><a id="l00563" name="l00563"></a><span class="lineno">  563</span>            std::vector&lt;lanelet::BasicPoint2d&gt; route_geometry = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a2219ab96db87781023137bdb45af1ea2">create_lanechange_geometry</a>(std::stoi(lane_change_maneuver.starting_lane_id),std::stoi(lane_change_maneuver.ending_lane_id),</div>
<div class="line"><a id="l00564" name="l00564"></a><span class="lineno">  564</span>                                                                                        starting_downtrack, ending_downtrack, wm, general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a0ad2d91d1f739942213d5bfe7f0e861f">default_downsample_ratio</a>, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a>);</div>
<div class="line"><a id="l00565" name="l00565"></a><span class="lineno">  565</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Route geometry size:&quot;</span>&lt;&lt;route_geometry.size());</div>
<div class="line"><a id="l00566" name="l00566"></a><span class="lineno">  566</span> </div>
<div class="line"><a id="l00567" name="l00567"></a><span class="lineno">  567</span>            lanelet::BasicPoint2d state_pos(state.x_pos_global, state.y_pos_global);</div>
<div class="line"><a id="l00568" name="l00568"></a><span class="lineno">  568</span>            <span class="keywordtype">double</span> current_downtrack = wm-&gt;routeTrackPos(state_pos).downtrack;</div>
<div class="line"><a id="l00569" name="l00569"></a><span class="lineno">  569</span>            <span class="keywordtype">int</span> nearest_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(route_geometry, wm, current_downtrack);</div>
<div class="line"><a id="l00570" name="l00570"></a><span class="lineno">  570</span>            <span class="keywordtype">int</span> ending_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(route_geometry, wm, ending_downtrack);</div>
<div class="line"><a id="l00571" name="l00571"></a><span class="lineno">  571</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Nearest pt index in maneuvers to points: &quot;</span>&lt;&lt; nearest_pt_index);</div>
<div class="line"><a id="l00572" name="l00572"></a><span class="lineno">  572</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Ending pt index in maneuvers to points: &quot;</span>&lt;&lt; ending_pt_index);</div>
<div class="line"><a id="l00573" name="l00573"></a><span class="lineno">  573</span> </div>
<div class="line"><a id="l00574" name="l00574"></a><span class="lineno">  574</span>            ending_state_before_buffer.x_pos_global = route_geometry[ending_pt_index].x();</div>
<div class="line"><a id="l00575" name="l00575"></a><span class="lineno">  575</span>            ending_state_before_buffer.y_pos_global = route_geometry[ending_pt_index].y();</div>
<div class="line"><a id="l00576" name="l00576"></a><span class="lineno">  576</span> </div>
<div class="line"><a id="l00577" name="l00577"></a><span class="lineno">  577</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;ending_state_before_buffer_:&quot;</span>&lt;&lt;ending_state_before_buffer.x_pos_global &lt;&lt;</div>
<div class="line"><a id="l00578" name="l00578"></a><span class="lineno">  578</span>                    <span class="stringliteral">&quot;, ending_state_before_buffer_.y_pos_global&quot;</span> &lt;&lt; ending_state_before_buffer.y_pos_global);</div>
<div class="line"><a id="l00579" name="l00579"></a><span class="lineno">  579</span> </div>
<div class="line"><a id="l00580" name="l00580"></a><span class="lineno">  580</span> </div>
<div class="line"><a id="l00581" name="l00581"></a><span class="lineno">  581</span>            <span class="keywordtype">double</span> route_length = wm-&gt;getRouteEndTrackPos().downtrack;</div>
<div class="line"><a id="l00582" name="l00582"></a><span class="lineno">  582</span> </div>
<div class="line"><a id="l00583" name="l00583"></a><span class="lineno">  583</span>            <span class="keywordflow">if</span> (ending_downtrack + detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a> &lt; route_length)</div>
<div class="line"><a id="l00584" name="l00584"></a><span class="lineno">  584</span>            {</div>
<div class="line"><a id="l00585" name="l00585"></a><span class="lineno">  585</span>                ending_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(route_geometry, wm, ending_downtrack + detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a>);</div>
<div class="line"><a id="l00586" name="l00586"></a><span class="lineno">  586</span>            }</div>
<div class="line"><a id="l00587" name="l00587"></a><span class="lineno">  587</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00588" name="l00588"></a><span class="lineno">  588</span>            {</div>
<div class="line"><a id="l00589" name="l00589"></a><span class="lineno">  589</span>                ending_pt_index = route_geometry.size() - 1;</div>
<div class="line"><a id="l00590" name="l00590"></a><span class="lineno">  590</span>            }</div>
<div class="line"><a id="l00591" name="l00591"></a><span class="lineno">  591</span> </div>
<div class="line"><a id="l00592" name="l00592"></a><span class="lineno">  592</span>            lanelet::BasicLineString2d future_route_geometry(route_geometry.begin() + nearest_pt_index, route_geometry.begin() + ending_pt_index);</div>
<div class="line"><a id="l00593" name="l00593"></a><span class="lineno">  593</span>            <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00594" name="l00594"></a><span class="lineno">  594</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Future geom size:&quot;</span>&lt;&lt; future_route_geometry.size());</div>
<div class="line"><a id="l00595" name="l00595"></a><span class="lineno">  595</span> </div>
<div class="line"><a id="l00596" name="l00596"></a><span class="lineno">  596</span>            <span class="keywordflow">for</span> (<span class="keyword">auto</span> p : future_route_geometry)</div>
<div class="line"><a id="l00597" name="l00597"></a><span class="lineno">  597</span>            {</div>
<div class="line"><a id="l00598" name="l00598"></a><span class="lineno">  598</span>                <span class="keywordflow">if</span> (first &amp;&amp; !points_and_target_speeds.empty())</div>
<div class="line"><a id="l00599" name="l00599"></a><span class="lineno">  599</span>                {</div>
<div class="line"><a id="l00600" name="l00600"></a><span class="lineno">  600</span>                    first = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00601" name="l00601"></a><span class="lineno">  601</span>                    <span class="keywordflow">continue</span>; <span class="comment">// Skip the first point if we have already added points from a previous maneuver to avoid duplicates</span></div>
<div class="line"><a id="l00602" name="l00602"></a><span class="lineno">  602</span>                }</div>
<div class="line"><a id="l00603" name="l00603"></a><span class="lineno">  603</span>                <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html">PointSpeedPair</a> pair;</div>
<div class="line"><a id="l00604" name="l00604"></a><span class="lineno">  604</span>                pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#a628d9d3853745335b42ad940136d88ac">point</a> = p;</div>
<div class="line"><a id="l00605" name="l00605"></a><span class="lineno">  605</span>                <span class="comment">//If current speed is above min speed, keep at current speed. Otherwise use end speed from maneuver.</span></div>
<div class="line"><a id="l00606" name="l00606"></a><span class="lineno">  606</span>                pair.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#aafb815247d0179093dcd47c9e9be3428">speed</a> = (state.longitudinal_vel &gt; detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4bf547260f4eb35b2df2a8ddb5b216c8">minimum_speed</a>) ? state.longitudinal_vel : lane_change_maneuver.end_speed;</div>
<div class="line"><a id="l00607" name="l00607"></a><span class="lineno">  607</span>                points_and_target_speeds.push_back(pair);</div>
<div class="line"><a id="l00608" name="l00608"></a><span class="lineno">  608</span> </div>
<div class="line"><a id="l00609" name="l00609"></a><span class="lineno">  609</span>            }</div>
<div class="line"><a id="l00610" name="l00610"></a><span class="lineno">  610</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Const speed assigned:&quot;</span>&lt;&lt;points_and_target_speeds.back().speed);</div>
<div class="line"><a id="l00611" name="l00611"></a><span class="lineno">  611</span>            <span class="keywordflow">return</span> points_and_target_speeds;</div>
<div class="line"><a id="l00612" name="l00612"></a><span class="lineno">  612</span> </div>
<div class="line"><a id="l00613" name="l00613"></a><span class="lineno">  613</span> </div>
<div class="line"><a id="l00614" name="l00614"></a><span class="lineno">  614</span>        }</div>
<div class="line"><a id="l00615" name="l00615"></a><span class="lineno">  615</span> </div>
<div class="line"><a id="l00616" name="l00616"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#ab4974a3dfe697ccc0dd1344a8e11c5e1">  616</a></span>        std::vector&lt;double&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ab4974a3dfe697ccc0dd1344a8e11c5e1">apply_speed_limits</a>(<span class="keyword">const</span> std::vector&lt;double&gt; speeds,</div>
<div class="line"><a id="l00617" name="l00617"></a><span class="lineno">  617</span>                                               <span class="keyword">const</span> std::vector&lt;double&gt; speed_limits)</div>
<div class="line"><a id="l00618" name="l00618"></a><span class="lineno">  618</span>        {</div>
<div class="line"><a id="l00619" name="l00619"></a><span class="lineno">  619</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Speeds list size: &quot;</span> &lt;&lt; speeds.size());</div>
<div class="line"><a id="l00620" name="l00620"></a><span class="lineno">  620</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;SpeedLimits list size: &quot;</span> &lt;&lt; speed_limits.size());</div>
<div class="line"><a id="l00621" name="l00621"></a><span class="lineno">  621</span> </div>
<div class="line"><a id="l00622" name="l00622"></a><span class="lineno">  622</span>            <span class="keywordflow">if</span> (speeds.size() != speed_limits.size())</div>
<div class="line"><a id="l00623" name="l00623"></a><span class="lineno">  623</span>            {</div>
<div class="line"><a id="l00624" name="l00624"></a><span class="lineno">  624</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Speeds and speed limit lists not same size&quot;</span>);</div>
<div class="line"><a id="l00625" name="l00625"></a><span class="lineno">  625</span>            }</div>
<div class="line"><a id="l00626" name="l00626"></a><span class="lineno">  626</span>            std::vector&lt;double&gt; out;</div>
<div class="line"><a id="l00627" name="l00627"></a><span class="lineno">  627</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; speeds.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l00628" name="l00628"></a><span class="lineno">  628</span>            {</div>
<div class="line"><a id="l00629" name="l00629"></a><span class="lineno">  629</span>                out.push_back(std::min(speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>], speed_limits[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]));</div>
<div class="line"><a id="l00630" name="l00630"></a><span class="lineno">  630</span>            }</div>
<div class="line"><a id="l00631" name="l00631"></a><span class="lineno">  631</span> </div>
<div class="line"><a id="l00632" name="l00632"></a><span class="lineno">  632</span>            <span class="keywordflow">return</span> out;</div>
<div class="line"><a id="l00633" name="l00633"></a><span class="lineno">  633</span>        }</div>
<div class="line"><a id="l00634" name="l00634"></a><span class="lineno">  634</span> </div>
<div class="line"><a id="l00635" name="l00635"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#ada2ee63b890bfa23d67a17cf61dd0129">  635</a></span>        Eigen::Isometry2d <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ada2ee63b890bfa23d67a17cf61dd0129">compute_heading_frame</a>(<span class="keyword">const</span> lanelet::BasicPoint2d &amp;p1,</div>
<div class="line"><a id="l00636" name="l00636"></a><span class="lineno">  636</span>                                                <span class="keyword">const</span> lanelet::BasicPoint2d &amp;p2)</div>
<div class="line"><a id="l00637" name="l00637"></a><span class="lineno">  637</span>        {</div>
<div class="line"><a id="l00638" name="l00638"></a><span class="lineno">  638</span>            Eigen::Rotation2Dd yaw(atan2(p2.y() - p1.y(), p2.x() - p1.x()));</div>
<div class="line"><a id="l00639" name="l00639"></a><span class="lineno">  639</span> </div>
<div class="line"><a id="l00640" name="l00640"></a><span class="lineno">  640</span>            <span class="keywordflow">return</span> <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#ab51c08f5f937a6aa72b7490eeabed211">carma_wm::geometry::build2dEigenTransform</a>(p1, yaw);</div>
<div class="line"><a id="l00641" name="l00641"></a><span class="lineno">  641</span>        }</div>
<div class="line"><a id="l00642" name="l00642"></a><span class="lineno">  642</span> </div>
<div class="line"><a id="l00643" name="l00643"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#af509efce135492493e13c9bb86329dcd">  643</a></span>        std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af509efce135492493e13c9bb86329dcd">constrain_to_time_boundary</a>(<span class="keyword">const</span> std::vector&lt;PointSpeedPair&gt; &amp;points,</div>
<div class="line"><a id="l00644" name="l00644"></a><span class="lineno">  644</span>                                                               <span class="keywordtype">double</span> time_span)</div>
<div class="line"><a id="l00645" name="l00645"></a><span class="lineno">  645</span>        {</div>
<div class="line"><a id="l00646" name="l00646"></a><span class="lineno">  646</span>            std::vector&lt;lanelet::BasicPoint2d&gt; basic_points;</div>
<div class="line"><a id="l00647" name="l00647"></a><span class="lineno">  647</span>            std::vector&lt;double&gt; speeds;</div>
<div class="line"><a id="l00648" name="l00648"></a><span class="lineno">  648</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a0f07faaac8c54cc485f2bb217097326e">split_point_speed_pairs</a>(points, &amp;basic_points, &amp;speeds);</div>
<div class="line"><a id="l00649" name="l00649"></a><span class="lineno">  649</span> </div>
<div class="line"><a id="l00650" name="l00650"></a><span class="lineno">  650</span>            std::vector&lt;double&gt; downtracks = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(basic_points);</div>
<div class="line"><a id="l00651" name="l00651"></a><span class="lineno">  651</span> </div>
<div class="line"><a id="l00652" name="l00652"></a><span class="lineno">  652</span>            <span class="keywordtype">size_t</span> time_boundary_exclusive_index =</div>
<div class="line"><a id="l00653" name="l00653"></a><span class="lineno">  653</span>                trajectory_utils::time_boundary_index(downtracks, speeds, time_span);</div>
<div class="line"><a id="l00654" name="l00654"></a><span class="lineno">  654</span> </div>
<div class="line"><a id="l00655" name="l00655"></a><span class="lineno">  655</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;time_boundary_exclusive_index = &quot;</span> &lt;&lt; time_boundary_exclusive_index);</div>
<div class="line"><a id="l00656" name="l00656"></a><span class="lineno">  656</span> </div>
<div class="line"><a id="l00657" name="l00657"></a><span class="lineno">  657</span>            <span class="keywordflow">if</span> (time_boundary_exclusive_index == 0)</div>
<div class="line"><a id="l00658" name="l00658"></a><span class="lineno">  658</span>            {</div>
<div class="line"><a id="l00659" name="l00659"></a><span class="lineno">  659</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;No points to fit in timespan&quot;</span>);</div>
<div class="line"><a id="l00660" name="l00660"></a><span class="lineno">  660</span>            }</div>
<div class="line"><a id="l00661" name="l00661"></a><span class="lineno">  661</span> </div>
<div class="line"><a id="l00662" name="l00662"></a><span class="lineno">  662</span>            std::vector&lt;PointSpeedPair&gt; time_bound_points;</div>
<div class="line"><a id="l00663" name="l00663"></a><span class="lineno">  663</span>            time_bound_points.reserve(time_boundary_exclusive_index);</div>
<div class="line"><a id="l00664" name="l00664"></a><span class="lineno">  664</span> </div>
<div class="line"><a id="l00665" name="l00665"></a><span class="lineno">  665</span>            <span class="keywordflow">if</span> (time_boundary_exclusive_index == points.size())</div>
<div class="line"><a id="l00666" name="l00666"></a><span class="lineno">  666</span>            {</div>
<div class="line"><a id="l00667" name="l00667"></a><span class="lineno">  667</span>                time_bound_points.insert(time_bound_points.end(), points.begin(),</div>
<div class="line"><a id="l00668" name="l00668"></a><span class="lineno">  668</span>                                         points.end()); <span class="comment">// All points fit within time boundary</span></div>
<div class="line"><a id="l00669" name="l00669"></a><span class="lineno">  669</span>            }</div>
<div class="line"><a id="l00670" name="l00670"></a><span class="lineno">  670</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l00671" name="l00671"></a><span class="lineno">  671</span>            {</div>
<div class="line"><a id="l00672" name="l00672"></a><span class="lineno">  672</span>                time_bound_points.insert(time_bound_points.end(), points.begin(),</div>
<div class="line"><a id="l00673" name="l00673"></a><span class="lineno">  673</span>                                         points.begin() + time_boundary_exclusive_index - 1); <span class="comment">// Limit points by time boundary</span></div>
<div class="line"><a id="l00674" name="l00674"></a><span class="lineno">  674</span>            }</div>
<div class="line"><a id="l00675" name="l00675"></a><span class="lineno">  675</span> </div>
<div class="line"><a id="l00676" name="l00676"></a><span class="lineno">  676</span>            <span class="keywordflow">return</span> time_bound_points;</div>
<div class="line"><a id="l00677" name="l00677"></a><span class="lineno">  677</span>        }</div>
<div class="line"><a id="l00678" name="l00678"></a><span class="lineno">  678</span> </div>
<div class="line"><a id="l00679" name="l00679"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9dd6a1f0fa9c6f6590b83a7cc2e0d118">  679</a></span>        std::pair&lt;double, size_t&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9dd6a1f0fa9c6f6590b83a7cc2e0d118">min_with_exclusions</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp;values, <span class="keyword">const</span> std::unordered_set&lt;size_t&gt; &amp;excluded)</div>
<div class="line"><a id="l00680" name="l00680"></a><span class="lineno">  680</span>        {</div>
<div class="line"><a id="l00681" name="l00681"></a><span class="lineno">  681</span>            <span class="keywordtype">double</span> min = std::numeric_limits&lt;double&gt;::max();</div>
<div class="line"><a id="l00682" name="l00682"></a><span class="lineno">  682</span>            <span class="keywordtype">size_t</span> best_idx = -1;</div>
<div class="line"><a id="l00683" name="l00683"></a><span class="lineno">  683</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; values.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l00684" name="l00684"></a><span class="lineno">  684</span>            {</div>
<div class="line"><a id="l00685" name="l00685"></a><span class="lineno">  685</span>                <span class="keywordflow">if</span> (excluded.find(<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>) != excluded.end())</div>
<div class="line"><a id="l00686" name="l00686"></a><span class="lineno">  686</span>                {</div>
<div class="line"><a id="l00687" name="l00687"></a><span class="lineno">  687</span>                    <span class="keywordflow">continue</span>;</div>
<div class="line"><a id="l00688" name="l00688"></a><span class="lineno">  688</span>                }</div>
<div class="line"><a id="l00689" name="l00689"></a><span class="lineno">  689</span> </div>
<div class="line"><a id="l00690" name="l00690"></a><span class="lineno">  690</span>                <span class="keywordflow">if</span> (values[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] &lt; min)</div>
<div class="line"><a id="l00691" name="l00691"></a><span class="lineno">  691</span>                {</div>
<div class="line"><a id="l00692" name="l00692"></a><span class="lineno">  692</span>                    min = values[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00693" name="l00693"></a><span class="lineno">  693</span>                    best_idx = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>;</div>
<div class="line"><a id="l00694" name="l00694"></a><span class="lineno">  694</span>                }</div>
<div class="line"><a id="l00695" name="l00695"></a><span class="lineno">  695</span>            }</div>
<div class="line"><a id="l00696" name="l00696"></a><span class="lineno">  696</span>            <span class="keywordflow">return</span> std::make_pair(min, best_idx);</div>
<div class="line"><a id="l00697" name="l00697"></a><span class="lineno">  697</span>        }</div>
<div class="line"><a id="l00698" name="l00698"></a><span class="lineno">  698</span> </div>
<div class="line"><a id="l00699" name="l00699"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a84a6c11da2d9736a8f277b6afd124100">  699</a></span>        std::vector&lt;double&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a84a6c11da2d9736a8f277b6afd124100">optimize_speed</a>(<span class="keyword">const</span> std::vector&lt;double&gt; &amp;downtracks, <span class="keyword">const</span> std::vector&lt;double&gt; &amp;curv_speeds, <span class="keywordtype">double</span> accel_limit)</div>
<div class="line"><a id="l00700" name="l00700"></a><span class="lineno">  700</span>        {</div>
<div class="line"><a id="l00701" name="l00701"></a><span class="lineno">  701</span>            <span class="keywordflow">if</span> (downtracks.size() != curv_speeds.size())</div>
<div class="line"><a id="l00702" name="l00702"></a><span class="lineno">  702</span>            {</div>
<div class="line"><a id="l00703" name="l00703"></a><span class="lineno">  703</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Downtracks and speeds do not have the same size&quot;</span>);</div>
<div class="line"><a id="l00704" name="l00704"></a><span class="lineno">  704</span>            }</div>
<div class="line"><a id="l00705" name="l00705"></a><span class="lineno">  705</span> </div>
<div class="line"><a id="l00706" name="l00706"></a><span class="lineno">  706</span>            <span class="keywordflow">if</span> (accel_limit &lt;= 0)</div>
<div class="line"><a id="l00707" name="l00707"></a><span class="lineno">  707</span>            {</div>
<div class="line"><a id="l00708" name="l00708"></a><span class="lineno">  708</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Accel limits should be positive&quot;</span>);</div>
<div class="line"><a id="l00709" name="l00709"></a><span class="lineno">  709</span>            }</div>
<div class="line"><a id="l00710" name="l00710"></a><span class="lineno">  710</span> </div>
<div class="line"><a id="l00711" name="l00711"></a><span class="lineno">  711</span>            <span class="keywordtype">bool</span> optimize = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00712" name="l00712"></a><span class="lineno">  712</span>            std::unordered_set&lt;size_t&gt; visited_idx;</div>
<div class="line"><a id="l00713" name="l00713"></a><span class="lineno">  713</span>            visited_idx.reserve(curv_speeds.size());</div>
<div class="line"><a id="l00714" name="l00714"></a><span class="lineno">  714</span> </div>
<div class="line"><a id="l00715" name="l00715"></a><span class="lineno">  715</span>            std::vector&lt;double&gt; output = curv_speeds;</div>
<div class="line"><a id="l00716" name="l00716"></a><span class="lineno">  716</span> </div>
<div class="line"><a id="l00717" name="l00717"></a><span class="lineno">  717</span>            <span class="keywordflow">while</span> (optimize)</div>
<div class="line"><a id="l00718" name="l00718"></a><span class="lineno">  718</span>            {</div>
<div class="line"><a id="l00719" name="l00719"></a><span class="lineno">  719</span>                <span class="keyword">auto</span> min_pair = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9dd6a1f0fa9c6f6590b83a7cc2e0d118">min_with_exclusions</a>(curv_speeds, visited_idx);</div>
<div class="line"><a id="l00720" name="l00720"></a><span class="lineno">  720</span>                <span class="keywordtype">int</span> min_idx = std::get&lt;1&gt;(min_pair);</div>
<div class="line"><a id="l00721" name="l00721"></a><span class="lineno">  721</span>                <span class="keywordflow">if</span> (min_idx == -1)</div>
<div class="line"><a id="l00722" name="l00722"></a><span class="lineno">  722</span>                {</div>
<div class="line"><a id="l00723" name="l00723"></a><span class="lineno">  723</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00724" name="l00724"></a><span class="lineno">  724</span>                }</div>
<div class="line"><a id="l00725" name="l00725"></a><span class="lineno">  725</span> </div>
<div class="line"><a id="l00726" name="l00726"></a><span class="lineno">  726</span>                visited_idx.insert(min_idx); <span class="comment">// Mark this point as visited</span></div>
<div class="line"><a id="l00727" name="l00727"></a><span class="lineno">  727</span> </div>
<div class="line"><a id="l00728" name="l00728"></a><span class="lineno">  728</span>                <span class="keywordtype">double</span> v_i = std::get&lt;0&gt;(min_pair);</div>
<div class="line"><a id="l00729" name="l00729"></a><span class="lineno">  729</span>                <span class="keywordtype">double</span> x_i = downtracks[min_idx];</div>
<div class="line"><a id="l00730" name="l00730"></a><span class="lineno">  730</span>                <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = min_idx - 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt; 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>--)</div>
<div class="line"><a id="l00731" name="l00731"></a><span class="lineno">  731</span>                {   <span class="comment">// NOTE: Do not use size_t for i type here as -- with &gt; 0 will result in overflow</span></div>
<div class="line"><a id="l00732" name="l00732"></a><span class="lineno">  732</span>                    <span class="comment">//       First point&#39;s speed is left unchanged as it is current speed of the vehicle</span></div>
<div class="line"><a id="l00733" name="l00733"></a><span class="lineno">  733</span>                    <span class="keywordtype">double</span> v_f = curv_speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00734" name="l00734"></a><span class="lineno">  734</span>                    <span class="keywordtype">double</span> dv = v_f - v_i;</div>
<div class="line"><a id="l00735" name="l00735"></a><span class="lineno">  735</span> </div>
<div class="line"><a id="l00736" name="l00736"></a><span class="lineno">  736</span>                    <span class="keywordtype">double</span> x_f = downtracks[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00737" name="l00737"></a><span class="lineno">  737</span>                    <span class="keywordtype">double</span> dx = x_f - x_i;</div>
<div class="line"><a id="l00738" name="l00738"></a><span class="lineno">  738</span> </div>
<div class="line"><a id="l00739" name="l00739"></a><span class="lineno">  739</span>                    <span class="keywordflow">if</span> (dv &gt; 0)</div>
<div class="line"><a id="l00740" name="l00740"></a><span class="lineno">  740</span>                    {</div>
<div class="line"><a id="l00741" name="l00741"></a><span class="lineno">  741</span>                        v_f = std::min(v_f, sqrt(v_i * v_i - 2 * accel_limit * dx)); <span class="comment">// inverting accel as we are only visiting deceleration case</span></div>
<div class="line"><a id="l00742" name="l00742"></a><span class="lineno">  742</span>                        visited_idx.insert(<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><a id="l00743" name="l00743"></a><span class="lineno">  743</span>                    }</div>
<div class="line"><a id="l00744" name="l00744"></a><span class="lineno">  744</span>                    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dv &lt; 0)</div>
<div class="line"><a id="l00745" name="l00745"></a><span class="lineno">  745</span>                    {</div>
<div class="line"><a id="l00746" name="l00746"></a><span class="lineno">  746</span>                        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00747" name="l00747"></a><span class="lineno">  747</span>                    }</div>
<div class="line"><a id="l00748" name="l00748"></a><span class="lineno">  748</span>                    output[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] = v_f;</div>
<div class="line"><a id="l00749" name="l00749"></a><span class="lineno">  749</span>                    v_i = v_f;</div>
<div class="line"><a id="l00750" name="l00750"></a><span class="lineno">  750</span>                    x_i = x_f;</div>
<div class="line"><a id="l00751" name="l00751"></a><span class="lineno">  751</span>                }</div>
<div class="line"><a id="l00752" name="l00752"></a><span class="lineno">  752</span>            }</div>
<div class="line"><a id="l00753" name="l00753"></a><span class="lineno">  753</span> </div>
<div class="line"><a id="l00754" name="l00754"></a><span class="lineno">  754</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;only_reverse[i]: &quot;</span>, output);</div>
<div class="line"><a id="l00755" name="l00755"></a><span class="lineno">  755</span> </div>
<div class="line"><a id="l00756" name="l00756"></a><span class="lineno">  756</span>            output = trajectory_utils::apply_accel_limits_by_distance(downtracks, output, accel_limit, accel_limit);</div>
<div class="line"><a id="l00757" name="l00757"></a><span class="lineno">  757</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;after_forward[i]: &quot;</span>, output);</div>
<div class="line"><a id="l00758" name="l00758"></a><span class="lineno">  758</span> </div>
<div class="line"><a id="l00759" name="l00759"></a><span class="lineno">  759</span>            <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l00760" name="l00760"></a><span class="lineno">  760</span>        }</div>
<div class="line"><a id="l00761" name="l00761"></a><span class="lineno">  761</span> </div>
<div class="line"><a id="l00762" name="l00762"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">  762</a></span>        std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">trajectory_from_points_times_orientations</a>(</div>
<div class="line"><a id="l00763" name="l00763"></a><span class="lineno">  763</span>            <span class="keyword">const</span> std::vector&lt;lanelet::BasicPoint2d&gt; &amp;points, <span class="keyword">const</span> std::vector&lt;double&gt; &amp;times, <span class="keyword">const</span> std::vector&lt;double&gt; &amp;yaws,</div>
<div class="line"><a id="l00764" name="l00764"></a><span class="lineno">  764</span>            rclcpp::Time startTime, <span class="keyword">const</span> std::string &amp;desired_controller_plugin)</div>
<div class="line"><a id="l00765" name="l00765"></a><span class="lineno">  765</span>        {</div>
<div class="line"><a id="l00766" name="l00766"></a><span class="lineno">  766</span>            <span class="keywordflow">if</span> (points.size() != times.size() || points.size() != yaws.size())</div>
<div class="line"><a id="l00767" name="l00767"></a><span class="lineno">  767</span>            {</div>
<div class="line"><a id="l00768" name="l00768"></a><span class="lineno">  768</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;All input vectors must have the same size&quot;</span>);</div>
<div class="line"><a id="l00769" name="l00769"></a><span class="lineno">  769</span>            }</div>
<div class="line"><a id="l00770" name="l00770"></a><span class="lineno">  770</span> </div>
<div class="line"><a id="l00771" name="l00771"></a><span class="lineno">  771</span>            std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; traj;</div>
<div class="line"><a id="l00772" name="l00772"></a><span class="lineno">  772</span>            traj.reserve(points.size());</div>
<div class="line"><a id="l00773" name="l00773"></a><span class="lineno">  773</span> </div>
<div class="line"><a id="l00774" name="l00774"></a><span class="lineno">  774</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; points.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l00775" name="l00775"></a><span class="lineno">  775</span>            {</div>
<div class="line"><a id="l00776" name="l00776"></a><span class="lineno">  776</span>                carma_planning_msgs::msg::TrajectoryPlanPoint tpp;</div>
<div class="line"><a id="l00777" name="l00777"></a><span class="lineno">  777</span>                rclcpp::Duration relative_time(times[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] * 1e9); <span class="comment">// Conversion of times[i] from seconds to nanoseconds</span></div>
<div class="line"><a id="l00778" name="l00778"></a><span class="lineno">  778</span>                tpp.target_time = startTime + relative_time;</div>
<div class="line"><a id="l00779" name="l00779"></a><span class="lineno">  779</span>                tpp.x = points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].x();</div>
<div class="line"><a id="l00780" name="l00780"></a><span class="lineno">  780</span>                tpp.y = points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].y();</div>
<div class="line"><a id="l00781" name="l00781"></a><span class="lineno">  781</span>                tpp.yaw = yaws[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l00782" name="l00782"></a><span class="lineno">  782</span> </div>
<div class="line"><a id="l00783" name="l00783"></a><span class="lineno">  783</span>                tpp.controller_plugin_name = desired_controller_plugin;</div>
<div class="line"><a id="l00784" name="l00784"></a><span class="lineno">  784</span>                <span class="comment">//tpp.planner_plugin_name        //Planner plugin name is filled in the tactical plugin</span></div>
<div class="line"><a id="l00785" name="l00785"></a><span class="lineno">  785</span> </div>
<div class="line"><a id="l00786" name="l00786"></a><span class="lineno">  786</span>                traj.push_back(tpp);</div>
<div class="line"><a id="l00787" name="l00787"></a><span class="lineno">  787</span>            }</div>
<div class="line"><a id="l00788" name="l00788"></a><span class="lineno">  788</span> </div>
<div class="line"><a id="l00789" name="l00789"></a><span class="lineno">  789</span>            <span class="keywordflow">return</span> traj;</div>
<div class="line"><a id="l00790" name="l00790"></a><span class="lineno">  790</span>        }</div>
<div class="line"><a id="l00791" name="l00791"></a><span class="lineno">  791</span> </div>
<div class="line"><a id="l00792" name="l00792"></a><span class="lineno">  792</span> </div>
<div class="line"><a id="l00793" name="l00793"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#af9a705cca66d75f0d2d8ce9e6ea2ee41">  793</a></span>        std::vector&lt;PointSpeedPair&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af9a705cca66d75f0d2d8ce9e6ea2ee41">attach_past_points</a>(<span class="keyword">const</span> std::vector&lt;PointSpeedPair&gt; &amp;points_set, std::vector&lt;PointSpeedPair&gt; future_points,</div>
<div class="line"><a id="l00794" name="l00794"></a><span class="lineno">  794</span>                                                       <span class="keyword">const</span> <span class="keywordtype">int</span> nearest_pt_index,  <span class="keywordtype">double</span> back_distance)</div>
<div class="line"><a id="l00795" name="l00795"></a><span class="lineno">  795</span>        {</div>
<div class="line"><a id="l00796" name="l00796"></a><span class="lineno">  796</span>            std::vector&lt;PointSpeedPair&gt; back_and_future;</div>
<div class="line"><a id="l00797" name="l00797"></a><span class="lineno">  797</span>            back_and_future.reserve(points_set.size());</div>
<div class="line"><a id="l00798" name="l00798"></a><span class="lineno">  798</span>            <span class="keywordtype">double</span> total_dist = 0;</div>
<div class="line"><a id="l00799" name="l00799"></a><span class="lineno">  799</span>            <span class="keywordtype">int</span> min_i = 0;</div>
<div class="line"><a id="l00800" name="l00800"></a><span class="lineno">  800</span> </div>
<div class="line"><a id="l00801" name="l00801"></a><span class="lineno">  801</span>            <span class="comment">// int must be used here to avoid overflow when i = 0</span></div>
<div class="line"><a id="l00802" name="l00802"></a><span class="lineno">  802</span>            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = nearest_pt_index; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt;= 0; --<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>)</div>
<div class="line"><a id="l00803" name="l00803"></a><span class="lineno">  803</span>            {</div>
<div class="line"><a id="l00804" name="l00804"></a><span class="lineno">  804</span>                min_i = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>;</div>
<div class="line"><a id="l00805" name="l00805"></a><span class="lineno">  805</span>                total_dist += lanelet::geometry::distance2d(points_set[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#ab81a05c3d1d100117b6781d7dedf8a29">point</a>, points_set[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> - 1].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#ab81a05c3d1d100117b6781d7dedf8a29">point</a>);</div>
<div class="line"><a id="l00806" name="l00806"></a><span class="lineno">  806</span> </div>
<div class="line"><a id="l00807" name="l00807"></a><span class="lineno">  807</span>                <span class="keywordflow">if</span> (total_dist &gt; back_distance)</div>
<div class="line"><a id="l00808" name="l00808"></a><span class="lineno">  808</span>                {</div>
<div class="line"><a id="l00809" name="l00809"></a><span class="lineno">  809</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00810" name="l00810"></a><span class="lineno">  810</span>                }</div>
<div class="line"><a id="l00811" name="l00811"></a><span class="lineno">  811</span>            }</div>
<div class="line"><a id="l00812" name="l00812"></a><span class="lineno">  812</span> </div>
<div class="line"><a id="l00813" name="l00813"></a><span class="lineno">  813</span>            back_and_future.insert(back_and_future.end(), points_set.begin() + min_i, points_set.begin() + nearest_pt_index + 1);</div>
<div class="line"><a id="l00814" name="l00814"></a><span class="lineno">  814</span>            back_and_future.insert(back_and_future.end(), future_points.begin(), future_points.end());</div>
<div class="line"><a id="l00815" name="l00815"></a><span class="lineno">  815</span>            <span class="keywordflow">return</span> back_and_future;</div>
<div class="line"><a id="l00816" name="l00816"></a><span class="lineno">  816</span>        }</div>
<div class="line"><a id="l00817" name="l00817"></a><span class="lineno">  817</span> </div>
<div class="line"><a id="l00818" name="l00818"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">  818</a></span>        std::unique_ptr&lt;basic_autonomy::smoothing::SplineI&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">compute_fit</a>(<span class="keyword">const</span> std::vector&lt;lanelet::BasicPoint2d&gt; &amp;basic_points)</div>
<div class="line"><a id="l00819" name="l00819"></a><span class="lineno">  819</span>        {</div>
<div class="line"><a id="l00820" name="l00820"></a><span class="lineno">  820</span>            <span class="keywordflow">if</span> (basic_points.size() &lt; 4)</div>
<div class="line"><a id="l00821" name="l00821"></a><span class="lineno">  821</span>            {</div>
<div class="line"><a id="l00822" name="l00822"></a><span class="lineno">  822</span>                RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Insufficient Spline Points&quot;</span>);</div>
<div class="line"><a id="l00823" name="l00823"></a><span class="lineno">  823</span>                <span class="keywordflow">return</span> <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l00824" name="l00824"></a><span class="lineno">  824</span>            }</div>
<div class="line"><a id="l00825" name="l00825"></a><span class="lineno">  825</span> </div>
<div class="line"><a id="l00826" name="l00826"></a><span class="lineno">  826</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Original basic_points size: &quot;</span> &lt;&lt; basic_points.size());</div>
<div class="line"><a id="l00827" name="l00827"></a><span class="lineno">  827</span> </div>
<div class="line"><a id="l00828" name="l00828"></a><span class="lineno">  828</span>            std::vector&lt;lanelet::BasicPoint2d&gt; resized_basic_points = basic_points;</div>
<div class="line"><a id="l00829" name="l00829"></a><span class="lineno">  829</span> </div>
<div class="line"><a id="l00830" name="l00830"></a><span class="lineno">  830</span>            <span class="comment">// The large the number of points, longer it takes to calculate a spline fit</span></div>
<div class="line"><a id="l00831" name="l00831"></a><span class="lineno">  831</span>            <span class="comment">// So if the basic_points vector size is large, only the first 400 points are used to compute a spline fit.</span></div>
<div class="line"><a id="l00832" name="l00832"></a><span class="lineno">  832</span>            <span class="keywordflow">if</span> (resized_basic_points.size() &gt; 400)</div>
<div class="line"><a id="l00833" name="l00833"></a><span class="lineno">  833</span>            {</div>
<div class="line"><a id="l00834" name="l00834"></a><span class="lineno">  834</span>                resized_basic_points.resize(400);</div>
<div class="line"><a id="l00835" name="l00835"></a><span class="lineno">  835</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Resized basic_points size: &quot;</span> &lt;&lt; resized_basic_points.size());</div>
<div class="line"><a id="l00836" name="l00836"></a><span class="lineno">  836</span> </div>
<div class="line"><a id="l00837" name="l00837"></a><span class="lineno">  837</span>                <span class="keywordtype">size_t</span> left_points_size = basic_points.size() - resized_basic_points.size();</div>
<div class="line"><a id="l00838" name="l00838"></a><span class="lineno">  838</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Number of left out basic_points size: &quot;</span> &lt;&lt; left_points_size);</div>
<div class="line"><a id="l00839" name="l00839"></a><span class="lineno">  839</span> </div>
<div class="line"><a id="l00840" name="l00840"></a><span class="lineno">  840</span>                <span class="keywordtype">float</span> percent_points_lost = 100.0 * (float)left_points_size/basic_points.size();</div>
<div class="line"><a id="l00841" name="l00841"></a><span class="lineno">  841</span> </div>
<div class="line"><a id="l00842" name="l00842"></a><span class="lineno">  842</span>                <span class="keywordflow">if</span> (percent_points_lost &gt; 50.0)</div>
<div class="line"><a id="l00843" name="l00843"></a><span class="lineno">  843</span>                {</div>
<div class="line"><a id="l00844" name="l00844"></a><span class="lineno">  844</span>                    RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;More than half of basic points are ignored for spline fitting&quot;</span>);</div>
<div class="line"><a id="l00845" name="l00845"></a><span class="lineno">  845</span>                }</div>
<div class="line"><a id="l00846" name="l00846"></a><span class="lineno">  846</span>            }</div>
<div class="line"><a id="l00847" name="l00847"></a><span class="lineno">  847</span> </div>
<div class="line"><a id="l00848" name="l00848"></a><span class="lineno">  848</span>            std::unique_ptr&lt;basic_autonomy::smoothing::SplineI&gt; spl = std::make_unique&lt;basic_autonomy::smoothing::BSpline&gt;();</div>
<div class="line"><a id="l00849" name="l00849"></a><span class="lineno">  849</span> </div>
<div class="line"><a id="l00850" name="l00850"></a><span class="lineno">  850</span>            spl-&gt;setPoints(resized_basic_points);</div>
<div class="line"><a id="l00851" name="l00851"></a><span class="lineno">  851</span> </div>
<div class="line"><a id="l00852" name="l00852"></a><span class="lineno">  852</span>            <span class="keywordflow">return</span> spl;</div>
<div class="line"><a id="l00853" name="l00853"></a><span class="lineno">  853</span>        }</div>
<div class="line"><a id="l00854" name="l00854"></a><span class="lineno">  854</span> </div>
<div class="line"><a id="l00855" name="l00855"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#ae4ca284ba04f4f76fb88bf8d20731835">  855</a></span>        <span class="keywordtype">double</span> <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ae4ca284ba04f4f76fb88bf8d20731835">compute_curvature_at</a>(<span class="keyword">const</span> <a class="code hl_class" href="classbasic__autonomy_1_1smoothing_1_1SplineI.html">basic_autonomy::smoothing::SplineI</a> &amp;fit_curve, <span class="keywordtype">double</span> step_along_the_curve)</div>
<div class="line"><a id="l00856" name="l00856"></a><span class="lineno">  856</span>        {</div>
<div class="line"><a id="l00857" name="l00857"></a><span class="lineno">  857</span>            lanelet::BasicPoint2d f_prime_pt = fit_curve.<a class="code hl_function" href="classbasic__autonomy_1_1smoothing_1_1SplineI.html#a6fb15e64df8a2591023ae18fba56606f">first_deriv</a>(step_along_the_curve);</div>
<div class="line"><a id="l00858" name="l00858"></a><span class="lineno">  858</span>            lanelet::BasicPoint2d f_prime_prime_pt = fit_curve.<a class="code hl_function" href="classbasic__autonomy_1_1smoothing_1_1SplineI.html#aae7724df9449ea357153c86bd2e327af">second_deriv</a>(step_along_the_curve);</div>
<div class="line"><a id="l00859" name="l00859"></a><span class="lineno">  859</span>            <span class="comment">// Convert to 3d vector to do 3d vector operations like cross.</span></div>
<div class="line"><a id="l00860" name="l00860"></a><span class="lineno">  860</span>            Eigen::Vector3d f_prime = {f_prime_pt.x(), f_prime_pt.y(), 0};</div>
<div class="line"><a id="l00861" name="l00861"></a><span class="lineno">  861</span>            Eigen::Vector3d f_prime_prime = {f_prime_prime_pt.x(), f_prime_prime_pt.y(), 0};</div>
<div class="line"><a id="l00862" name="l00862"></a><span class="lineno">  862</span>            <span class="keywordflow">return</span> (f_prime.cross(f_prime_prime)).norm() / (pow(f_prime.norm(), 3));</div>
<div class="line"><a id="l00863" name="l00863"></a><span class="lineno">  863</span>        }</div>
<div class="line"><a id="l00864" name="l00864"></a><span class="lineno">  864</span> </div>
<div class="line"><a id="l00865" name="l00865"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#ad633c0c515eae2b1752ad96031e01ef8">  865</a></span>        std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ad633c0c515eae2b1752ad96031e01ef8">compose_lanefollow_trajectory_from_path</a>(</div>
<div class="line"><a id="l00866" name="l00866"></a><span class="lineno">  866</span>            <span class="keyword">const</span> std::vector&lt;PointSpeedPair&gt; &amp;points, <span class="keyword">const</span> carma_planning_msgs::msg::VehicleState &amp;state, <span class="keyword">const</span> rclcpp::Time &amp;state_time, <span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm,</div>
<div class="line"><a id="l00867" name="l00867"></a><span class="lineno">  867</span>            <span class="keyword">const</span> carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, carma_debug_ros2_msgs::msg::TrajectoryCurvatureSpeeds&amp; debug_msg, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config)</div>
<div class="line"><a id="l00868" name="l00868"></a><span class="lineno">  868</span>        {</div>
<div class="line"><a id="l00869" name="l00869"></a><span class="lineno">  869</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;VehicleState: &quot;</span></div>
<div class="line"><a id="l00870" name="l00870"></a><span class="lineno">  870</span>                             &lt;&lt; <span class="stringliteral">&quot; x: &quot;</span> &lt;&lt; state.x_pos_global &lt;&lt; <span class="stringliteral">&quot; y: &quot;</span> &lt;&lt; state.y_pos_global &lt;&lt; <span class="stringliteral">&quot; yaw: &quot;</span> &lt;&lt; state.orientation</div>
<div class="line"><a id="l00871" name="l00871"></a><span class="lineno">  871</span>                             &lt;&lt; <span class="stringliteral">&quot; speed: &quot;</span> &lt;&lt; state.longitudinal_vel);</div>
<div class="line"><a id="l00872" name="l00872"></a><span class="lineno">  872</span> </div>
<div class="line"><a id="l00873" name="l00873"></a><span class="lineno">  873</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#abc6767d55d022e680ccd0d598eba5289">log::printDebugPerLine</a>(points, &amp;<a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#aa5d9aec52bb2d67d8b163be5d2366c8e">log::pointSpeedPairToStream</a>);</div>
<div class="line"><a id="l00874" name="l00874"></a><span class="lineno">  874</span> </div>
<div class="line"><a id="l00875" name="l00875"></a><span class="lineno">  875</span>            <span class="keywordtype">int</span> nearest_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a924ac023f1b51e791ca1b61b9194f44a">get_nearest_point_index</a>(points, state);</div>
<div class="line"><a id="l00876" name="l00876"></a><span class="lineno">  876</span> </div>
<div class="line"><a id="l00877" name="l00877"></a><span class="lineno">  877</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;NearestPtIndex: &quot;</span> &lt;&lt; nearest_pt_index);</div>
<div class="line"><a id="l00878" name="l00878"></a><span class="lineno">  878</span> </div>
<div class="line"><a id="l00879" name="l00879"></a><span class="lineno">  879</span>            std::vector&lt;PointSpeedPair&gt; future_points(points.begin() + nearest_pt_index + 1, points.end()); <span class="comment">// Points in front of current vehicle position</span></div>
<div class="line"><a id="l00880" name="l00880"></a><span class="lineno">  880</span> </div>
<div class="line"><a id="l00881" name="l00881"></a><span class="lineno">  881</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Ready to call constrain_to_time_boundary: future_points size = &quot;</span> &lt;&lt; future_points.size() &lt;&lt; <span class="stringliteral">&quot;, trajectory_time_length = &quot;</span> &lt;&lt; detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aeb772409ce5df1b078295282a353349f">trajectory_time_length</a>);</div>
<div class="line"><a id="l00882" name="l00882"></a><span class="lineno">  882</span> </div>
<div class="line"><a id="l00883" name="l00883"></a><span class="lineno">  883</span>            <span class="keyword">auto</span> time_bound_points = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af509efce135492493e13c9bb86329dcd">constrain_to_time_boundary</a>(future_points, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aeb772409ce5df1b078295282a353349f">trajectory_time_length</a>);</div>
<div class="line"><a id="l00884" name="l00884"></a><span class="lineno">  884</span> </div>
<div class="line"><a id="l00885" name="l00885"></a><span class="lineno">  885</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got time_bound_points with size:&quot;</span> &lt;&lt; time_bound_points.size());</div>
<div class="line"><a id="l00886" name="l00886"></a><span class="lineno">  886</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#abc6767d55d022e680ccd0d598eba5289">log::printDebugPerLine</a>(time_bound_points, &amp;<a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#aa5d9aec52bb2d67d8b163be5d2366c8e">log::pointSpeedPairToStream</a>);</div>
<div class="line"><a id="l00887" name="l00887"></a><span class="lineno">  887</span> </div>
<div class="line"><a id="l00888" name="l00888"></a><span class="lineno">  888</span>            std::vector&lt;PointSpeedPair&gt; back_and_future = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#af9a705cca66d75f0d2d8ce9e6ea2ee41">attach_past_points</a>(points, time_bound_points, nearest_pt_index, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4c8a65b9797246e176f6245025e21b95">back_distance</a>);</div>
<div class="line"><a id="l00889" name="l00889"></a><span class="lineno">  889</span> </div>
<div class="line"><a id="l00890" name="l00890"></a><span class="lineno">  890</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got back_and_future points with size&quot;</span> &lt;&lt; back_and_future.size());</div>
<div class="line"><a id="l00891" name="l00891"></a><span class="lineno">  891</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#abc6767d55d022e680ccd0d598eba5289">log::printDebugPerLine</a>(back_and_future, &amp;<a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#aa5d9aec52bb2d67d8b163be5d2366c8e">log::pointSpeedPairToStream</a>);</div>
<div class="line"><a id="l00892" name="l00892"></a><span class="lineno">  892</span> </div>
<div class="line"><a id="l00893" name="l00893"></a><span class="lineno">  893</span>            std::vector&lt;double&gt; speed_limits;</div>
<div class="line"><a id="l00894" name="l00894"></a><span class="lineno">  894</span>            std::vector&lt;lanelet::BasicPoint2d&gt; curve_points;</div>
<div class="line"><a id="l00895" name="l00895"></a><span class="lineno">  895</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a0f07faaac8c54cc485f2bb217097326e">split_point_speed_pairs</a>(back_and_future, &amp;curve_points, &amp;speed_limits);</div>
<div class="line"><a id="l00896" name="l00896"></a><span class="lineno">  896</span> </div>
<div class="line"><a id="l00897" name="l00897"></a><span class="lineno">  897</span>            std::unique_ptr&lt;smoothing::SplineI&gt; fit_curve = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">compute_fit</a>(curve_points); <span class="comment">// Compute splines based on curve points</span></div>
<div class="line"><a id="l00898" name="l00898"></a><span class="lineno">  898</span>            <span class="keywordflow">if</span> (!fit_curve)</div>
<div class="line"><a id="l00899" name="l00899"></a><span class="lineno">  899</span>            {</div>
<div class="line"><a id="l00900" name="l00900"></a><span class="lineno">  900</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Could not fit a spline curve along the given trajectory!&quot;</span>);</div>
<div class="line"><a id="l00901" name="l00901"></a><span class="lineno">  901</span>            }</div>
<div class="line"><a id="l00902" name="l00902"></a><span class="lineno">  902</span> </div>
<div class="line"><a id="l00903" name="l00903"></a><span class="lineno">  903</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got fit&quot;</span>);</div>
<div class="line"><a id="l00904" name="l00904"></a><span class="lineno">  904</span> </div>
<div class="line"><a id="l00905" name="l00905"></a><span class="lineno">  905</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;speed_limits.size() &quot;</span> &lt;&lt; speed_limits.size());</div>
<div class="line"><a id="l00906" name="l00906"></a><span class="lineno">  906</span> </div>
<div class="line"><a id="l00907" name="l00907"></a><span class="lineno">  907</span>            std::vector&lt;lanelet::BasicPoint2d&gt; all_sampling_points;</div>
<div class="line"><a id="l00908" name="l00908"></a><span class="lineno">  908</span>            all_sampling_points.reserve(1 + curve_points.size() * 2);</div>
<div class="line"><a id="l00909" name="l00909"></a><span class="lineno">  909</span> </div>
<div class="line"><a id="l00910" name="l00910"></a><span class="lineno">  910</span>            std::vector&lt;double&gt; distributed_speed_limits;</div>
<div class="line"><a id="l00911" name="l00911"></a><span class="lineno">  911</span>            distributed_speed_limits.reserve(1 + curve_points.size() * 2);</div>
<div class="line"><a id="l00912" name="l00912"></a><span class="lineno">  912</span> </div>
<div class="line"><a id="l00913" name="l00913"></a><span class="lineno">  913</span>            <span class="comment">// compute total length of the trajectory to get correct number of points</span></div>
<div class="line"><a id="l00914" name="l00914"></a><span class="lineno">  914</span>            <span class="comment">// we expect using curve_resample_step_size</span></div>
<div class="line"><a id="l00915" name="l00915"></a><span class="lineno">  915</span>            std::vector&lt;double&gt; downtracks_raw = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(curve_points);</div>
<div class="line"><a id="l00916" name="l00916"></a><span class="lineno">  916</span> </div>
<div class="line"><a id="l00917" name="l00917"></a><span class="lineno">  917</span>            <span class="keyword">auto</span> total_step_along_curve = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(downtracks_raw.back() / detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aed01f5b534f9dc52cc74022c71e2fa3c">curve_resample_step_size</a>);</div>
<div class="line"><a id="l00918" name="l00918"></a><span class="lineno">  918</span> </div>
<div class="line"><a id="l00919" name="l00919"></a><span class="lineno">  919</span>            <span class="keywordtype">int</span> current_speed_index = 0;</div>
<div class="line"><a id="l00920" name="l00920"></a><span class="lineno">  920</span>            <span class="keywordtype">size_t</span> total_point_size = curve_points.size();</div>
<div class="line"><a id="l00921" name="l00921"></a><span class="lineno">  921</span> </div>
<div class="line"><a id="l00922" name="l00922"></a><span class="lineno">  922</span>            <span class="keywordtype">double</span> step_threshold_for_next_speed = (double)total_step_along_curve / (<span class="keywordtype">double</span>)total_point_size;</div>
<div class="line"><a id="l00923" name="l00923"></a><span class="lineno">  923</span>            <span class="keywordtype">double</span> scaled_steps_along_curve = 0.0; <span class="comment">// from 0 (start) to 1 (end) for the whole trajectory</span></div>
<div class="line"><a id="l00924" name="l00924"></a><span class="lineno">  924</span>            std::vector&lt;double&gt; better_curvature;</div>
<div class="line"><a id="l00925" name="l00925"></a><span class="lineno">  925</span>            better_curvature.reserve(1 + curve_points.size() * 2);</div>
<div class="line"><a id="l00926" name="l00926"></a><span class="lineno">  926</span> </div>
<div class="line"><a id="l00927" name="l00927"></a><span class="lineno">  927</span>            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> steps_along_curve = 0; steps_along_curve &lt; total_step_along_curve; steps_along_curve++) <span class="comment">// Resample curve at tighter resolution</span></div>
<div class="line"><a id="l00928" name="l00928"></a><span class="lineno">  928</span>            {</div>
<div class="line"><a id="l00929" name="l00929"></a><span class="lineno">  929</span>                lanelet::BasicPoint2d p = (*fit_curve)(scaled_steps_along_curve);</div>
<div class="line"><a id="l00930" name="l00930"></a><span class="lineno">  930</span> </div>
<div class="line"><a id="l00931" name="l00931"></a><span class="lineno">  931</span>                all_sampling_points.push_back(p);</div>
<div class="line"><a id="l00932" name="l00932"></a><span class="lineno">  932</span>                <span class="keywordtype">double</span> <a class="code hl_variable" href="namespaceprocess__traj__logs.html#a49cd466f330a9498d8373baecf47e071">c</a> = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ae4ca284ba04f4f76fb88bf8d20731835">compute_curvature_at</a>((*fit_curve), scaled_steps_along_curve);</div>
<div class="line"><a id="l00933" name="l00933"></a><span class="lineno">  933</span>                better_curvature.push_back(<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a49cd466f330a9498d8373baecf47e071">c</a>);</div>
<div class="line"><a id="l00934" name="l00934"></a><span class="lineno">  934</span>                <span class="keywordflow">if</span> ((<span class="keywordtype">double</span>)steps_along_curve &gt; step_threshold_for_next_speed)</div>
<div class="line"><a id="l00935" name="l00935"></a><span class="lineno">  935</span>                {</div>
<div class="line"><a id="l00936" name="l00936"></a><span class="lineno">  936</span>                    step_threshold_for_next_speed += (double)total_step_along_curve / (<span class="keywordtype">double</span>)total_point_size;</div>
<div class="line"><a id="l00937" name="l00937"></a><span class="lineno">  937</span>                    current_speed_index++;</div>
<div class="line"><a id="l00938" name="l00938"></a><span class="lineno">  938</span>                }</div>
<div class="line"><a id="l00939" name="l00939"></a><span class="lineno">  939</span>                distributed_speed_limits.push_back(speed_limits[current_speed_index]); <span class="comment">// Identify speed limits for resampled points</span></div>
<div class="line"><a id="l00940" name="l00940"></a><span class="lineno">  940</span>                scaled_steps_along_curve += 1.0 / total_step_along_curve;              <span class="comment">//adding steps_along_curve_step_size</span></div>
<div class="line"><a id="l00941" name="l00941"></a><span class="lineno">  941</span>            }</div>
<div class="line"><a id="l00942" name="l00942"></a><span class="lineno">  942</span> </div>
<div class="line"><a id="l00943" name="l00943"></a><span class="lineno">  943</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got sampled points with size:&quot;</span> &lt;&lt; all_sampling_points.size());</div>
<div class="line"><a id="l00944" name="l00944"></a><span class="lineno">  944</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#abc6767d55d022e680ccd0d598eba5289">log::printDebugPerLine</a>(all_sampling_points, &amp;<a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a9123a8bedcfb34f1e6c1336f226956fb">log::basicPointToStream</a>);</div>
<div class="line"><a id="l00945" name="l00945"></a><span class="lineno">  945</span> </div>
<div class="line"><a id="l00946" name="l00946"></a><span class="lineno">  946</span>            std::vector&lt;double&gt; final_yaw_values = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#ad8a3ee0bf06f85a6e7a8b5097251da2b">carma_wm::geometry::compute_tangent_orientations</a>(all_sampling_points);</div>
<div class="line"><a id="l00947" name="l00947"></a><span class="lineno">  947</span> </div>
<div class="line"><a id="l00948" name="l00948"></a><span class="lineno">  948</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;raw_curvatures[i]: &quot;</span>, better_curvature);</div>
<div class="line"><a id="l00949" name="l00949"></a><span class="lineno">  949</span> </div>
<div class="line"><a id="l00950" name="l00950"></a><span class="lineno">  950</span>            std::vector&lt;double&gt; curvatures = <a class="code hl_function" href="namespacebasic__autonomy_1_1smoothing.html#afb726e75a21ada8efa3ca5561ffc9984">smoothing::moving_average_filter</a>(better_curvature, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a60a7d101e04a9a2bf755b8c5a9741354">curvature_moving_average_window_size</a>, <span class="keyword">false</span>);</div>
<div class="line"><a id="l00951" name="l00951"></a><span class="lineno">  951</span>            std::vector&lt;double&gt; ideal_speeds =</div>
<div class="line"><a id="l00952" name="l00952"></a><span class="lineno">  952</span>                trajectory_utils::constrained_speeds_for_curvatures(curvatures, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a75872d4c289f3eda6a9a6cfca337534b">lateral_accel_limit</a>);</div>
<div class="line"><a id="l00953" name="l00953"></a><span class="lineno">  953</span> </div>
<div class="line"><a id="l00954" name="l00954"></a><span class="lineno">  954</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;curvatures[i]: &quot;</span>, curvatures);</div>
<div class="line"><a id="l00955" name="l00955"></a><span class="lineno">  955</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;ideal_speeds: &quot;</span>, ideal_speeds);</div>
<div class="line"><a id="l00956" name="l00956"></a><span class="lineno">  956</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;final_yaw_values[i]: &quot;</span>, final_yaw_values);</div>
<div class="line"><a id="l00957" name="l00957"></a><span class="lineno">  957</span> </div>
<div class="line"><a id="l00958" name="l00958"></a><span class="lineno">  958</span>            std::vector&lt;double&gt; constrained_speed_limits = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#ab4974a3dfe697ccc0dd1344a8e11c5e1">apply_speed_limits</a>(ideal_speeds, distributed_speed_limits);</div>
<div class="line"><a id="l00959" name="l00959"></a><span class="lineno">  959</span> </div>
<div class="line"><a id="l00960" name="l00960"></a><span class="lineno">  960</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Processed all points in computed fit&quot;</span>);</div>
<div class="line"><a id="l00961" name="l00961"></a><span class="lineno">  961</span> </div>
<div class="line"><a id="l00962" name="l00962"></a><span class="lineno">  962</span>            <span class="keywordflow">if</span> (all_sampling_points.empty())</div>
<div class="line"><a id="l00963" name="l00963"></a><span class="lineno">  963</span>            {</div>
<div class="line"><a id="l00964" name="l00964"></a><span class="lineno">  964</span>                RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;No trajectory points could be generated&quot;</span>);</div>
<div class="line"><a id="l00965" name="l00965"></a><span class="lineno">  965</span>                <span class="keywordflow">return</span> {};</div>
<div class="line"><a id="l00966" name="l00966"></a><span class="lineno">  966</span>            }</div>
<div class="line"><a id="l00967" name="l00967"></a><span class="lineno">  967</span> </div>
<div class="line"><a id="l00968" name="l00968"></a><span class="lineno">  968</span>            <span class="comment">// Add current vehicle point to front of the trajectory</span></div>
<div class="line"><a id="l00969" name="l00969"></a><span class="lineno">  969</span> </div>
<div class="line"><a id="l00970" name="l00970"></a><span class="lineno">  970</span>            nearest_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(all_sampling_points, wm, state);</div>
<div class="line"><a id="l00971" name="l00971"></a><span class="lineno">  971</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Current state&#39;s nearest_pt_index: &quot;</span> &lt;&lt; nearest_pt_index);</div>
<div class="line"><a id="l00972" name="l00972"></a><span class="lineno">  972</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Curvature right now: &quot;</span> &lt;&lt; better_curvature[nearest_pt_index] &lt;&lt; <span class="stringliteral">&quot;, at state x: &quot;</span> &lt;&lt; state.x_pos_global &lt;&lt; <span class="stringliteral">&quot;, state y: &quot;</span> &lt;&lt; state.y_pos_global);</div>
<div class="line"><a id="l00973" name="l00973"></a><span class="lineno">  973</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Corresponding to point: x: &quot;</span> &lt;&lt; all_sampling_points[nearest_pt_index].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>() &lt;&lt; <span class="stringliteral">&quot;, y:&quot;</span> &lt;&lt; all_sampling_points[nearest_pt_index].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a>());</div>
<div class="line"><a id="l00974" name="l00974"></a><span class="lineno">  974</span> </div>
<div class="line"><a id="l00975" name="l00975"></a><span class="lineno">  975</span>            <span class="keywordtype">int</span> buffer_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(all_sampling_points, wm, ending_state_before_buffer);</div>
<div class="line"><a id="l00976" name="l00976"></a><span class="lineno">  976</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Ending state&#39;s index before applying buffer (buffer_pt_index): &quot;</span> &lt;&lt; buffer_pt_index);</div>
<div class="line"><a id="l00977" name="l00977"></a><span class="lineno">  977</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Corresponding to point: x: &quot;</span> &lt;&lt; all_sampling_points[buffer_pt_index].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>() &lt;&lt; <span class="stringliteral">&quot;, y:&quot;</span> &lt;&lt; all_sampling_points[buffer_pt_index].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a>());</div>
<div class="line"><a id="l00978" name="l00978"></a><span class="lineno">  978</span> </div>
<div class="line"><a id="l00979" name="l00979"></a><span class="lineno">  979</span>            <span class="keywordflow">if</span>(nearest_pt_index + 1 &gt;= buffer_pt_index){</div>
<div class="line"><a id="l00980" name="l00980"></a><span class="lineno">  980</span> </div>
<div class="line"><a id="l00981" name="l00981"></a><span class="lineno">  981</span>                lanelet::BasicPoint2d current_pos(state.x_pos_global, state.y_pos_global);</div>
<div class="line"><a id="l00982" name="l00982"></a><span class="lineno">  982</span>                lanelet::BasicPoint2d ending_pos(ending_state_before_buffer.x_pos_global, ending_state_before_buffer.y_pos_global);</div>
<div class="line"><a id="l00983" name="l00983"></a><span class="lineno">  983</span> </div>
<div class="line"><a id="l00984" name="l00984"></a><span class="lineno">  984</span>                <span class="keywordflow">if</span>(wm-&gt;routeTrackPos(ending_pos).downtrack &lt; wm-&gt;routeTrackPos(current_pos).downtrack ){</div>
<div class="line"><a id="l00985" name="l00985"></a><span class="lineno">  985</span> </div>
<div class="line"><a id="l00986" name="l00986"></a><span class="lineno">  986</span>                    RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Current state is at or past the planned end distance. Couldn&#39;t generate trajectory&quot;</span>);</div>
<div class="line"><a id="l00987" name="l00987"></a><span class="lineno">  987</span>                    <span class="keywordflow">return</span> {};</div>
<div class="line"><a id="l00988" name="l00988"></a><span class="lineno">  988</span>                }</div>
<div class="line"><a id="l00989" name="l00989"></a><span class="lineno">  989</span>                <span class="keywordflow">else</span>{</div>
<div class="line"><a id="l00990" name="l00990"></a><span class="lineno">  990</span>                    <span class="comment">//Current point is behind the ending state of maneuver and a valid trajectory is possible</span></div>
<div class="line"><a id="l00991" name="l00991"></a><span class="lineno">  991</span>                    RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Returning the two remaining points in the maneuver&quot;</span>);</div>
<div class="line"><a id="l00992" name="l00992"></a><span class="lineno">  992</span> </div>
<div class="line"><a id="l00993" name="l00993"></a><span class="lineno">  993</span>                    std::vector&lt;lanelet::BasicPoint2d&gt; remaining_traj_points = {current_pos, ending_pos};</div>
<div class="line"><a id="l00994" name="l00994"></a><span class="lineno">  994</span> </div>
<div class="line"><a id="l00995" name="l00995"></a><span class="lineno">  995</span>                    std::vector&lt;double&gt; downtracks = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(remaining_traj_points);</div>
<div class="line"><a id="l00996" name="l00996"></a><span class="lineno">  996</span>                    std::vector&lt;double&gt; speeds = {state.longitudinal_vel, state.longitudinal_vel};<span class="comment">//Keep current speed</span></div>
<div class="line"><a id="l00997" name="l00997"></a><span class="lineno">  997</span>                    std::vector&lt;double&gt; times;</div>
<div class="line"><a id="l00998" name="l00998"></a><span class="lineno">  998</span>                    trajectory_utils::conversions::speed_to_time(downtracks, speeds, &amp;times);</div>
<div class="line"><a id="l00999" name="l00999"></a><span class="lineno">  999</span>                    std::vector&lt;double&gt; yaw = {state.orientation, state.orientation}; <span class="comment">//Keep current orientation</span></div>
<div class="line"><a id="l01000" name="l01000"></a><span class="lineno"> 1000</span> </div>
<div class="line"><a id="l01001" name="l01001"></a><span class="lineno"> 1001</span>                    std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; traj_points =</div>
<div class="line"><a id="l01002" name="l01002"></a><span class="lineno"> 1002</span>                    <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">trajectory_from_points_times_orientations</a>(remaining_traj_points, times, yaw, state_time, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a89ca36377e20e514abc609c5bd65a941">desired_controller_plugin</a>);</div>
<div class="line"><a id="l01003" name="l01003"></a><span class="lineno"> 1003</span> </div>
<div class="line"><a id="l01004" name="l01004"></a><span class="lineno"> 1004</span>                    <span class="keywordflow">return</span> traj_points;</div>
<div class="line"><a id="l01005" name="l01005"></a><span class="lineno"> 1005</span> </div>
<div class="line"><a id="l01006" name="l01006"></a><span class="lineno"> 1006</span>                }</div>
<div class="line"><a id="l01007" name="l01007"></a><span class="lineno"> 1007</span>            }</div>
<div class="line"><a id="l01008" name="l01008"></a><span class="lineno"> 1008</span> </div>
<div class="line"><a id="l01009" name="l01009"></a><span class="lineno"> 1009</span>            <span class="comment">//drop buffer points here</span></div>
<div class="line"><a id="l01010" name="l01010"></a><span class="lineno"> 1010</span> </div>
<div class="line"><a id="l01011" name="l01011"></a><span class="lineno"> 1011</span>             std::vector&lt;lanelet::BasicPoint2d&gt; future_basic_points(all_sampling_points.begin() + nearest_pt_index + 1,</div>
<div class="line"><a id="l01012" name="l01012"></a><span class="lineno"> 1012</span>                                            all_sampling_points.begin()+ buffer_pt_index);  <span class="comment">// Points in front of current vehicle position</span></div>
<div class="line"><a id="l01013" name="l01013"></a><span class="lineno"> 1013</span> </div>
<div class="line"><a id="l01014" name="l01014"></a><span class="lineno"> 1014</span>            std::vector&lt;double&gt; future_speeds(constrained_speed_limits.begin() + nearest_pt_index + 1,</div>
<div class="line"><a id="l01015" name="l01015"></a><span class="lineno"> 1015</span>                                                        constrained_speed_limits.begin() + buffer_pt_index);  <span class="comment">// Points in front of current vehicle position</span></div>
<div class="line"><a id="l01016" name="l01016"></a><span class="lineno"> 1016</span>            std::vector&lt;double&gt; future_yaw(final_yaw_values.begin() + nearest_pt_index + 1,</div>
<div class="line"><a id="l01017" name="l01017"></a><span class="lineno"> 1017</span>                                                        final_yaw_values.begin() + buffer_pt_index);  <span class="comment">// Points in front of current vehicle position</span></div>
<div class="line"><a id="l01018" name="l01018"></a><span class="lineno"> 1018</span>            std::vector&lt;double&gt;  final_actual_speeds = future_speeds;</div>
<div class="line"><a id="l01019" name="l01019"></a><span class="lineno"> 1019</span>            all_sampling_points = future_basic_points;</div>
<div class="line"><a id="l01020" name="l01020"></a><span class="lineno"> 1020</span>            final_yaw_values = future_yaw;</div>
<div class="line"><a id="l01021" name="l01021"></a><span class="lineno"> 1021</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Trimmed future points to size: &quot;</span>&lt;&lt; future_basic_points.size());</div>
<div class="line"><a id="l01022" name="l01022"></a><span class="lineno"> 1022</span> </div>
<div class="line"><a id="l01023" name="l01023"></a><span class="lineno"> 1023</span>            lanelet::BasicPoint2d cur_veh_point(state.x_pos_global, state.y_pos_global);</div>
<div class="line"><a id="l01024" name="l01024"></a><span class="lineno"> 1024</span> </div>
<div class="line"><a id="l01025" name="l01025"></a><span class="lineno"> 1025</span>            all_sampling_points.insert(all_sampling_points.begin(),</div>
<div class="line"><a id="l01026" name="l01026"></a><span class="lineno"> 1026</span>                                       cur_veh_point); <span class="comment">// Add current vehicle position to front of sample points</span></div>
<div class="line"><a id="l01027" name="l01027"></a><span class="lineno"> 1027</span> </div>
<div class="line"><a id="l01028" name="l01028"></a><span class="lineno"> 1028</span>            final_actual_speeds.insert(final_actual_speeds.begin(), state.longitudinal_vel);</div>
<div class="line"><a id="l01029" name="l01029"></a><span class="lineno"> 1029</span> </div>
<div class="line"><a id="l01030" name="l01030"></a><span class="lineno"> 1030</span>            final_yaw_values.insert(final_yaw_values.begin(), state.orientation);</div>
<div class="line"><a id="l01031" name="l01031"></a><span class="lineno"> 1031</span> </div>
<div class="line"><a id="l01032" name="l01032"></a><span class="lineno"> 1032</span>            <span class="comment">// Compute points to local downtracks</span></div>
<div class="line"><a id="l01033" name="l01033"></a><span class="lineno"> 1033</span>            std::vector&lt;double&gt; downtracks = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(all_sampling_points);</div>
<div class="line"><a id="l01034" name="l01034"></a><span class="lineno"> 1034</span> </div>
<div class="line"><a id="l01035" name="l01035"></a><span class="lineno"> 1035</span>            <span class="comment">// Apply accel limits</span></div>
<div class="line"><a id="l01036" name="l01036"></a><span class="lineno"> 1036</span>            final_actual_speeds = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a84a6c11da2d9736a8f277b6afd124100">optimize_speed</a>(downtracks, final_actual_speeds, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ac27f6c12b09f9cc22e608ec1be16477c">max_accel</a>);</div>
<div class="line"><a id="l01037" name="l01037"></a><span class="lineno"> 1037</span> </div>
<div class="line"><a id="l01038" name="l01038"></a><span class="lineno"> 1038</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;postAccel[i]: &quot;</span>, final_actual_speeds);</div>
<div class="line"><a id="l01039" name="l01039"></a><span class="lineno"> 1039</span> </div>
<div class="line"><a id="l01040" name="l01040"></a><span class="lineno"> 1040</span>            final_actual_speeds = <a class="code hl_function" href="namespacebasic__autonomy_1_1smoothing.html#afb726e75a21ada8efa3ca5561ffc9984">smoothing::moving_average_filter</a>(final_actual_speeds, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4a883bd5094bdc768c05d0c3a751f219">speed_moving_average_window_size</a>);</div>
<div class="line"><a id="l01041" name="l01041"></a><span class="lineno"> 1041</span> </div>
<div class="line"><a id="l01042" name="l01042"></a><span class="lineno"> 1042</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;post_average[i]: &quot;</span>, final_actual_speeds);</div>
<div class="line"><a id="l01043" name="l01043"></a><span class="lineno"> 1043</span> </div>
<div class="line"><a id="l01044" name="l01044"></a><span class="lineno"> 1044</span>            <span class="keywordflow">for</span> (<span class="keyword">auto</span> &amp;s : final_actual_speeds) <span class="comment">// Limit minimum speed. TODO how to handle stopping?</span></div>
<div class="line"><a id="l01045" name="l01045"></a><span class="lineno"> 1045</span>            {</div>
<div class="line"><a id="l01046" name="l01046"></a><span class="lineno"> 1046</span>                s = std::max(s, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4bf547260f4eb35b2df2a8ddb5b216c8">minimum_speed</a>);</div>
<div class="line"><a id="l01047" name="l01047"></a><span class="lineno"> 1047</span>            }</div>
<div class="line"><a id="l01048" name="l01048"></a><span class="lineno"> 1048</span> </div>
<div class="line"><a id="l01049" name="l01049"></a><span class="lineno"> 1049</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;post_min_speed[i]: &quot;</span>, final_actual_speeds);</div>
<div class="line"><a id="l01050" name="l01050"></a><span class="lineno"> 1050</span> </div>
<div class="line"><a id="l01051" name="l01051"></a><span class="lineno"> 1051</span>            <span class="comment">// Convert speeds to times</span></div>
<div class="line"><a id="l01052" name="l01052"></a><span class="lineno"> 1052</span>            std::vector&lt;double&gt; times;</div>
<div class="line"><a id="l01053" name="l01053"></a><span class="lineno"> 1053</span>            trajectory_utils::conversions::speed_to_time(downtracks, final_actual_speeds, &amp;times);</div>
<div class="line"><a id="l01054" name="l01054"></a><span class="lineno"> 1054</span> </div>
<div class="line"><a id="l01055" name="l01055"></a><span class="lineno"> 1055</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">log::printDoublesPerLineWithPrefix</a>(<span class="stringliteral">&quot;times[i]: &quot;</span>, times);</div>
<div class="line"><a id="l01056" name="l01056"></a><span class="lineno"> 1056</span> </div>
<div class="line"><a id="l01057" name="l01057"></a><span class="lineno"> 1057</span>            <span class="comment">// Build trajectory points</span></div>
<div class="line"><a id="l01058" name="l01058"></a><span class="lineno"> 1058</span>            std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; traj_points =</div>
<div class="line"><a id="l01059" name="l01059"></a><span class="lineno"> 1059</span>                <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">trajectory_from_points_times_orientations</a>(all_sampling_points, times, final_yaw_values, state_time, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a89ca36377e20e514abc609c5bd65a941">desired_controller_plugin</a>);</div>
<div class="line"><a id="l01060" name="l01060"></a><span class="lineno"> 1060</span> </div>
<div class="line"><a id="l01061" name="l01061"></a><span class="lineno"> 1061</span>            <span class="comment">//debug msg</span></div>
<div class="line"><a id="l01062" name="l01062"></a><span class="lineno"> 1062</span>            carma_debug_ros2_msgs::msg::TrajectoryCurvatureSpeeds msg;</div>
<div class="line"><a id="l01063" name="l01063"></a><span class="lineno"> 1063</span>            msg.velocity_profile = final_actual_speeds;</div>
<div class="line"><a id="l01064" name="l01064"></a><span class="lineno"> 1064</span>            msg.relative_downtrack = downtracks;</div>
<div class="line"><a id="l01065" name="l01065"></a><span class="lineno"> 1065</span>            msg.tangent_headings = final_yaw_values;</div>
<div class="line"><a id="l01066" name="l01066"></a><span class="lineno"> 1066</span>            std::vector&lt;double&gt; aligned_speed_limits(constrained_speed_limits.begin() + nearest_pt_index,</div>
<div class="line"><a id="l01067" name="l01067"></a><span class="lineno"> 1067</span>                                                    constrained_speed_limits.end());</div>
<div class="line"><a id="l01068" name="l01068"></a><span class="lineno"> 1068</span> </div>
<div class="line"><a id="l01069" name="l01069"></a><span class="lineno"> 1069</span>            msg.speed_limits = aligned_speed_limits;</div>
<div class="line"><a id="l01070" name="l01070"></a><span class="lineno"> 1070</span>            std::vector&lt;double&gt; aligned_curvatures(curvatures.begin() + nearest_pt_index,</div>
<div class="line"><a id="l01071" name="l01071"></a><span class="lineno"> 1071</span>                                                    curvatures.end());</div>
<div class="line"><a id="l01072" name="l01072"></a><span class="lineno"> 1072</span>            msg.curvatures = aligned_curvatures;</div>
<div class="line"><a id="l01073" name="l01073"></a><span class="lineno"> 1073</span>            msg.lat_accel_limit = detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a75872d4c289f3eda6a9a6cfca337534b">lateral_accel_limit</a>;</div>
<div class="line"><a id="l01074" name="l01074"></a><span class="lineno"> 1074</span>            msg.lon_accel_limit = detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ac27f6c12b09f9cc22e608ec1be16477c">max_accel</a>;</div>
<div class="line"><a id="l01075" name="l01075"></a><span class="lineno"> 1075</span>            msg.starting_state = state;</div>
<div class="line"><a id="l01076" name="l01076"></a><span class="lineno"> 1076</span>            debug_msg = msg;</div>
<div class="line"><a id="l01077" name="l01077"></a><span class="lineno"> 1077</span> </div>
<div class="line"><a id="l01078" name="l01078"></a><span class="lineno"> 1078</span> </div>
<div class="line"><a id="l01079" name="l01079"></a><span class="lineno"> 1079</span>            <span class="keywordflow">return</span> traj_points;</div>
<div class="line"><a id="l01080" name="l01080"></a><span class="lineno"> 1080</span>        }</div>
<div class="line"><a id="l01081" name="l01081"></a><span class="lineno"> 1081</span> </div>
<div class="line"><a id="l01082" name="l01082"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a8be61ccb69db73e2e70d5e59f88ce446"> 1082</a></span>        <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a8be61ccb69db73e2e70d5e59f88ce446">compose_detailed_trajectory_config</a>(<span class="keywordtype">double</span> trajectory_time_length,</div>
<div class="line"><a id="l01083" name="l01083"></a><span class="lineno"> 1083</span>                                                              <span class="keywordtype">double</span> curve_resample_step_size,</div>
<div class="line"><a id="l01084" name="l01084"></a><span class="lineno"> 1084</span>                                                              <span class="keywordtype">double</span> minimum_speed,</div>
<div class="line"><a id="l01085" name="l01085"></a><span class="lineno"> 1085</span>                                                              <span class="keywordtype">double</span> max_accel,</div>
<div class="line"><a id="l01086" name="l01086"></a><span class="lineno"> 1086</span>                                                              <span class="keywordtype">double</span> lateral_accel_limit,</div>
<div class="line"><a id="l01087" name="l01087"></a><span class="lineno"> 1087</span>                                                              <span class="keywordtype">int</span> speed_moving_average_window_size,</div>
<div class="line"><a id="l01088" name="l01088"></a><span class="lineno"> 1088</span>                                                              <span class="keywordtype">int</span> curvature_moving_average_window_size,</div>
<div class="line"><a id="l01089" name="l01089"></a><span class="lineno"> 1089</span>                                                              <span class="keywordtype">double</span> back_distance,</div>
<div class="line"><a id="l01090" name="l01090"></a><span class="lineno"> 1090</span>                                                              <span class="keywordtype">double</span> buffer_ending_downtrack,</div>
<div class="line"><a id="l01091" name="l01091"></a><span class="lineno"> 1091</span>                                                              std::string desired_controller_plugin)</div>
<div class="line"><a id="l01092" name="l01092"></a><span class="lineno"> 1092</span>        {</div>
<div class="line"><a id="l01093" name="l01093"></a><span class="lineno"> 1093</span>            <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> detailed_config;</div>
<div class="line"><a id="l01094" name="l01094"></a><span class="lineno"> 1094</span> </div>
<div class="line"><a id="l01095" name="l01095"></a><span class="lineno"> 1095</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aeb772409ce5df1b078295282a353349f">trajectory_time_length</a> = trajectory_time_length;</div>
<div class="line"><a id="l01096" name="l01096"></a><span class="lineno"> 1096</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aed01f5b534f9dc52cc74022c71e2fa3c">curve_resample_step_size</a> = curve_resample_step_size;</div>
<div class="line"><a id="l01097" name="l01097"></a><span class="lineno"> 1097</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4bf547260f4eb35b2df2a8ddb5b216c8">minimum_speed</a> = minimum_speed;</div>
<div class="line"><a id="l01098" name="l01098"></a><span class="lineno"> 1098</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ac27f6c12b09f9cc22e608ec1be16477c">max_accel</a> = max_accel;</div>
<div class="line"><a id="l01099" name="l01099"></a><span class="lineno"> 1099</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a75872d4c289f3eda6a9a6cfca337534b">lateral_accel_limit</a> = lateral_accel_limit;</div>
<div class="line"><a id="l01100" name="l01100"></a><span class="lineno"> 1100</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4a883bd5094bdc768c05d0c3a751f219">speed_moving_average_window_size</a> = speed_moving_average_window_size;</div>
<div class="line"><a id="l01101" name="l01101"></a><span class="lineno"> 1101</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a60a7d101e04a9a2bf755b8c5a9741354">curvature_moving_average_window_size</a> = curvature_moving_average_window_size;</div>
<div class="line"><a id="l01102" name="l01102"></a><span class="lineno"> 1102</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4c8a65b9797246e176f6245025e21b95">back_distance</a> = back_distance;</div>
<div class="line"><a id="l01103" name="l01103"></a><span class="lineno"> 1103</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">buffer_ending_downtrack</a> = buffer_ending_downtrack;</div>
<div class="line"><a id="l01104" name="l01104"></a><span class="lineno"> 1104</span>            detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a89ca36377e20e514abc609c5bd65a941">desired_controller_plugin</a> = desired_controller_plugin;</div>
<div class="line"><a id="l01105" name="l01105"></a><span class="lineno"> 1105</span> </div>
<div class="line"><a id="l01106" name="l01106"></a><span class="lineno"> 1106</span>            <span class="keywordflow">return</span> detailed_config;</div>
<div class="line"><a id="l01107" name="l01107"></a><span class="lineno"> 1107</span>        }</div>
<div class="line"><a id="l01108" name="l01108"></a><span class="lineno"> 1108</span> </div>
<div class="line"><a id="l01109" name="l01109"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a11b8eae5903a23ecab69c2f814c1bcf8"> 1109</a></span>        <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">GeneralTrajConfig</a> <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a11b8eae5903a23ecab69c2f814c1bcf8">compose_general_trajectory_config</a>(<span class="keyword">const</span> std::string&amp; trajectory_type,</div>
<div class="line"><a id="l01110" name="l01110"></a><span class="lineno"> 1110</span>                                                            <span class="keywordtype">int</span> default_downsample_ratio,</div>
<div class="line"><a id="l01111" name="l01111"></a><span class="lineno"> 1111</span>                                                            <span class="keywordtype">int</span> turn_downsample_ratio)</div>
<div class="line"><a id="l01112" name="l01112"></a><span class="lineno"> 1112</span>        {</div>
<div class="line"><a id="l01113" name="l01113"></a><span class="lineno"> 1113</span>            <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">GeneralTrajConfig</a> general_config;</div>
<div class="line"><a id="l01114" name="l01114"></a><span class="lineno"> 1114</span> </div>
<div class="line"><a id="l01115" name="l01115"></a><span class="lineno"> 1115</span>            general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a3cea08651e7da10dc7b7510dc82b192d">trajectory_type</a> = trajectory_type;</div>
<div class="line"><a id="l01116" name="l01116"></a><span class="lineno"> 1116</span>            general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a0ad2d91d1f739942213d5bfe7f0e861f">default_downsample_ratio</a> = default_downsample_ratio;</div>
<div class="line"><a id="l01117" name="l01117"></a><span class="lineno"> 1117</span>            general_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a57b1703c6bbc6043c489280ca1c34041">turn_downsample_ratio</a> = turn_downsample_ratio;</div>
<div class="line"><a id="l01118" name="l01118"></a><span class="lineno"> 1118</span> </div>
<div class="line"><a id="l01119" name="l01119"></a><span class="lineno"> 1119</span> </div>
<div class="line"><a id="l01120" name="l01120"></a><span class="lineno"> 1120</span>            <span class="keywordflow">return</span> general_config;</div>
<div class="line"><a id="l01121" name="l01121"></a><span class="lineno"> 1121</span>        }</div>
<div class="line"><a id="l01122" name="l01122"></a><span class="lineno"> 1122</span> </div>
<div class="line"><a id="l01123" name="l01123"></a><span class="lineno"> 1123</span> </div>
<div class="line"><a id="l01124" name="l01124"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a741942c16ca54212b9adf3ddc2eea66d"> 1124</a></span>        std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a741942c16ca54212b9adf3ddc2eea66d">compose_lanechange_trajectory_from_path</a>(</div>
<div class="line"><a id="l01125" name="l01125"></a><span class="lineno"> 1125</span>            <span class="keyword">const</span> std::vector&lt;PointSpeedPair&gt; &amp;points, <span class="keyword">const</span> carma_planning_msgs::msg::VehicleState &amp;state, <span class="keyword">const</span> rclcpp::Time &amp;state_time,</div>
<div class="line"><a id="l01126" name="l01126"></a><span class="lineno"> 1126</span>            <span class="keyword">const</span> <a class="code hl_typedef" href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a> &amp;wm, <span class="keyword">const</span> carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, <span class="keyword">const</span> <a class="code hl_struct" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">DetailedTrajConfig</a> &amp;detailed_config)</div>
<div class="line"><a id="l01127" name="l01127"></a><span class="lineno"> 1127</span>        {</div>
<div class="line"><a id="l01128" name="l01128"></a><span class="lineno"> 1128</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Input points size in compose traj from centerline: &quot;</span>&lt;&lt; points.size());</div>
<div class="line"><a id="l01129" name="l01129"></a><span class="lineno"> 1129</span>            <span class="keywordtype">int</span> nearest_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(points, wm, state);</div>
<div class="line"><a id="l01130" name="l01130"></a><span class="lineno"> 1130</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;nearest_pt_index: &quot;</span>&lt;&lt; nearest_pt_index);</div>
<div class="line"><a id="l01131" name="l01131"></a><span class="lineno"> 1131</span> </div>
<div class="line"><a id="l01132" name="l01132"></a><span class="lineno"> 1132</span>            std::vector&lt;PointSpeedPair&gt; future_points(points.begin() + nearest_pt_index + 1, points.end());</div>
<div class="line"><a id="l01133" name="l01133"></a><span class="lineno"> 1133</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;future_points size: &quot;</span>&lt;&lt; future_points.size());</div>
<div class="line"><a id="l01134" name="l01134"></a><span class="lineno"> 1134</span> </div>
<div class="line"><a id="l01135" name="l01135"></a><span class="lineno"> 1135</span>            <span class="comment">//Compute yaw values from original trajectory.</span></div>
<div class="line"><a id="l01136" name="l01136"></a><span class="lineno"> 1136</span>            std::vector&lt;lanelet::BasicPoint2d&gt; future_geom_points;</div>
<div class="line"><a id="l01137" name="l01137"></a><span class="lineno"> 1137</span>            std::vector&lt;double&gt; final_actual_speeds;</div>
<div class="line"><a id="l01138" name="l01138"></a><span class="lineno"> 1138</span>            <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a0f07faaac8c54cc485f2bb217097326e">split_point_speed_pairs</a>(future_points, &amp;future_geom_points, &amp;final_actual_speeds);</div>
<div class="line"><a id="l01139" name="l01139"></a><span class="lineno"> 1139</span> </div>
<div class="line"><a id="l01140" name="l01140"></a><span class="lineno"> 1140</span>            std::unique_ptr&lt;smoothing::SplineI&gt; fit_curve = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">compute_fit</a>(future_geom_points);</div>
<div class="line"><a id="l01141" name="l01141"></a><span class="lineno"> 1141</span>            <span class="keywordflow">if</span>(!fit_curve){</div>
<div class="line"><a id="l01142" name="l01142"></a><span class="lineno"> 1142</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Could not fit a spline curve along the given trajectory!&quot;</span>);</div>
<div class="line"><a id="l01143" name="l01143"></a><span class="lineno"> 1143</span>            }</div>
<div class="line"><a id="l01144" name="l01144"></a><span class="lineno"> 1144</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got fit&quot;</span>);</div>
<div class="line"><a id="l01145" name="l01145"></a><span class="lineno"> 1145</span>            std::vector&lt;lanelet::BasicPoint2d&gt; all_sampling_points;</div>
<div class="line"><a id="l01146" name="l01146"></a><span class="lineno"> 1146</span>            all_sampling_points.reserve(1 + future_geom_points.size() * 2);</div>
<div class="line"><a id="l01147" name="l01147"></a><span class="lineno"> 1147</span> </div>
<div class="line"><a id="l01148" name="l01148"></a><span class="lineno"> 1148</span>            lanelet::BasicPoint2d current_vehicle_point(state.x_pos_global, state.y_pos_global);</div>
<div class="line"><a id="l01149" name="l01149"></a><span class="lineno"> 1149</span> </div>
<div class="line"><a id="l01150" name="l01150"></a><span class="lineno"> 1150</span>            future_geom_points.insert(future_geom_points.begin(),</div>
<div class="line"><a id="l01151" name="l01151"></a><span class="lineno"> 1151</span>                                       current_vehicle_point); <span class="comment">// Add current vehicle position to front of future geometry points</span></div>
<div class="line"><a id="l01152" name="l01152"></a><span class="lineno"> 1152</span> </div>
<div class="line"><a id="l01153" name="l01153"></a><span class="lineno"> 1153</span>            final_actual_speeds.insert(final_actual_speeds.begin(), state.longitudinal_vel);</div>
<div class="line"><a id="l01154" name="l01154"></a><span class="lineno"> 1154</span> </div>
<div class="line"><a id="l01155" name="l01155"></a><span class="lineno"> 1155</span>            <span class="comment">//Compute points to local downtracks</span></div>
<div class="line"><a id="l01156" name="l01156"></a><span class="lineno"> 1156</span>            std::vector&lt;double&gt; downtracks = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a>(future_geom_points);</div>
<div class="line"><a id="l01157" name="l01157"></a><span class="lineno"> 1157</span> </div>
<div class="line"><a id="l01158" name="l01158"></a><span class="lineno"> 1158</span>            <span class="keyword">auto</span> total_step_along_curve = <span class="keyword">static_cast&lt;</span><span class="keywordtype">int</span><span class="keyword">&gt;</span>(downtracks.back() /detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aed01f5b534f9dc52cc74022c71e2fa3c">curve_resample_step_size</a>);</div>
<div class="line"><a id="l01159" name="l01159"></a><span class="lineno"> 1159</span> </div>
<div class="line"><a id="l01160" name="l01160"></a><span class="lineno"> 1160</span>            <span class="keywordtype">double</span> scaled_steps_along_curve = 0.0; <span class="comment">//from 0 (start) to 1 (end) for the whole trajectory</span></div>
<div class="line"><a id="l01161" name="l01161"></a><span class="lineno"> 1161</span> </div>
<div class="line"><a id="l01162" name="l01162"></a><span class="lineno"> 1162</span>            <span class="keywordflow">for</span>(<span class="keywordtype">int</span> steps_along_curve = 0; steps_along_curve &lt; total_step_along_curve; steps_along_curve++){</div>
<div class="line"><a id="l01163" name="l01163"></a><span class="lineno"> 1163</span>                lanelet::BasicPoint2d p = (*fit_curve)(scaled_steps_along_curve);</div>
<div class="line"><a id="l01164" name="l01164"></a><span class="lineno"> 1164</span> </div>
<div class="line"><a id="l01165" name="l01165"></a><span class="lineno"> 1165</span>                all_sampling_points.push_back(p);</div>
<div class="line"><a id="l01166" name="l01166"></a><span class="lineno"> 1166</span> </div>
<div class="line"><a id="l01167" name="l01167"></a><span class="lineno"> 1167</span>                scaled_steps_along_curve += 1.0 / total_step_along_curve;</div>
<div class="line"><a id="l01168" name="l01168"></a><span class="lineno"> 1168</span>            }</div>
<div class="line"><a id="l01169" name="l01169"></a><span class="lineno"> 1169</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Got sampled points with size:&quot;</span> &lt;&lt; all_sampling_points.size());</div>
<div class="line"><a id="l01170" name="l01170"></a><span class="lineno"> 1170</span> </div>
<div class="line"><a id="l01171" name="l01171"></a><span class="lineno"> 1171</span>            std::vector&lt;double&gt; final_yaw_values = <a class="code hl_function" href="namespacecarma__wm_1_1geometry.html#ad8a3ee0bf06f85a6e7a8b5097251da2b">carma_wm::geometry::compute_tangent_orientations</a>(future_geom_points);</div>
<div class="line"><a id="l01172" name="l01172"></a><span class="lineno"> 1172</span>            <span class="keywordflow">if</span>(final_yaw_values.size() &gt; 0) {</div>
<div class="line"><a id="l01173" name="l01173"></a><span class="lineno"> 1173</span>                final_yaw_values[0] = state.orientation; <span class="comment">// Set the initial yaw value based on the initial state</span></div>
<div class="line"><a id="l01174" name="l01174"></a><span class="lineno"> 1174</span>            }</div>
<div class="line"><a id="l01175" name="l01175"></a><span class="lineno"> 1175</span> </div>
<div class="line"><a id="l01176" name="l01176"></a><span class="lineno"> 1176</span>            final_actual_speeds = <a class="code hl_function" href="namespacebasic__autonomy_1_1smoothing.html#afb726e75a21ada8efa3ca5561ffc9984">smoothing::moving_average_filter</a>(final_actual_speeds, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4a883bd5094bdc768c05d0c3a751f219">speed_moving_average_window_size</a>);</div>
<div class="line"><a id="l01177" name="l01177"></a><span class="lineno"> 1177</span> </div>
<div class="line"><a id="l01178" name="l01178"></a><span class="lineno"> 1178</span>            <span class="comment">//Convert speeds to time</span></div>
<div class="line"><a id="l01179" name="l01179"></a><span class="lineno"> 1179</span>            std::vector&lt;double&gt; times;</div>
<div class="line"><a id="l01180" name="l01180"></a><span class="lineno"> 1180</span>            trajectory_utils::conversions::speed_to_time(downtracks, final_actual_speeds, &amp;times);</div>
<div class="line"><a id="l01181" name="l01181"></a><span class="lineno"> 1181</span> </div>
<div class="line"><a id="l01182" name="l01182"></a><span class="lineno"> 1182</span>            <span class="comment">//Remove extra points</span></div>
<div class="line"><a id="l01183" name="l01183"></a><span class="lineno"> 1183</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Before removing extra buffer points, future_geom_points.size()&quot;</span>&lt;&lt; future_geom_points.size());</div>
<div class="line"><a id="l01184" name="l01184"></a><span class="lineno"> 1184</span>            <span class="keywordtype">int</span> end_dist_pt_index = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">get_nearest_index_by_downtrack</a>(future_geom_points, wm, ending_state_before_buffer);</div>
<div class="line"><a id="l01185" name="l01185"></a><span class="lineno"> 1185</span>            future_geom_points.resize(end_dist_pt_index + 1);</div>
<div class="line"><a id="l01186" name="l01186"></a><span class="lineno"> 1186</span>            times.resize(end_dist_pt_index + 1);</div>
<div class="line"><a id="l01187" name="l01187"></a><span class="lineno"> 1187</span>            final_yaw_values.resize(end_dist_pt_index + 1);</div>
<div class="line"><a id="l01188" name="l01188"></a><span class="lineno"> 1188</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;After removing extra buffer points, future_geom_points.size():&quot;</span>&lt;&lt; future_geom_points.size());</div>
<div class="line"><a id="l01189" name="l01189"></a><span class="lineno"> 1189</span> </div>
<div class="line"><a id="l01190" name="l01190"></a><span class="lineno"> 1190</span>            std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; traj_points =</div>
<div class="line"><a id="l01191" name="l01191"></a><span class="lineno"> 1191</span>                <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">trajectory_from_points_times_orientations</a>(future_geom_points, times, final_yaw_values, state_time, detailed_config.<a class="code hl_variable" href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a89ca36377e20e514abc609c5bd65a941">desired_controller_plugin</a>);</div>
<div class="line"><a id="l01192" name="l01192"></a><span class="lineno"> 1192</span> </div>
<div class="line"><a id="l01193" name="l01193"></a><span class="lineno"> 1193</span>            <span class="keywordflow">return</span> traj_points;</div>
<div class="line"><a id="l01194" name="l01194"></a><span class="lineno"> 1194</span>        }</div>
<div class="line"><a id="l01195" name="l01195"></a><span class="lineno"> 1195</span> </div>
<div class="line"><a id="l01196" name="l01196"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#aef0a6b216ad0be7289773e54843f747b"> 1196</a></span>        autoware_auto_msgs::msg::Trajectory <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#aef0a6b216ad0be7289773e54843f747b">process_trajectory_plan</a>(<span class="keyword">const</span> carma_planning_msgs::msg::TrajectoryPlan&amp; tp, <span class="keywordtype">double</span> vehicle_response_lag )</div>
<div class="line"><a id="l01197" name="l01197"></a><span class="lineno"> 1197</span>        {</div>
<div class="line"><a id="l01198" name="l01198"></a><span class="lineno"> 1198</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Processing latest TrajectoryPlan message&quot;</span>);</div>
<div class="line"><a id="l01199" name="l01199"></a><span class="lineno"> 1199</span> </div>
<div class="line"><a id="l01200" name="l01200"></a><span class="lineno"> 1200</span>            std::vector&lt;double&gt; times;</div>
<div class="line"><a id="l01201" name="l01201"></a><span class="lineno"> 1201</span>            std::vector&lt;double&gt; downtracks;</div>
<div class="line"><a id="l01202" name="l01202"></a><span class="lineno"> 1202</span> </div>
<div class="line"><a id="l01203" name="l01203"></a><span class="lineno"> 1203</span>            std::vector&lt;carma_planning_msgs::msg::TrajectoryPlanPoint&gt; trajectory_points = tp.trajectory_points;</div>
<div class="line"><a id="l01204" name="l01204"></a><span class="lineno"> 1204</span> </div>
<div class="line"><a id="l01205" name="l01205"></a><span class="lineno"> 1205</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Original Trajectory size:&quot;</span>&lt;&lt;trajectory_points.size());</div>
<div class="line"><a id="l01206" name="l01206"></a><span class="lineno"> 1206</span> </div>
<div class="line"><a id="l01207" name="l01207"></a><span class="lineno"> 1207</span> </div>
<div class="line"><a id="l01208" name="l01208"></a><span class="lineno"> 1208</span>            trajectory_utils::conversions::trajectory_to_downtrack_time(trajectory_points, &amp;downtracks, &amp;times);</div>
<div class="line"><a id="l01209" name="l01209"></a><span class="lineno"> 1209</span> </div>
<div class="line"><a id="l01210" name="l01210"></a><span class="lineno"> 1210</span>            <span class="comment">//detect stopping case</span></div>
<div class="line"><a id="l01211" name="l01211"></a><span class="lineno"> 1211</span>            <span class="keywordtype">size_t</span> stopping_index = 0;</div>
<div class="line"><a id="l01212" name="l01212"></a><span class="lineno"> 1212</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; times.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l01213" name="l01213"></a><span class="lineno"> 1213</span>            {</div>
<div class="line"><a id="l01214" name="l01214"></a><span class="lineno"> 1214</span>                <span class="keywordflow">if</span> (times[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] == times[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> - 1]) <span class="comment">//if exactly same, it is stopping case</span></div>
<div class="line"><a id="l01215" name="l01215"></a><span class="lineno"> 1215</span>                {</div>
<div class="line"><a id="l01216" name="l01216"></a><span class="lineno"> 1216</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Detected a stopping case where times is exactly equal: &quot;</span> &lt;&lt; times[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>-1]);</div>
<div class="line"><a id="l01217" name="l01217"></a><span class="lineno"> 1217</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;And index of that is: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt;&lt; <span class="stringliteral">&quot;, where size is: &quot;</span> &lt;&lt; times.size());</div>
<div class="line"><a id="l01218" name="l01218"></a><span class="lineno"> 1218</span>                    stopping_index = <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>;</div>
<div class="line"><a id="l01219" name="l01219"></a><span class="lineno"> 1219</span>                    <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l01220" name="l01220"></a><span class="lineno"> 1220</span>                }</div>
<div class="line"><a id="l01221" name="l01221"></a><span class="lineno"> 1221</span>            }</div>
<div class="line"><a id="l01222" name="l01222"></a><span class="lineno"> 1222</span> </div>
<div class="line"><a id="l01223" name="l01223"></a><span class="lineno"> 1223</span>            std::vector&lt;double&gt; speeds;</div>
<div class="line"><a id="l01224" name="l01224"></a><span class="lineno"> 1224</span>            <span class="keywordflow">try</span></div>
<div class="line"><a id="l01225" name="l01225"></a><span class="lineno"> 1225</span>            {</div>
<div class="line"><a id="l01226" name="l01226"></a><span class="lineno"> 1226</span>                trajectory_utils::conversions::time_to_speed(downtracks, times, tp.initial_longitudinal_velocity, &amp;speeds);</div>
<div class="line"><a id="l01227" name="l01227"></a><span class="lineno"> 1227</span>            }</div>
<div class="line"><a id="l01228" name="l01228"></a><span class="lineno"> 1228</span>            <span class="keywordflow">catch</span>(<span class="keyword">const</span> std::runtime_error&amp; error)</div>
<div class="line"><a id="l01229" name="l01229"></a><span class="lineno"> 1229</span>            {</div>
<div class="line"><a id="l01230" name="l01230"></a><span class="lineno"> 1230</span>                <span class="comment">// This can only happen if there was negative speed in trajectory generation which usually happens when intending to stop.</span></div>
<div class="line"><a id="l01231" name="l01231"></a><span class="lineno"> 1231</span>                <span class="comment">// The plugin is catching that error and logging it for the user to correct the origin plugin&#39;s logic, but continues</span></div>
<div class="line"><a id="l01232" name="l01232"></a><span class="lineno"> 1232</span>                <span class="comment">// the operation by forcing the negative values to be 0, which is the intention usually.</span></div>
<div class="line"><a id="l01233" name="l01233"></a><span class="lineno"> 1233</span>                RCLCPP_WARN_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Detected a negative speed from &lt;point,time&gt; to &lt;point,speed&gt; trajectory conversion with error: &quot;</span></div>
<div class="line"><a id="l01234" name="l01234"></a><span class="lineno"> 1234</span>                    &lt;&lt; error.what() &lt;&lt; <span class="stringliteral">&quot;. Replacing the negative speed with 0.0 speed, but please revisit the trajectory logic. &quot;</span></div>
<div class="line"><a id="l01235" name="l01235"></a><span class="lineno"> 1235</span>                    <span class="stringliteral">&quot;Responsible plugin is: &quot;</span> &lt;&lt; trajectory_points[std::find(speeds.begin(), speeds.end(), 0.0) - speeds.begin()].planner_plugin_name);</div>
<div class="line"><a id="l01236" name="l01236"></a><span class="lineno"> 1236</span>            }</div>
<div class="line"><a id="l01237" name="l01237"></a><span class="lineno"> 1237</span> </div>
<div class="line"><a id="l01238" name="l01238"></a><span class="lineno"> 1238</span>            <span class="keywordflow">if</span> (speeds.size() != trajectory_points.size())</div>
<div class="line"><a id="l01239" name="l01239"></a><span class="lineno"> 1239</span>            {</div>
<div class="line"><a id="l01240" name="l01240"></a><span class="lineno"> 1240</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Speeds and trajectory points sizes do not match&quot;</span>);</div>
<div class="line"><a id="l01241" name="l01241"></a><span class="lineno"> 1241</span>            }</div>
<div class="line"><a id="l01242" name="l01242"></a><span class="lineno"> 1242</span> </div>
<div class="line"><a id="l01243" name="l01243"></a><span class="lineno"> 1243</span>            <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; speeds.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++) { <span class="comment">// Ensure 0 is min speed</span></div>
<div class="line"><a id="l01244" name="l01244"></a><span class="lineno"> 1244</span>                <span class="keywordflow">if</span> (stopping_index != 0 &amp;&amp; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt;= stopping_index - 1)</div>
<div class="line"><a id="l01245" name="l01245"></a><span class="lineno"> 1245</span>                {</div>
<div class="line"><a id="l01246" name="l01246"></a><span class="lineno"> 1246</span>                    RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Made it to 0, i: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><a id="l01247" name="l01247"></a><span class="lineno"> 1247</span> </div>
<div class="line"><a id="l01248" name="l01248"></a><span class="lineno"> 1248</span>                    speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] = 0.0;  <span class="comment">//stopping case</span></div>
<div class="line"><a id="l01249" name="l01249"></a><span class="lineno"> 1249</span>                }</div>
<div class="line"><a id="l01250" name="l01250"></a><span class="lineno"> 1250</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01251" name="l01251"></a><span class="lineno"> 1251</span>                {</div>
<div class="line"><a id="l01252" name="l01252"></a><span class="lineno"> 1252</span>                    speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] = std::max(0.0, speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]);</div>
<div class="line"><a id="l01253" name="l01253"></a><span class="lineno"> 1253</span>                }</div>
<div class="line"><a id="l01254" name="l01254"></a><span class="lineno"> 1254</span>            }</div>
<div class="line"><a id="l01255" name="l01255"></a><span class="lineno"> 1255</span> </div>
<div class="line"><a id="l01256" name="l01256"></a><span class="lineno"> 1256</span>            std::vector&lt;double&gt; lag_speeds;</div>
<div class="line"><a id="l01257" name="l01257"></a><span class="lineno"> 1257</span>            lag_speeds = <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a3c66a834de5e4a066c8c9011e25f8e71">apply_response_lag</a>(speeds, downtracks, vehicle_response_lag); <span class="comment">// This call requires that the first speed point be current speed to work as expected</span></div>
<div class="line"><a id="l01258" name="l01258"></a><span class="lineno"> 1258</span> </div>
<div class="line"><a id="l01259" name="l01259"></a><span class="lineno"> 1259</span>            autoware_auto_msgs::msg::Trajectory autoware_trajectory;</div>
<div class="line"><a id="l01260" name="l01260"></a><span class="lineno"> 1260</span>            autoware_trajectory.header = tp.header;</div>
<div class="line"><a id="l01261" name="l01261"></a><span class="lineno"> 1261</span>            RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;size: &quot;</span> &lt;&lt; trajectory_points.size());</div>
<div class="line"><a id="l01262" name="l01262"></a><span class="lineno"> 1262</span> </div>
<div class="line"><a id="l01263" name="l01263"></a><span class="lineno"> 1263</span>            <span class="keyword">auto</span> max_size = std::min(99, (<span class="keywordtype">int</span>)trajectory_points.size());  <span class="comment">//NOTE: more than this size autoware auto raises exception with &quot;Exceeded upper bound while in ACTIVE state.&quot;</span></div>
<div class="line"><a id="l01264" name="l01264"></a><span class="lineno"> 1264</span>                                                                            <span class="comment">//large portion of the points are not needed anyways</span></div>
<div class="line"><a id="l01265" name="l01265"></a><span class="lineno"> 1265</span>            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; max_size; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++)</div>
<div class="line"><a id="l01266" name="l01266"></a><span class="lineno"> 1266</span>            {</div>
<div class="line"><a id="l01267" name="l01267"></a><span class="lineno"> 1267</span>                autoware_auto_msgs::msg::TrajectoryPoint autoware_point;</div>
<div class="line"><a id="l01268" name="l01268"></a><span class="lineno"> 1268</span> </div>
<div class="line"><a id="l01269" name="l01269"></a><span class="lineno"> 1269</span>                autoware_point.x = trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].x;</div>
<div class="line"><a id="l01270" name="l01270"></a><span class="lineno"> 1270</span>                autoware_point.y = trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].y;</div>
<div class="line"><a id="l01271" name="l01271"></a><span class="lineno"> 1271</span>                autoware_point.longitudinal_velocity_mps = lag_speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><a id="l01272" name="l01272"></a><span class="lineno"> 1272</span>                <span class="keywordtype">double</span> yaw = 0.0;</div>
<div class="line"><a id="l01273" name="l01273"></a><span class="lineno"> 1273</span>                <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>&lt; max_size-1)</div>
<div class="line"><a id="l01274" name="l01274"></a><span class="lineno"> 1274</span>                {</div>
<div class="line"><a id="l01275" name="l01275"></a><span class="lineno"> 1275</span>                    yaw = std::atan2(trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>+1].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a> - trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a>, trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>+1].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a> - trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>);</div>
<div class="line"><a id="l01276" name="l01276"></a><span class="lineno"> 1276</span> </div>
<div class="line"><a id="l01277" name="l01277"></a><span class="lineno"> 1277</span>                }</div>
<div class="line"><a id="l01278" name="l01278"></a><span class="lineno"> 1278</span>                <span class="keywordflow">else</span></div>
<div class="line"><a id="l01279" name="l01279"></a><span class="lineno"> 1279</span>                {</div>
<div class="line"><a id="l01280" name="l01280"></a><span class="lineno"> 1280</span>                    yaw = std::atan2(trajectory_points[max_size-1].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a> - trajectory_points[max_size-2].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a>, trajectory_points[max_size-1].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a> - trajectory_points[max_size-2].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a>);</div>
<div class="line"><a id="l01281" name="l01281"></a><span class="lineno"> 1281</span>                    <span class="comment">// last point in the trajectory will have yaw value of its previous point to avoid sudden steering in some conditions</span></div>
<div class="line"><a id="l01282" name="l01282"></a><span class="lineno"> 1282</span>                }</div>
<div class="line"><a id="l01283" name="l01283"></a><span class="lineno"> 1283</span>                autoware_point.heading.real = std::cos(yaw/2);</div>
<div class="line"><a id="l01284" name="l01284"></a><span class="lineno"> 1284</span>                autoware_point.heading.imag = std::sin(yaw/2);</div>
<div class="line"><a id="l01285" name="l01285"></a><span class="lineno"> 1285</span> </div>
<div class="line"><a id="l01286" name="l01286"></a><span class="lineno"> 1286</span>                autoware_point.time_from_start = rclcpp::Duration(times[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] * 1e9);</div>
<div class="line"><a id="l01287" name="l01287"></a><span class="lineno"> 1287</span>                RCLCPP_DEBUG_STREAM(rclcpp::get_logger(<a class="code hl_variable" href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">BASIC_AUTONOMY_LOGGER</a>), <span class="stringliteral">&quot;Setting waypoint idx: &quot;</span> &lt;&lt; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt;&lt;<span class="stringliteral">&quot;, with planner: &lt;&lt; &quot;</span> &lt;&lt; trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].planner_plugin_name &lt;&lt; <span class="stringliteral">&quot;, x: &quot;</span> &lt;&lt; trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">x</a> &lt;&lt;</div>
<div class="line"><a id="l01288" name="l01288"></a><span class="lineno"> 1288</span>                                        <span class="stringliteral">&quot;, y: &quot;</span> &lt;&lt; trajectory_points[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>].<a class="code hl_variable" href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">y</a> &lt;&lt;</div>
<div class="line"><a id="l01289" name="l01289"></a><span class="lineno"> 1289</span>                                        <span class="stringliteral">&quot;, speed: &quot;</span> &lt;&lt; lag_speeds[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>]* 2.23694 &lt;&lt; <span class="stringliteral">&quot;mph&quot;</span>);</div>
<div class="line"><a id="l01290" name="l01290"></a><span class="lineno"> 1290</span>                autoware_trajectory.points.push_back(autoware_point);</div>
<div class="line"><a id="l01291" name="l01291"></a><span class="lineno"> 1291</span>            }</div>
<div class="line"><a id="l01292" name="l01292"></a><span class="lineno"> 1292</span> </div>
<div class="line"><a id="l01293" name="l01293"></a><span class="lineno"> 1293</span>            <span class="keywordflow">return</span> autoware_trajectory;</div>
<div class="line"><a id="l01294" name="l01294"></a><span class="lineno"> 1294</span>        }</div>
<div class="line"><a id="l01295" name="l01295"></a><span class="lineno"> 1295</span> </div>
<div class="line"><a id="l01296" name="l01296"></a><span class="lineno"> 1296</span> </div>
<div class="line"><a id="l01297" name="l01297"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a3c66a834de5e4a066c8c9011e25f8e71"> 1297</a></span>        std::vector&lt;double&gt; <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a3c66a834de5e4a066c8c9011e25f8e71">apply_response_lag</a>(<span class="keyword">const</span> std::vector&lt;double&gt;&amp; speeds, <span class="keyword">const</span> std::vector&lt;double&gt; downtracks, <span class="keywordtype">double</span> response_lag)</div>
<div class="line"><a id="l01298" name="l01298"></a><span class="lineno"> 1298</span>        { <span class="comment">// Note first speed is assumed to be vehicle speed</span></div>
<div class="line"><a id="l01299" name="l01299"></a><span class="lineno"> 1299</span>            <span class="keywordflow">if</span> (speeds.size() != downtracks.size()) {</div>
<div class="line"><a id="l01300" name="l01300"></a><span class="lineno"> 1300</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Speed list and downtrack list are not the same size.&quot;</span>);</div>
<div class="line"><a id="l01301" name="l01301"></a><span class="lineno"> 1301</span>            }</div>
<div class="line"><a id="l01302" name="l01302"></a><span class="lineno"> 1302</span> </div>
<div class="line"><a id="l01303" name="l01303"></a><span class="lineno"> 1303</span>            std::vector&lt;double&gt; output;</div>
<div class="line"><a id="l01304" name="l01304"></a><span class="lineno"> 1304</span>            <span class="keywordflow">if</span> (speeds.empty()) {</div>
<div class="line"><a id="l01305" name="l01305"></a><span class="lineno"> 1305</span>                <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l01306" name="l01306"></a><span class="lineno"> 1306</span>            }</div>
<div class="line"><a id="l01307" name="l01307"></a><span class="lineno"> 1307</span> </div>
<div class="line"><a id="l01308" name="l01308"></a><span class="lineno"> 1308</span>            <span class="keywordtype">double</span> lookahead_distance = speeds[0] * response_lag;</div>
<div class="line"><a id="l01309" name="l01309"></a><span class="lineno"> 1309</span> </div>
<div class="line"><a id="l01310" name="l01310"></a><span class="lineno"> 1310</span>            <span class="keywordtype">double</span> downtrack_cutoff = downtracks[0] + lookahead_distance;</div>
<div class="line"><a id="l01311" name="l01311"></a><span class="lineno"> 1311</span>            <span class="keywordtype">size_t</span> lookahead_count = std::lower_bound(downtracks.begin(),downtracks.end(), downtrack_cutoff) - downtracks.begin(); <span class="comment">// Use binary search to find lower bound cutoff point</span></div>
<div class="line"><a id="l01312" name="l01312"></a><span class="lineno"> 1312</span>            output = trajectory_utils::shift_by_lookahead(speeds, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) lookahead_count);</div>
<div class="line"><a id="l01313" name="l01313"></a><span class="lineno"> 1313</span>            <span class="keywordflow">return</span> output;</div>
<div class="line"><a id="l01314" name="l01314"></a><span class="lineno"> 1314</span>        }</div>
<div class="line"><a id="l01315" name="l01315"></a><span class="lineno"> 1315</span> </div>
<div class="line"><a id="l01316" name="l01316"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9a8cf0ed437bc3b0eb8008bd74782aa1"> 1316</a></span>        <span class="keywordtype">bool</span> <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9a8cf0ed437bc3b0eb8008bd74782aa1">is_valid_yield_plan</a>(<span class="keyword">const</span> std::shared_ptr&lt;carma_ros2_utils::CarmaLifecycleNode&gt;&amp; node_handler, <span class="keyword">const</span> carma_planning_msgs::msg::TrajectoryPlan&amp; yield_plan)</div>
<div class="line"><a id="l01317" name="l01317"></a><span class="lineno"> 1317</span>        {</div>
<div class="line"><a id="l01318" name="l01318"></a><span class="lineno"> 1318</span>            <span class="keywordflow">if</span> (yield_plan.trajectory_points.size() &lt; 2)</div>
<div class="line"><a id="l01319" name="l01319"></a><span class="lineno"> 1319</span>            {</div>
<div class="line"><a id="l01320" name="l01320"></a><span class="lineno"> 1320</span>                RCLCPP_WARN(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Invalid Yield Trajectory&quot;</span>);</div>
<div class="line"><a id="l01321" name="l01321"></a><span class="lineno"> 1321</span>            }</div>
<div class="line"><a id="l01322" name="l01322"></a><span class="lineno"> 1322</span> </div>
<div class="line"><a id="l01323" name="l01323"></a><span class="lineno"> 1323</span>            RCLCPP_DEBUG_STREAM(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Yield Trajectory Time&quot;</span> &lt;&lt; rclcpp::Time(yield_plan.trajectory_points[0].target_time).seconds());</div>
<div class="line"><a id="l01324" name="l01324"></a><span class="lineno"> 1324</span>            RCLCPP_DEBUG_STREAM(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Now:&quot;</span> &lt;&lt; node_handler-&gt;now().seconds());</div>
<div class="line"><a id="l01325" name="l01325"></a><span class="lineno"> 1325</span> </div>
<div class="line"><a id="l01326" name="l01326"></a><span class="lineno"> 1326</span>            <span class="keywordflow">if</span> (rclcpp::Time(yield_plan.trajectory_points[0].target_time) + rclcpp::Duration(5.0, 0) &gt; node_handler-&gt;now())</div>
<div class="line"><a id="l01327" name="l01327"></a><span class="lineno"> 1327</span>            {</div>
<div class="line"><a id="l01328" name="l01328"></a><span class="lineno"> 1328</span>                <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l01329" name="l01329"></a><span class="lineno"> 1329</span>            }</div>
<div class="line"><a id="l01330" name="l01330"></a><span class="lineno"> 1330</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l01331" name="l01331"></a><span class="lineno"> 1331</span>            {</div>
<div class="line"><a id="l01332" name="l01332"></a><span class="lineno"> 1332</span>                RCLCPP_DEBUG(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Old Yield Trajectory&quot;</span>);</div>
<div class="line"><a id="l01333" name="l01333"></a><span class="lineno"> 1333</span>            }</div>
<div class="line"><a id="l01334" name="l01334"></a><span class="lineno"> 1334</span> </div>
<div class="line"><a id="l01335" name="l01335"></a><span class="lineno"> 1335</span>            <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l01336" name="l01336"></a><span class="lineno"> 1336</span>        }</div>
<div class="line"><a id="l01337" name="l01337"></a><span class="lineno"> 1337</span> </div>
<div class="line"><a id="l01338" name="l01338"></a><span class="lineno"><a class="line" href="namespacebasic__autonomy_1_1waypoint__generation.html#a2de71503d10ed9a644bafd31fd102081"> 1338</a></span>        carma_planning_msgs::srv::PlanTrajectory::Response::SharedPtr <a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a2de71503d10ed9a644bafd31fd102081">modify_trajectory_to_yield_to_obstacles</a>(</div>
<div class="line"><a id="l01339" name="l01339"></a><span class="lineno"> 1339</span>            <span class="keyword">const</span> std::shared_ptr&lt;carma_ros2_utils::CarmaLifecycleNode&gt;&amp; node_handler,</div>
<div class="line"><a id="l01340" name="l01340"></a><span class="lineno"> 1340</span>            <span class="keyword">const</span> carma_planning_msgs::srv::PlanTrajectory::Request::SharedPtr&amp; req,</div>
<div class="line"><a id="l01341" name="l01341"></a><span class="lineno"> 1341</span>            <span class="keyword">const</span> carma_planning_msgs::srv::PlanTrajectory::Response::SharedPtr&amp; resp,</div>
<div class="line"><a id="l01342" name="l01342"></a><span class="lineno"> 1342</span>            <span class="keyword">const</span> carma_ros2_utils::ClientPtr&lt;carma_planning_msgs::srv::PlanTrajectory&gt;&amp; yield_client,</div>
<div class="line"><a id="l01343" name="l01343"></a><span class="lineno"> 1343</span>            <span class="keywordtype">int</span> yield_plugin_service_call_timeout)</div>
<div class="line"><a id="l01344" name="l01344"></a><span class="lineno"> 1344</span>        {</div>
<div class="line"><a id="l01345" name="l01345"></a><span class="lineno"> 1345</span>            RCLCPP_DEBUG(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Activate Object Avoidance&quot;</span>);</div>
<div class="line"><a id="l01346" name="l01346"></a><span class="lineno"> 1346</span> </div>
<div class="line"><a id="l01347" name="l01347"></a><span class="lineno"> 1347</span>            <span class="keywordflow">if</span> (!yield_client || !yield_client-&gt;service_is_ready())</div>
<div class="line"><a id="l01348" name="l01348"></a><span class="lineno"> 1348</span>            {</div>
<div class="line"><a id="l01349" name="l01349"></a><span class="lineno"> 1349</span>                <span class="keywordflow">throw</span> std::runtime_error(<span class="stringliteral">&quot;Yield Client is not set or unavailable after configuration state of lifecycle&quot;</span>);</div>
<div class="line"><a id="l01350" name="l01350"></a><span class="lineno"> 1350</span>            }</div>
<div class="line"><a id="l01351" name="l01351"></a><span class="lineno"> 1351</span> </div>
<div class="line"><a id="l01352" name="l01352"></a><span class="lineno"> 1352</span>            RCLCPP_DEBUG(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Yield Client is valid&quot;</span>);</div>
<div class="line"><a id="l01353" name="l01353"></a><span class="lineno"> 1353</span> </div>
<div class="line"><a id="l01354" name="l01354"></a><span class="lineno"> 1354</span>            <span class="keyword">auto</span> yield_srv = std::make_shared&lt;carma_planning_msgs::srv::PlanTrajectory::Request&gt;();</div>
<div class="line"><a id="l01355" name="l01355"></a><span class="lineno"> 1355</span>            yield_srv-&gt;initial_trajectory_plan = resp-&gt;trajectory_plan;</div>
<div class="line"><a id="l01356" name="l01356"></a><span class="lineno"> 1356</span>            yield_srv-&gt;vehicle_state = req-&gt;vehicle_state;</div>
<div class="line"><a id="l01357" name="l01357"></a><span class="lineno"> 1357</span> </div>
<div class="line"><a id="l01358" name="l01358"></a><span class="lineno"> 1358</span>            <span class="keyword">auto</span> yield_resp = yield_client-&gt;async_send_request(yield_srv);</div>
<div class="line"><a id="l01359" name="l01359"></a><span class="lineno"> 1359</span> </div>
<div class="line"><a id="l01360" name="l01360"></a><span class="lineno"> 1360</span>            <span class="keyword">auto</span> future_status = yield_resp.wait_for(std::chrono::milliseconds(yield_plugin_service_call_timeout));</div>
<div class="line"><a id="l01361" name="l01361"></a><span class="lineno"> 1361</span> </div>
<div class="line"><a id="l01362" name="l01362"></a><span class="lineno"> 1362</span>            <span class="keywordflow">if</span> (future_status != std::future_status::ready)</div>
<div class="line"><a id="l01363" name="l01363"></a><span class="lineno"> 1363</span>            {</div>
<div class="line"><a id="l01364" name="l01364"></a><span class="lineno"> 1364</span>                <span class="comment">// Sometimes the yield plugin&#39;s service call may be unsuccessful due to its computationally expensive logic.</span></div>
<div class="line"><a id="l01365" name="l01365"></a><span class="lineno"> 1365</span>                <span class="comment">// However, consecutive calls can be successful, so return original trajectory for now</span></div>
<div class="line"><a id="l01366" name="l01366"></a><span class="lineno"> 1366</span>                RCLCPP_WARN(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Service request to yield plugin timed out waiting on a reply from the service server&quot;</span>);</div>
<div class="line"><a id="l01367" name="l01367"></a><span class="lineno"> 1367</span>                <span class="keywordflow">return</span> resp;</div>
<div class="line"><a id="l01368" name="l01368"></a><span class="lineno"> 1368</span>            }</div>
<div class="line"><a id="l01369" name="l01369"></a><span class="lineno"> 1369</span> </div>
<div class="line"><a id="l01370" name="l01370"></a><span class="lineno"> 1370</span>            RCLCPP_DEBUG(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Received Traj from Yield&quot;</span>);</div>
<div class="line"><a id="l01371" name="l01371"></a><span class="lineno"> 1371</span>            carma_planning_msgs::msg::TrajectoryPlan yield_plan = yield_resp.get()-&gt;trajectory_plan;</div>
<div class="line"><a id="l01372" name="l01372"></a><span class="lineno"> 1372</span>            <span class="keywordflow">if</span> (<a class="code hl_function" href="namespacebasic__autonomy_1_1waypoint__generation.html#a9a8cf0ed437bc3b0eb8008bd74782aa1">is_valid_yield_plan</a>(node_handler, yield_plan))</div>
<div class="line"><a id="l01373" name="l01373"></a><span class="lineno"> 1373</span>            {</div>
<div class="line"><a id="l01374" name="l01374"></a><span class="lineno"> 1374</span>                RCLCPP_DEBUG(node_handler-&gt;get_logger(), <span class="stringliteral">&quot;Yield trajectory validated&quot;</span>);</div>
<div class="line"><a id="l01375" name="l01375"></a><span class="lineno"> 1375</span>                resp-&gt;trajectory_plan = yield_plan;</div>
<div class="line"><a id="l01376" name="l01376"></a><span class="lineno"> 1376</span>            }</div>
<div class="line"><a id="l01377" name="l01377"></a><span class="lineno"> 1377</span>            <span class="keywordflow">else</span></div>
<div class="line"><a id="l01378" name="l01378"></a><span class="lineno"> 1378</span>            {</div>
<div class="line"><a id="l01379" name="l01379"></a><span class="lineno"> 1379</span>                <span class="keywordflow">throw</span> std::invalid_argument(<span class="stringliteral">&quot;Invalid Yield Trajectory&quot;</span>);</div>
<div class="line"><a id="l01380" name="l01380"></a><span class="lineno"> 1380</span>            }</div>
<div class="line"><a id="l01381" name="l01381"></a><span class="lineno"> 1381</span> </div>
<div class="line"><a id="l01382" name="l01382"></a><span class="lineno"> 1382</span>            <span class="keywordflow">return</span> resp;</div>
<div class="line"><a id="l01383" name="l01383"></a><span class="lineno"> 1383</span>        }</div>
<div class="line"><a id="l01384" name="l01384"></a><span class="lineno"> 1384</span> </div>
<div class="line"><a id="l01385" name="l01385"></a><span class="lineno"> 1385</span>    } <span class="comment">// namespace waypoint_generation</span></div>
<div class="line"><a id="l01386" name="l01386"></a><span class="lineno"> 1386</span> </div>
<div class="line"><a id="l01387" name="l01387"></a><span class="lineno"> 1387</span>} <span class="comment">// basic_autonomy</span></div>
<div class="ttc" id="aapproaching__emergency__vehicle__plugin__node_8hpp_html_a066f948508e087006568cb6c9b0674a7"><div class="ttname"><a href="approaching__emergency__vehicle__plugin__node_8hpp.html#a066f948508e087006568cb6c9b0674a7">GET_MANEUVER_PROPERTY</a></div><div class="ttdeci">#define GET_MANEUVER_PROPERTY(mvr, property)</div><div class="ttdoc">Macro definition to enable easier access to fields shared across the maneuver types.</div><div class="ttdef"><b>Definition:</b> <a href="approaching__emergency__vehicle__plugin__node_8hpp_source.html#l00054">approaching_emergency_vehicle_plugin_node.hpp:54</a></div></div>
<div class="ttc" id="abasic__autonomy_2include_2basic__autonomy_2log_2log_8hpp_html"><div class="ttname"><a href="basic__autonomy_2include_2basic__autonomy_2log_2log_8hpp.html">log.hpp</a></div></div>
<div class="ttc" id="aclassbasic__autonomy_1_1smoothing_1_1SplineI_html"><div class="ttname"><a href="classbasic__autonomy_1_1smoothing_1_1SplineI.html">basic_autonomy::smoothing::SplineI</a></div><div class="ttdoc">Interface to a spline interpolator that can be used to smoothly interpolate between points.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_2include_2basic__autonomy_2smoothing_2SplineI_8hpp_source.html#l00029">SplineI.hpp:30</a></div></div>
<div class="ttc" id="aclassbasic__autonomy_1_1smoothing_1_1SplineI_html_a6fb15e64df8a2591023ae18fba56606f"><div class="ttname"><a href="classbasic__autonomy_1_1smoothing_1_1SplineI.html#a6fb15e64df8a2591023ae18fba56606f">basic_autonomy::smoothing::SplineI::first_deriv</a></div><div class="ttdeci">virtual lanelet::BasicPoint2d first_deriv(double x) const =0</div><div class="ttdoc">Get the BasicPoint2d representing the first_deriv along the curve at t-th step.</div></div>
<div class="ttc" id="aclassbasic__autonomy_1_1smoothing_1_1SplineI_html_aae7724df9449ea357153c86bd2e327af"><div class="ttname"><a href="classbasic__autonomy_1_1smoothing_1_1SplineI.html#aae7724df9449ea357153c86bd2e327af">basic_autonomy::smoothing::SplineI::second_deriv</a></div><div class="ttdeci">virtual lanelet::BasicPoint2d second_deriv(double x) const =0</div><div class="ttdoc">Get the BasicPoint2d representing the first_deriv along the curve at t-th step.</div></div>
<div class="ttc" id="ahelper__functions_8hpp_html"><div class="ttname"><a href="helper__functions_8hpp.html">helper_functions.hpp</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1log_html_a54dc1b131f40912ecbf27ce0f42bc782"><div class="ttname"><a href="namespacebasic__autonomy_1_1log.html#a54dc1b131f40912ecbf27ce0f42bc782">basic_autonomy::log::printDoublesPerLineWithPrefix</a></div><div class="ttdeci">void printDoublesPerLineWithPrefix(const std::string &amp;prefix, const std::vector&lt; double &gt; &amp;values)</div><div class="ttdoc">Print a RCLCPP_DEBUG_STREAM for each value in values where the printed value is &lt;&lt; prefix &lt;&lt; value.</div><div class="ttdef"><b>Definition:</b> <a href="log_8cpp_source.html#l00045">log.cpp:45</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1log_html_a9123a8bedcfb34f1e6c1336f226956fb"><div class="ttname"><a href="namespacebasic__autonomy_1_1log.html#a9123a8bedcfb34f1e6c1336f226956fb">basic_autonomy::log::basicPointToStream</a></div><div class="ttdeci">std::string basicPointToStream(lanelet::BasicPoint2d point)</div><div class="ttdoc">Helper function to convert a lanelet::BasicPoint2d to a string.</div><div class="ttdef"><b>Definition:</b> <a href="log_8cpp_source.html#l00026">log.cpp:26</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1log_html_aa5d9aec52bb2d67d8b163be5d2366c8e"><div class="ttname"><a href="namespacebasic__autonomy_1_1log.html#aa5d9aec52bb2d67d8b163be5d2366c8e">basic_autonomy::log::pointSpeedPairToStream</a></div><div class="ttdeci">std::string pointSpeedPairToStream(waypoint_generation::PointSpeedPair point)</div><div class="ttdoc">Helper function to convert a PointSpeedPair to a string.</div><div class="ttdef"><b>Definition:</b> <a href="log_8cpp_source.html#l00035">log.cpp:35</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1log_html_abc6767d55d022e680ccd0d598eba5289"><div class="ttname"><a href="namespacebasic__autonomy_1_1log.html#abc6767d55d022e680ccd0d598eba5289">basic_autonomy::log::printDebugPerLine</a></div><div class="ttdeci">void printDebugPerLine(const std::vector&lt; T &gt; &amp;values, std::function&lt; std::string(T)&gt; func)</div><div class="ttdoc">Print a RCLCPP_DEBUG_STREAM for each value in values where the printed value is a string returned by ...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_2include_2basic__autonomy_2log_2log_8hpp_source.html#l00040">log.hpp:40</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1smoothing_html_afb726e75a21ada8efa3ca5561ffc9984"><div class="ttname"><a href="namespacebasic__autonomy_1_1smoothing.html#afb726e75a21ada8efa3ca5561ffc9984">basic_autonomy::smoothing::moving_average_filter</a></div><div class="ttdeci">std::vector&lt; double &gt; moving_average_filter(const std::vector&lt; double &gt; input, int window_size, bool ignore_first_point=true)</div><div class="ttdoc">Extremely simplie moving average filter.</div><div class="ttdef"><b>Definition:</b> <a href="filters_8cpp_source.html#l00024">filters.cpp:24</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a05408c147e288f4120ad1a8c90dd3241"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a05408c147e288f4120ad1a8c90dd3241">basic_autonomy::waypoint_generation::epsilon_</a></div><div class="ttdeci">const double epsilon_</div><div class="ttdef"><b>Definition:</b> <a href="helper__functions_8hpp_source.html#l00024">helper_functions.hpp:24</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a0f07faaac8c54cc485f2bb217097326e"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a0f07faaac8c54cc485f2bb217097326e">basic_autonomy::waypoint_generation::split_point_speed_pairs</a></div><div class="ttdeci">void split_point_speed_pairs(const std::vector&lt; PointSpeedPair &gt; &amp;points, std::vector&lt; lanelet::BasicPoint2d &gt; *basic_points, std::vector&lt; double &gt; *speeds)</div><div class="ttdoc">Helper method to split a list of PointSpeedPair into separate point and speed lists.</div><div class="ttdef"><b>Definition:</b> <a href="helper__functions_8cpp_source.html#l00092">helper_functions.cpp:92</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a11b8eae5903a23ecab69c2f814c1bcf8"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a11b8eae5903a23ecab69c2f814c1bcf8">basic_autonomy::waypoint_generation::compose_general_trajectory_config</a></div><div class="ttdeci">GeneralTrajConfig compose_general_trajectory_config(const std::string &amp;trajectory_type, int default_downsample_ratio, int turn_downsample_ratio)</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01109">basic_autonomy.cpp:1109</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a19cf5cf882789e1e9ed3e92d0105a8de"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a19cf5cf882789e1e9ed3e92d0105a8de">basic_autonomy::waypoint_generation::resample_linestring_pair_to_same_size</a></div><div class="ttdeci">std::vector&lt; std::vector&lt; lanelet::BasicPoint2d &gt; &gt; resample_linestring_pair_to_same_size(std::vector&lt; lanelet::BasicPoint2d &gt; &amp;line_1, std::vector&lt; lanelet::BasicPoint2d &gt; &amp;line_2)</div><div class="ttdoc">Resamples a pair of basicpoint2d lines to get lines of same number of points.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00482">basic_autonomy.cpp:482</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a2219ab96db87781023137bdb45af1ea2"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a2219ab96db87781023137bdb45af1ea2">basic_autonomy::waypoint_generation::create_lanechange_geometry</a></div><div class="ttdeci">std::vector&lt; lanelet::BasicPoint2d &gt; create_lanechange_geometry(lanelet::Id starting_lane_id, lanelet::Id ending_lane_id, double starting_downtrack, double ending_downtrack, const carma_wm::WorldModelConstPtr &amp;wm, int downsample_ratio, double buffer_ending_downtrack)</div><div class="ttdoc">Creates a vector of lane change points using parameters defined.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00319">basic_autonomy.cpp:319</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a2de71503d10ed9a644bafd31fd102081"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a2de71503d10ed9a644bafd31fd102081">basic_autonomy::waypoint_generation::modify_trajectory_to_yield_to_obstacles</a></div><div class="ttdeci">carma_planning_msgs::srv::PlanTrajectory::Response::SharedPtr modify_trajectory_to_yield_to_obstacles(const std::shared_ptr&lt; carma_ros2_utils::CarmaLifecycleNode &gt; &amp;node_handler, const carma_planning_msgs::srv::PlanTrajectory::Request::SharedPtr &amp;req, const carma_planning_msgs::srv::PlanTrajectory::Response::SharedPtr &amp;resp, const carma_ros2_utils::ClientPtr&lt; carma_planning_msgs::srv::PlanTrajectory &gt; &amp;yield_client, int yield_plugin_service_call_timeout)</div><div class="ttdoc">Applies a yield trajectory to the original trajectory set in response.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01338">basic_autonomy.cpp:1338</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a3c66a834de5e4a066c8c9011e25f8e71"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a3c66a834de5e4a066c8c9011e25f8e71">basic_autonomy::waypoint_generation::apply_response_lag</a></div><div class="ttdeci">std::vector&lt; double &gt; apply_response_lag(const std::vector&lt; double &gt; &amp;speeds, const std::vector&lt; double &gt; downtracks, double response_lag)</div><div class="ttdoc">Applies a specified response lag in seconds to the trajectory shifting the whole thing by the specifi...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01297">basic_autonomy.cpp:1297</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a40f0df33d30f775890f99bef7a685e33"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a40f0df33d30f775890f99bef7a685e33">basic_autonomy::waypoint_generation::BASIC_AUTONOMY_LOGGER</a></div><div class="ttdeci">static const std::string BASIC_AUTONOMY_LOGGER</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00062">basic_autonomy.hpp:62</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a741942c16ca54212b9adf3ddc2eea66d"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a741942c16ca54212b9adf3ddc2eea66d">basic_autonomy::waypoint_generation::compose_lanechange_trajectory_from_path</a></div><div class="ttdeci">std::vector&lt; carma_planning_msgs::msg::TrajectoryPlanPoint &gt; compose_lanechange_trajectory_from_path(const std::vector&lt; PointSpeedPair &gt; &amp;points, const carma_planning_msgs::msg::VehicleState &amp;state, const rclcpp::Time &amp;state_time, const carma_wm::WorldModelConstPtr &amp;wm, const carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, const DetailedTrajConfig &amp;detailed_config)</div><div class="ttdoc">Method converts a list of lanelet centerline points and current vehicle state into a usable list of t...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01124">basic_autonomy.cpp:1124</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a84a6c11da2d9736a8f277b6afd124100"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a84a6c11da2d9736a8f277b6afd124100">basic_autonomy::waypoint_generation::optimize_speed</a></div><div class="ttdeci">std::vector&lt; double &gt; optimize_speed(const std::vector&lt; double &gt; &amp;downtracks, const std::vector&lt; double &gt; &amp;curv_speeds, double accel_limit)</div><div class="ttdoc">Applies the longitudinal acceleration limit to each point's speed.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00699">basic_autonomy.cpp:699</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a8be61ccb69db73e2e70d5e59f88ce446"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a8be61ccb69db73e2e70d5e59f88ce446">basic_autonomy::waypoint_generation::compose_detailed_trajectory_config</a></div><div class="ttdeci">DetailedTrajConfig compose_detailed_trajectory_config(double trajectory_time_length, double curve_resample_step_size, double minimum_speed, double max_accel, double lateral_accel_limit, int speed_moving_average_window_size, int curvature_moving_average_window_size, double back_distance, double buffer_ending_downtrack, std::string desired_controller_plugin=&quot;default&quot;)</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01082">basic_autonomy.cpp:1082</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a924ac023f1b51e791ca1b61b9194f44a"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a924ac023f1b51e791ca1b61b9194f44a">basic_autonomy::waypoint_generation::get_nearest_point_index</a></div><div class="ttdeci">int get_nearest_point_index(const std::vector&lt; lanelet::BasicPoint2d &gt; &amp;points, const carma_planning_msgs::msg::VehicleState &amp;state)</div><div class="ttdoc">Returns the nearest point (in terms of cartesian 2d distance) to the provided vehicle pose in the pro...</div><div class="ttdef"><b>Definition:</b> <a href="helper__functions_8cpp_source.html#l00025">helper_functions.cpp:25</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a9a8cf0ed437bc3b0eb8008bd74782aa1"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a9a8cf0ed437bc3b0eb8008bd74782aa1">basic_autonomy::waypoint_generation::is_valid_yield_plan</a></div><div class="ttdeci">bool is_valid_yield_plan(const std::shared_ptr&lt; carma_ros2_utils::CarmaLifecycleNode &gt; &amp;node_handler, const carma_planning_msgs::msg::TrajectoryPlan &amp;yield_plan)</div><div class="ttdoc">Helper function to verify if the input yield trajectory plan is valid.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01316">basic_autonomy.cpp:1316</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a9dd6a1f0fa9c6f6590b83a7cc2e0d118"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a9dd6a1f0fa9c6f6590b83a7cc2e0d118">basic_autonomy::waypoint_generation::min_with_exclusions</a></div><div class="ttdeci">std::pair&lt; double, size_t &gt; min_with_exclusions(const std::vector&lt; double &gt; &amp;values, const std::unordered_set&lt; size_t &gt; &amp;excluded)</div><div class="ttdoc">Returns the min, and its idx, from the vector of values, excluding given set of values.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00679">basic_autonomy.cpp:679</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_a9e0eab343d21d18c665083839d706f04"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#a9e0eab343d21d18c665083839d706f04">basic_autonomy::waypoint_generation::compute_fit</a></div><div class="ttdeci">std::unique_ptr&lt; basic_autonomy::smoothing::SplineI &gt; compute_fit(const std::vector&lt; lanelet::BasicPoint2d &gt; &amp;basic_points)</div><div class="ttdoc">Computes a spline based on the provided points.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00818">basic_autonomy.cpp:818</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_aa3500af9146c0d9c80cb1b4101be01e5"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#aa3500af9146c0d9c80cb1b4101be01e5">basic_autonomy::waypoint_generation::create_lanefollow_geometry</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; create_lanefollow_geometry(const carma_planning_msgs::msg::Maneuver &amp;maneuver, double max_starting_downtrack, const carma_wm::WorldModelConstPtr &amp;wm, const GeneralTrajConfig &amp;general_config, const DetailedTrajConfig &amp;detailed_config, std::unordered_set&lt; lanelet::Id &gt; &amp;visited_lanelets)</div><div class="ttdoc">Converts a set of requested LANE_FOLLOWING maneuvers to point speed limit pairs.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00068">basic_autonomy.cpp:68</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_aa399a236f88f7b1c5557327fbb2ba71a"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#aa399a236f88f7b1c5557327fbb2ba71a">basic_autonomy::waypoint_generation::get_nearest_index_by_downtrack</a></div><div class="ttdeci">int get_nearest_index_by_downtrack(const std::vector&lt; lanelet::BasicPoint2d &gt; &amp;points, const carma_wm::WorldModelConstPtr &amp;wm, double target_downtrack)</div><div class="ttdoc">Returns the nearest &quot;less than&quot; point to the provided vehicle pose in the provided list by utilizing ...</div><div class="ttdef"><b>Definition:</b> <a href="helper__functions_8cpp_source.html#l00066">helper_functions.cpp:66</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_ab4974a3dfe697ccc0dd1344a8e11c5e1"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#ab4974a3dfe697ccc0dd1344a8e11c5e1">basic_autonomy::waypoint_generation::apply_speed_limits</a></div><div class="ttdeci">std::vector&lt; double &gt; apply_speed_limits(const std::vector&lt; double &gt; speeds, const std::vector&lt; double &gt; speed_limits)</div><div class="ttdoc">Applies the provided speed limits to the provided speeds such that each element is capped at its corr...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00616">basic_autonomy.cpp:616</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_aba6a29cdaf0c4af10647b59bf6df4e01"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#aba6a29cdaf0c4af10647b59bf6df4e01">basic_autonomy::waypoint_generation::trajectory_from_points_times_orientations</a></div><div class="ttdeci">std::vector&lt; carma_planning_msgs::msg::TrajectoryPlanPoint &gt; trajectory_from_points_times_orientations(const std::vector&lt; lanelet::BasicPoint2d &gt; &amp;points, const std::vector&lt; double &gt; &amp;times, const std::vector&lt; double &gt; &amp;yaws, rclcpp::Time startTime, const std::string &amp;desired_controller_plugin)</div><div class="ttdoc">Method combines input points, times, orientations, and an absolute start time to form a valid carma p...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00762">basic_autonomy.cpp:762</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_acdcd3bb44d31aa6405b30f151ea35ae4"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#acdcd3bb44d31aa6405b30f151ea35ae4">basic_autonomy::waypoint_generation::create_geometry_profile</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; create_geometry_profile(const std::vector&lt; carma_planning_msgs::msg::Maneuver &gt; &amp;maneuvers, double max_starting_downtrack, const carma_wm::WorldModelConstPtr &amp;wm, carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, const carma_planning_msgs::msg::VehicleState &amp;state, const GeneralTrajConfig &amp;general_config, const DetailedTrajConfig &amp;detailed_config)</div><div class="ttdoc">Creates geometry profile to return a point speed pair struct for LANE FOLLOW and LANE CHANGE maneuver...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00024">basic_autonomy.cpp:24</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_ad56958ee3bb11064df00a37cbf948b8d"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#ad56958ee3bb11064df00a37cbf948b8d">basic_autonomy::waypoint_generation::add_lanefollow_buffer</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; add_lanefollow_buffer(const carma_wm::WorldModelConstPtr &amp;wm, std::vector&lt; PointSpeedPair &gt; &amp;points_and_target_speeds, const std::vector&lt; carma_planning_msgs::msg::Maneuver &gt; &amp;maneuvers, carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, const DetailedTrajConfig &amp;detailed_config)</div><div class="ttdoc">Adds extra centerline points beyond required message length to lane follow maneuver points so that th...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00225">basic_autonomy.cpp:225</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_ad633c0c515eae2b1752ad96031e01ef8"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#ad633c0c515eae2b1752ad96031e01ef8">basic_autonomy::waypoint_generation::compose_lanefollow_trajectory_from_path</a></div><div class="ttdeci">std::vector&lt; carma_planning_msgs::msg::TrajectoryPlanPoint &gt; compose_lanefollow_trajectory_from_path(const std::vector&lt; PointSpeedPair &gt; &amp;points, const carma_planning_msgs::msg::VehicleState &amp;state, const rclcpp::Time &amp;state_time, const carma_wm::WorldModelConstPtr &amp;wm, const carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, carma_debug_ros2_msgs::msg::TrajectoryCurvatureSpeeds &amp;debug_msg, const DetailedTrajConfig &amp;detailed_config)</div><div class="ttdoc">Method converts a list of lanelet centerline points and current vehicle state into a usable list of t...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00865">basic_autonomy.cpp:865</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_ada2ee63b890bfa23d67a17cf61dd0129"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#ada2ee63b890bfa23d67a17cf61dd0129">basic_autonomy::waypoint_generation::compute_heading_frame</a></div><div class="ttdeci">Eigen::Isometry2d compute_heading_frame(const lanelet::BasicPoint2d &amp;p1, const lanelet::BasicPoint2d &amp;p2)</div><div class="ttdoc">Returns a 2D coordinate frame which is located at p1 and oriented so p2 lies on the +X axis.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00635">basic_autonomy.cpp:635</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_ae4ca284ba04f4f76fb88bf8d20731835"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#ae4ca284ba04f4f76fb88bf8d20731835">basic_autonomy::waypoint_generation::compute_curvature_at</a></div><div class="ttdeci">double compute_curvature_at(const basic_autonomy::smoothing::SplineI &amp;fit_curve, double step_along_the_curve)</div><div class="ttdoc">Given the curvature fit, computes the curvature at the given step along the curve.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00855">basic_autonomy.cpp:855</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_aef0a6b216ad0be7289773e54843f747b"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#aef0a6b216ad0be7289773e54843f747b">basic_autonomy::waypoint_generation::process_trajectory_plan</a></div><div class="ttdeci">autoware_auto_msgs::msg::Trajectory process_trajectory_plan(const carma_planning_msgs::msg::TrajectoryPlan &amp;tp, double vehicle_response_lag)</div><div class="ttdoc">Given a carma type of trajectory_plan, generate autoware type of trajectory accounting for speed_lag ...</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l01196">basic_autonomy.cpp:1196</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_af509efce135492493e13c9bb86329dcd"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#af509efce135492493e13c9bb86329dcd">basic_autonomy::waypoint_generation::constrain_to_time_boundary</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; constrain_to_time_boundary(const std::vector&lt; PointSpeedPair &gt; &amp;points, double time_span)</div><div class="ttdoc">Reduces the input points to only those points that fit within the provided time boundary.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00643">basic_autonomy.cpp:643</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_af992a6cbbdafd6e86d73976a65164e94"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#af992a6cbbdafd6e86d73976a65164e94">basic_autonomy::waypoint_generation::get_lanechange_points_from_maneuver</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; get_lanechange_points_from_maneuver(const carma_planning_msgs::msg::Maneuver &amp;maneuver, double max_starting_downtrack, const carma_wm::WorldModelConstPtr &amp;wm, carma_planning_msgs::msg::VehicleState &amp;ending_state_before_buffer, const carma_planning_msgs::msg::VehicleState &amp;state, const GeneralTrajConfig &amp;general_config, const DetailedTrajConfig &amp;detailed_config)</div><div class="ttdoc">Converts a set of requested LANE_CHANGE maneuvers to point speed limit pairs.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00544">basic_autonomy.cpp:544</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_1_1waypoint__generation_html_af9a705cca66d75f0d2d8ce9e6ea2ee41"><div class="ttname"><a href="namespacebasic__autonomy_1_1waypoint__generation.html#af9a705cca66d75f0d2d8ce9e6ea2ee41">basic_autonomy::waypoint_generation::attach_past_points</a></div><div class="ttdeci">std::vector&lt; PointSpeedPair &gt; attach_past_points(const std::vector&lt; PointSpeedPair &gt; &amp;points_set, std::vector&lt; PointSpeedPair &gt; future_points, const int nearest_pt_index, double back_distance)</div><div class="ttdoc">Attaches back_distance length of points behind the future points.</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8cpp_source.html#l00793">basic_autonomy.cpp:793</a></div></div>
<div class="ttc" id="anamespacebasic__autonomy_html"><div class="ttname"><a href="namespacebasic__autonomy.html">basic_autonomy</a></div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00058">basic_autonomy.hpp:59</a></div></div>
<div class="ttc" id="anamespacecarma__cooperative__perception_html_a64b708654c8aecb09122d39577df31b5"><div class="ttname"><a href="namespacecarma__cooperative__perception.html#a64b708654c8aecb09122d39577df31b5">carma_cooperative_perception::to_string</a></div><div class="ttdeci">auto to_string(const UtmZone &amp;zone) -&gt; std::string</div><div class="ttdef"><b>Definition:</b> <a href="utm__zone_8cpp_source.html#l00021">utm_zone.cpp:21</a></div></div>
<div class="ttc" id="anamespacecarma__wm_1_1geometry_html_ab51c08f5f937a6aa72b7490eeabed211"><div class="ttname"><a href="namespacecarma__wm_1_1geometry.html#ab51c08f5f937a6aa72b7490eeabed211">carma_wm::geometry::build2dEigenTransform</a></div><div class="ttdeci">Eigen::Isometry2d build2dEigenTransform(const Eigen::Vector2d &amp;position, const Eigen::Rotation2Dd &amp;rotation)</div><div class="ttdoc">Builds a 2D Eigen coordinate frame transform with not applied scaling (only translation and rotation)...</div><div class="ttdef"><b>Definition:</b> <a href="Geometry_8cpp_source.html#l00570">Geometry.cpp:570</a></div></div>
<div class="ttc" id="anamespacecarma__wm_1_1geometry_html_ad8a3ee0bf06f85a6e7a8b5097251da2b"><div class="ttname"><a href="namespacecarma__wm_1_1geometry.html#ad8a3ee0bf06f85a6e7a8b5097251da2b">carma_wm::geometry::compute_tangent_orientations</a></div><div class="ttdeci">std::vector&lt; double &gt; compute_tangent_orientations(const lanelet::BasicLineString2d &amp;centerline)</div><div class="ttdoc">Compute an approximate orientation for the vehicle at each point along the provided centerline.</div><div class="ttdef"><b>Definition:</b> <a href="Geometry_8cpp_source.html#l00559">Geometry.cpp:559</a></div></div>
<div class="ttc" id="anamespacecarma__wm_1_1geometry_html_adf1c6b7f1e33569b45074e4e5bbeff1d"><div class="ttname"><a href="namespacecarma__wm_1_1geometry.html#adf1c6b7f1e33569b45074e4e5bbeff1d">carma_wm::geometry::compute_arc_lengths</a></div><div class="ttdeci">std::vector&lt; double &gt; compute_arc_lengths(const std::vector&lt; lanelet::BasicPoint2d &gt; &amp;data)</div><div class="ttdoc">Compute the arc length at each point around the curve.</div><div class="ttdef"><b>Definition:</b> <a href="Geometry_8cpp_source.html#l00498">Geometry.cpp:498</a></div></div>
<div class="ttc" id="anamespacecarma__wm_1_1geometry_html_ae7d5ca280140dce2bf7bcfb78bdfd55d"><div class="ttname"><a href="namespacecarma__wm_1_1geometry.html#ae7d5ca280140dce2bf7bcfb78bdfd55d">carma_wm::geometry::concatenate_line_strings</a></div><div class="ttdeci">lanelet::BasicLineString2d concatenate_line_strings(const lanelet::BasicLineString2d &amp;l1, const lanelet::BasicLineString2d &amp;l2)</div><div class="ttdoc">Helper function to concatenate 2 linestrings together and return the result. Neither LineString is mo...</div><div class="ttdef"><b>Definition:</b> <a href="Geometry_8cpp_source.html#l00373">Geometry.cpp:373</a></div></div>
<div class="ttc" id="anamespacecarma__wm_html_a3ac653959e0b6198cae274d68b343228"><div class="ttname"><a href="namespacecarma__wm.html#a3ac653959e0b6198cae274d68b343228">carma_wm::WorldModelConstPtr</a></div><div class="ttdeci">std::shared_ptr&lt; const WorldModel &gt; WorldModelConstPtr</div><div class="ttdef"><b>Definition:</b> <a href="WorldModel_8hpp_source.html#l00452">WorldModel.hpp:452</a></div></div>
<div class="ttc" id="anamespaceprocess__bag_html_af102a02c97622dd30b0dbf7bafb0d199"><div class="ttname"><a href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">process_bag.i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="process__bag_8py_source.html#l00059">process_bag.py:59</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_a05bdb238bfbf3836fb0aa69c5aa1bb48"><div class="ttname"><a href="namespaceprocess__traj__logs.html#a05bdb238bfbf3836fb0aa69c5aa1bb48">process_traj_logs.y</a></div><div class="ttdeci">y</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00129">process_traj_logs.py:129</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_a49cd466f330a9498d8373baecf47e071"><div class="ttname"><a href="namespaceprocess__traj__logs.html#a49cd466f330a9498d8373baecf47e071">process_traj_logs.c</a></div><div class="ttdeci">c</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00166">process_traj_logs.py:166</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_ab81a05c3d1d100117b6781d7dedf8a29"><div class="ttname"><a href="namespaceprocess__traj__logs.html#ab81a05c3d1d100117b6781d7dedf8a29">process_traj_logs.point</a></div><div class="ttdeci">point</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00126">process_traj_logs.py:126</a></div></div>
<div class="ttc" id="anamespaceprocess__traj__logs_html_af3ba6144a2d35a4990f1a8d04632a052"><div class="ttname"><a href="namespaceprocess__traj__logs.html#af3ba6144a2d35a4990f1a8d04632a052">process_traj_logs.x</a></div><div class="ttdeci">x</div><div class="ttdef"><b>Definition:</b> <a href="process__traj__logs_8py_source.html#l00128">process_traj_logs.py:128</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html">basic_autonomy::waypoint_generation::DetailedTrajConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00078">basic_autonomy.hpp:79</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a4a883bd5094bdc768c05d0c3a751f219"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4a883bd5094bdc768c05d0c3a751f219">basic_autonomy::waypoint_generation::DetailedTrajConfig::speed_moving_average_window_size</a></div><div class="ttdeci">int speed_moving_average_window_size</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00085">basic_autonomy.hpp:85</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a4bf547260f4eb35b2df2a8ddb5b216c8"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4bf547260f4eb35b2df2a8ddb5b216c8">basic_autonomy::waypoint_generation::DetailedTrajConfig::minimum_speed</a></div><div class="ttdeci">double minimum_speed</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00082">basic_autonomy.hpp:82</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a4c8a65b9797246e176f6245025e21b95"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a4c8a65b9797246e176f6245025e21b95">basic_autonomy::waypoint_generation::DetailedTrajConfig::back_distance</a></div><div class="ttdeci">double back_distance</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00088">basic_autonomy.hpp:88</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a60a7d101e04a9a2bf755b8c5a9741354"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a60a7d101e04a9a2bf755b8c5a9741354">basic_autonomy::waypoint_generation::DetailedTrajConfig::curvature_moving_average_window_size</a></div><div class="ttdeci">int curvature_moving_average_window_size</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00086">basic_autonomy.hpp:86</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a75872d4c289f3eda6a9a6cfca337534b"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a75872d4c289f3eda6a9a6cfca337534b">basic_autonomy::waypoint_generation::DetailedTrajConfig::lateral_accel_limit</a></div><div class="ttdeci">double lateral_accel_limit</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00084">basic_autonomy.hpp:84</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_a89ca36377e20e514abc609c5bd65a941"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#a89ca36377e20e514abc609c5bd65a941">basic_autonomy::waypoint_generation::DetailedTrajConfig::desired_controller_plugin</a></div><div class="ttdeci">std::string desired_controller_plugin</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00090">basic_autonomy.hpp:90</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_ac27f6c12b09f9cc22e608ec1be16477c"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ac27f6c12b09f9cc22e608ec1be16477c">basic_autonomy::waypoint_generation::DetailedTrajConfig::max_accel</a></div><div class="ttdeci">double max_accel</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00083">basic_autonomy.hpp:83</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_ae2456fd9c7e752615b59ec444c8c28ee"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#ae2456fd9c7e752615b59ec444c8c28ee">basic_autonomy::waypoint_generation::DetailedTrajConfig::buffer_ending_downtrack</a></div><div class="ttdeci">double buffer_ending_downtrack</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00089">basic_autonomy.hpp:89</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_aeb772409ce5df1b078295282a353349f"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aeb772409ce5df1b078295282a353349f">basic_autonomy::waypoint_generation::DetailedTrajConfig::trajectory_time_length</a></div><div class="ttdeci">double trajectory_time_length</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00080">basic_autonomy.hpp:80</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig_html_aed01f5b534f9dc52cc74022c71e2fa3c"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1DetailedTrajConfig.html#aed01f5b534f9dc52cc74022c71e2fa3c">basic_autonomy::waypoint_generation::DetailedTrajConfig::curve_resample_step_size</a></div><div class="ttdeci">double curve_resample_step_size</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00081">basic_autonomy.hpp:81</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig_html"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html">basic_autonomy::waypoint_generation::GeneralTrajConfig</a></div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00070">basic_autonomy.hpp:71</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig_html_a0ad2d91d1f739942213d5bfe7f0e861f"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a0ad2d91d1f739942213d5bfe7f0e861f">basic_autonomy::waypoint_generation::GeneralTrajConfig::default_downsample_ratio</a></div><div class="ttdeci">int default_downsample_ratio</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00073">basic_autonomy.hpp:73</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig_html_a3cea08651e7da10dc7b7510dc82b192d"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a3cea08651e7da10dc7b7510dc82b192d">basic_autonomy::waypoint_generation::GeneralTrajConfig::trajectory_type</a></div><div class="ttdeci">std::string trajectory_type</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00072">basic_autonomy.hpp:72</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig_html_a57b1703c6bbc6043c489280ca1c34041"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1GeneralTrajConfig.html#a57b1703c6bbc6043c489280ca1c34041">basic_autonomy::waypoint_generation::GeneralTrajConfig::turn_downsample_ratio</a></div><div class="ttdeci">int turn_downsample_ratio</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00074">basic_autonomy.hpp:74</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair_html"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html">basic_autonomy::waypoint_generation::PointSpeedPair</a></div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00064">basic_autonomy.hpp:65</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair_html_a628d9d3853745335b42ad940136d88ac"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#a628d9d3853745335b42ad940136d88ac">basic_autonomy::waypoint_generation::PointSpeedPair::point</a></div><div class="ttdeci">lanelet::BasicPoint2d point</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00066">basic_autonomy.hpp:66</a></div></div>
<div class="ttc" id="astructbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair_html_aafb815247d0179093dcd47c9e9be3428"><div class="ttname"><a href="structbasic__autonomy_1_1waypoint__generation_1_1PointSpeedPair.html#aafb815247d0179093dcd47c9e9be3428">basic_autonomy::waypoint_generation::PointSpeedPair::speed</a></div><div class="ttdeci">double speed</div><div class="ttdef"><b>Definition:</b> <a href="basic__autonomy_8hpp_source.html#l00067">basic_autonomy.hpp:67</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_16a7f3bdd30cf8a55d8e1f4bc430a213.html">basic_autonomy</a></li><li class="navelem"><a class="el" href="dir_531f054af2f39068c7a66360431b1b8d.html">src</a></li><li class="navelem"><a class="el" href="basic__autonomy_8cpp.html">basic_autonomy.cpp</a></li>
    <li class="footer">Generated on Fri Sep 27 2024 21:35:02 for Carma-platform by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
