<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-platform: motion_computation::conversion Namespace Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Carma-platform<span id="projectnumber">&#160;v4.2.0</span>
   </div>
   <div id="projectbrief">CARMA Platform is built on robot operating system (ROS) and utilizes open source software (OSS) that enables Cooperative Driving Automation (CDA) features to allow Automated Driving Systems to interact and cooperate with infrastructure and other vehicles through communication.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('namespacemotion__computation_1_1conversion.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#namespaces">Namespaces</a> &#124;
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">motion_computation::conversion Namespace Reference</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="namespaces" name="namespaces"></a>
Namespaces</h2></td></tr>
<tr class="memitem:namespacemotion__computation_1_1conversion_1_1impl"><td class="memItemLeft" align="right" valign="top">namespace &#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemotion__computation_1_1conversion_1_1impl.html">impl</a></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:a9884e63460f3d5f5e2b755354984dc29"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemotion__computation_1_1conversion.html#a9884e63460f3d5f5e2b755354984dc29">convert</a> (const carma_v2x_msgs::msg::PSM &amp;in_msg, carma_perception_msgs::msg::ExternalObject &amp;out_msg, const std::string &amp;map_frame_id, double pred_period, double pred_step_size, const lanelet::projection::LocalFrameProjector &amp;map_projector, const tf2::Quaternion &amp;ned_in_map_rotation, rclcpp::node_interfaces::NodeClockInterface::SharedPtr node_clock)</td></tr>
<tr class="separator:a9884e63460f3d5f5e2b755354984dc29"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a9e19fcaf4fb394f34162ae07eab989ad"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemotion__computation_1_1conversion.html#a9e19fcaf4fb394f34162ae07eab989ad">convert</a> (const carma_v2x_msgs::msg::BSM &amp;in_msg, carma_perception_msgs::msg::ExternalObject &amp;out_msg, const std::string &amp;map_frame_id, double pred_period, double pred_step_size, const lanelet::projection::LocalFrameProjector &amp;map_projector, tf2::Quaternion ned_in_map_rotation)</td></tr>
<tr class="separator:a9e19fcaf4fb394f34162ae07eab989ad"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac015baeed44f7d5fbf23e8a71bb12876"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="namespacemotion__computation_1_1conversion.html#ac015baeed44f7d5fbf23e8a71bb12876">convert</a> (const carma_v2x_msgs::msg::MobilityPath &amp;in_msg, carma_perception_msgs::msg::ExternalObject &amp;out_msg, const lanelet::projection::LocalFrameProjector &amp;map_projector)</td></tr>
<tr class="separator:ac015baeed44f7d5fbf23e8a71bb12876"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<h2 class="groupheader">Function Documentation</h2>
<a id="a9e19fcaf4fb394f34162ae07eab989ad" name="a9e19fcaf4fb394f34162ae07eab989ad"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9e19fcaf4fb394f34162ae07eab989ad">&#9670;&nbsp;</a></span>convert() <span class="overload">[1/3]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void motion_computation::conversion::convert </td>
          <td>(</td>
          <td class="paramtype">const carma_v2x_msgs::msg::BSM &amp;&#160;</td>
          <td class="paramname"><em>in_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">carma_perception_msgs::msg::ExternalObject &amp;&#160;</td>
          <td class="paramname"><em>out_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>map_frame_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pred_period</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pred_step_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const lanelet::projection::LocalFrameProjector &amp;&#160;</td>
          <td class="paramname"><em>map_projector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">tf2::Quaternion&#160;</td>
          <td class="paramname"><em>ned_in_map_rotation</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="bsm__to__external__object__convertor_8cpp_source.html#l00029">29</a> of file <a class="el" href="bsm__to__external__object__convertor_8cpp_source.html">bsm_to_external_object_convertor.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   34</span>{</div>
<div class="line"><span class="lineno">   35</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::BSM_ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   36</span> </div>
<div class="line"><span class="lineno">   37</span>  <span class="comment">// assume any BSM is a dynamic object since its sent be a vehicle</span></div>
<div class="line"><span class="lineno">   38</span>  out_msg.dynamic_obj = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">   39</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::DYNAMIC_OBJ_PRESENCE;</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   42</span>  <span class="comment">// Generate a unique object id from the bsm id</span></div>
<div class="line"><span class="lineno">   43</span>  out_msg.id = 0;</div>
<div class="line"><span class="lineno">   44</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = in_msg.core_data.id.size() - 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt;= 0;</div>
<div class="line"><span class="lineno">   45</span>       <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>--) {  <span class="comment">// using signed iterator to handle empty case</span></div>
<div class="line"><span class="lineno">   46</span>    <span class="comment">// each byte of the bsm id gets placed in one byte of the object id.</span></div>
<div class="line"><span class="lineno">   47</span>    <span class="comment">// This should result in very large numbers which will be unlikely to</span></div>
<div class="line"><span class="lineno">   48</span>    <span class="comment">// conflict with standard detections</span></div>
<div class="line"><span class="lineno">   49</span>    out_msg.id |= in_msg.core_data.id[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] &lt;&lt; (8 * <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><span class="lineno">   50</span>  }</div>
<div class="line"><span class="lineno">   51</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   52</span> </div>
<div class="line"><span class="lineno">   54</span>  out_msg.bsm_id = in_msg.core_data.id;</div>
<div class="line"><span class="lineno">   55</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::BSM_ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   56</span> </div>
<div class="line"><span class="lineno">   58</span>  <span class="comment">// Compute the timestamp</span></div>
<div class="line"><span class="lineno">   59</span>  out_msg.header.stamp = in_msg.header.stamp;</div>
<div class="line"><span class="lineno">   60</span>  out_msg.header.frame_id = map_frame_id;</div>
<div class="line"><span class="lineno">   61</span> </div>
<div class="line"><span class="lineno">   63</span> </div>
<div class="line"><span class="lineno">   64</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">   65</span>    in_msg.core_data.size.presence_vector &amp;</div>
<div class="line"><span class="lineno">   66</span>    carma_v2x_msgs::msg::VehicleSize::VEHICLE_LENGTH_AVAILABLE) {</div>
<div class="line"><span class="lineno">   67</span>    <span class="comment">// ExternalObject size is half of each dimension</span></div>
<div class="line"><span class="lineno">   68</span>    out_msg.size.x = in_msg.core_data.size.vehicle_length / 2;</div>
<div class="line"><span class="lineno">   69</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   70</span>    out_msg.size.x = 1.0;  <span class="comment">// value from mob path to external obj conversion</span></div>
<div class="line"><span class="lineno">   71</span>  }</div>
<div class="line"><span class="lineno">   72</span> </div>
<div class="line"><span class="lineno">   73</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">   74</span>    in_msg.core_data.size.presence_vector &amp;</div>
<div class="line"><span class="lineno">   75</span>    carma_v2x_msgs::msg::VehicleSize::VEHICLE_WIDTH_AVAILABLE) {</div>
<div class="line"><span class="lineno">   76</span>    <span class="comment">// ExternalObject size is half of each dimension</span></div>
<div class="line"><span class="lineno">   77</span>    out_msg.size.y = in_msg.core_data.size.vehicle_width / 2;</div>
<div class="line"><span class="lineno">   78</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">   79</span>    out_msg.size.y = 1.0;  <span class="comment">// value from mob path to external obj conversion</span></div>
<div class="line"><span class="lineno">   80</span>  }</div>
<div class="line"><span class="lineno">   81</span> </div>
<div class="line"><span class="lineno">   82</span>  out_msg.size.z = 2.0;  <span class="comment">// value from mob path to external obj conversion</span></div>
<div class="line"><span class="lineno">   83</span> </div>
<div class="line"><span class="lineno">   84</span>  out_msg.object_type = carma_perception_msgs::msg::ExternalObject::SMALL_VEHICLE;</div>
<div class="line"><span class="lineno">   85</span> </div>
<div class="line"><span class="lineno">   87</span>  <span class="comment">// Set the velocity</span></div>
<div class="line"><span class="lineno">   88</span>  <span class="keywordflow">if</span> (in_msg.core_data.presence_vector &amp; carma_v2x_msgs::msg::BSMCoreData::SPEED_AVAILABLE) {</div>
<div class="line"><span class="lineno">   89</span>    out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::VELOCITY_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   90</span>    float_t speed_mps = in_msg.core_data.speed;</div>
<div class="line"><span class="lineno">   91</span> </div>
<div class="line"><span class="lineno">   92</span>    out_msg.velocity.twist.linear.x = std::min(speed_mps, in_msg.core_data.SPEED_MAX);</div>
<div class="line"><span class="lineno">   93</span>  }</div>
<div class="line"><span class="lineno">   94</span> </div>
<div class="line"><span class="lineno">   95</span>  <span class="comment">// NOTE: The velocity covariance is not provided in the BSM. In order to</span></div>
<div class="line"><span class="lineno">   96</span>  <span class="comment">// compute it you need at least two BSM messages</span></div>
<div class="line"><span class="lineno">   97</span>  <span class="comment">//     Tracking and associating BSM messages would be an increase in</span></div>
<div class="line"><span class="lineno">   98</span>  <span class="comment">//     complexity for this conversion which is not warranted without an</span></div>
<div class="line"><span class="lineno">   99</span>  <span class="comment">//     existing use case for the velocity covariance. If a use case is</span></div>
<div class="line"><span class="lineno">  100</span>  <span class="comment">//     presented for it, such an addition can be made at that time.</span></div>
<div class="line"><span class="lineno">  101</span> </div>
<div class="line"><span class="lineno">  103</span>  <span class="comment">// Compute the position covariance</span></div>
<div class="line"><span class="lineno">  104</span>  <span class="comment">// For computing confidence we will use the largest provided standard</span></div>
<div class="line"><span class="lineno">  105</span>  <span class="comment">// deviation of position</span></div>
<div class="line"><span class="lineno">  106</span>  <span class="keywordtype">double</span> largest_position_std =</div>
<div class="line"><span class="lineno">  107</span>    std::max(in_msg.core_data.accuracy.semi_major, in_msg.core_data.accuracy.semi_minor);</div>
<div class="line"><span class="lineno">  108</span> </div>
<div class="line"><span class="lineno">  109</span>  <span class="keywordtype">double</span> lat_variance = in_msg.core_data.accuracy.semi_minor * in_msg.core_data.accuracy.semi_minor;</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>  <span class="keywordtype">double</span> lon_variance = in_msg.core_data.accuracy.semi_major * in_msg.core_data.accuracy.semi_major;</div>
<div class="line"><span class="lineno">  112</span> </div>
<div class="line"><span class="lineno">  113</span>  <span class="keywordtype">double</span> heading_variance =</div>
<div class="line"><span class="lineno">  114</span>    in_msg.core_data.accuracy.orientation * in_msg.core_data.accuracy.orientation;</div>
<div class="line"><span class="lineno">  115</span> </div>
<div class="line"><span class="lineno">  116</span>  <span class="keywordtype">double</span> position_confidence = 0.1;  <span class="comment">// Default will be 10% confidence. If the position accuracy is</span></div>
<div class="line"><span class="lineno">  117</span>                                     <span class="comment">// available then this value will be updated</span></div>
<div class="line"><span class="lineno">  118</span> </div>
<div class="line"><span class="lineno">  119</span>  <span class="comment">// A standard deviation which is larger than the acceptable value to give</span></div>
<div class="line"><span class="lineno">  120</span>  <span class="comment">// 95% confidence interval on fitting the pedestrian within one 3.7m lane</span></div>
<div class="line"><span class="lineno">  121</span>  <span class="keyword">constexpr</span> <span class="keywordtype">double</span> MAX_POSITION_STD = 1.85;</div>
<div class="line"><span class="lineno">  122</span> </div>
<div class="line"><span class="lineno">  123</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  124</span>    (in_msg.core_data.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  125</span>     carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) &amp;&amp;</div>
<div class="line"><span class="lineno">  126</span>    (in_msg.core_data.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  127</span>     carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE)) {</div>
<div class="line"><span class="lineno">  128</span>    <span class="comment">// Both accuracies available</span></div>
<div class="line"><span class="lineno">  129</span> </div>
<div class="line"><span class="lineno">  130</span>    <span class="comment">// NOTE: ExternalObject.msg does not clearly define what is meant by</span></div>
<div class="line"><span class="lineno">  131</span>    <span class="comment">// position confidence</span></div>
<div class="line"><span class="lineno">  132</span>    <span class="comment">//     Here we are providing a linear scale based on the positional accuracy</span></div>
<div class="line"><span class="lineno">  133</span>    <span class="comment">//     where 0 confidence would denote A standard deviation which is larger</span></div>
<div class="line"><span class="lineno">  134</span>    <span class="comment">//     than the acceptable value to give 95% confidence interval on fitting</span></div>
<div class="line"><span class="lineno">  135</span>    <span class="comment">//     the pedestrian within one 3.7m lane</span></div>
<div class="line"><span class="lineno">  136</span>    <span class="comment">// Set the confidence</span></div>
<div class="line"><span class="lineno">  137</span>    <span class="comment">// Without a way of getting the velocity confidence from the BSM we will use</span></div>
<div class="line"><span class="lineno">  138</span>    <span class="comment">// the position confidence for both</span></div>
<div class="line"><span class="lineno">  139</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><span class="lineno">  140</span>    out_msg.presence_vector |=</div>
<div class="line"><span class="lineno">  141</span>      carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  142</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  143</span>    in_msg.core_data.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  144</span>    carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) {</div>
<div class="line"><span class="lineno">  145</span>    <span class="comment">// Position accuracy available</span></div>
<div class="line"><span class="lineno">  146</span> </div>
<div class="line"><span class="lineno">  147</span>    heading_variance = 1.0;  <span class="comment">// Yaw variance is not available so mark as</span></div>
<div class="line"><span class="lineno">  148</span>                             <span class="comment">// impossible perfect case</span></div>
<div class="line"><span class="lineno">  149</span> </div>
<div class="line"><span class="lineno">  150</span>    <span class="comment">// Same calculation as shown in above condition. See that for description</span></div>
<div class="line"><span class="lineno">  151</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><span class="lineno">  152</span>    out_msg.presence_vector |=</div>
<div class="line"><span class="lineno">  153</span>      carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  154</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  155</span>    in_msg.core_data.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  156</span>    carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE) {</div>
<div class="line"><span class="lineno">  157</span>    <span class="comment">// Orientation accuracy available</span></div>
<div class="line"><span class="lineno">  158</span> </div>
<div class="line"><span class="lineno">  159</span>    lat_variance = 1.0;</div>
<div class="line"><span class="lineno">  160</span>    lon_variance = 1.0;</div>
<div class="line"><span class="lineno">  161</span>  }</div>
<div class="line"><span class="lineno">  162</span>  <span class="comment">// Else: No accuracies available</span></div>
<div class="line"><span class="lineno">  163</span> </div>
<div class="line"><span class="lineno">  165</span>  <span class="comment">// Compute the pose</span></div>
<div class="line"><span class="lineno">  166</span> </div>
<div class="line"><span class="lineno">  167</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  168</span>    (in_msg.core_data.presence_vector &amp; carma_v2x_msgs::msg::BSMCoreData::LATITUDE_AVAILABLE) &amp;&amp;</div>
<div class="line"><span class="lineno">  169</span>    (in_msg.core_data.presence_vector &amp; carma_v2x_msgs::msg::BSMCoreData::LONGITUDE_AVAILABLE) &amp;&amp;</div>
<div class="line"><span class="lineno">  170</span>    (in_msg.core_data.presence_vector &amp; carma_v2x_msgs::msg::BSMCoreData::ELEVATION_AVAILABLE) &amp;&amp;</div>
<div class="line"><span class="lineno">  171</span>    (in_msg.core_data.presence_vector &amp; carma_v2x_msgs::msg::BSMCoreData::HEADING_AVAILABLE)) {</div>
<div class="line"><span class="lineno">  172</span>    <span class="keywordtype">double</span> longitude = std::min(in_msg.core_data.longitude, in_msg.core_data.LONGITUDE_MAX);</div>
<div class="line"><span class="lineno">  173</span>    longitude = std::max(longitude, in_msg.core_data.LONGITUDE_MIN);</div>
<div class="line"><span class="lineno">  174</span> </div>
<div class="line"><span class="lineno">  175</span>    <span class="keywordtype">double</span> latitude = std::min(in_msg.core_data.latitude, in_msg.core_data.LATITUDE_MAX);</div>
<div class="line"><span class="lineno">  176</span>    <span class="comment">// latitude =  std::max(latitude, in_msg.core_data.LATITUDE_MIN);</span></div>
<div class="line"><span class="lineno">  177</span> </div>
<div class="line"><span class="lineno">  178</span>    <span class="keywordtype">double</span> elev = std::min(in_msg.core_data.elev, in_msg.core_data.ELEVATION_MAX);</div>
<div class="line"><span class="lineno">  179</span>    <span class="comment">// elev = std::max(elev, (float)in_msg.core_data.ELEVATION_MIN);</span></div>
<div class="line"><span class="lineno">  180</span> </div>
<div class="line"><span class="lineno">  181</span>    <span class="keywordtype">double</span> heading = std::min(in_msg.core_data.heading, in_msg.core_data.HEADING_MAX);</div>
<div class="line"><span class="lineno">  182</span>    <span class="comment">// heading = std::max(heading, in_msg.core_data.HEADING_MIN);</span></div>
<div class="line"><span class="lineno">  183</span> </div>
<div class="line"><span class="lineno">  184</span>    out_msg.pose = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">impl::pose_from_gnss</a>(</div>
<div class="line"><span class="lineno">  185</span>      map_projector, ned_in_map_rotation, {latitude, longitude, elev}, heading, lat_variance,</div>
<div class="line"><span class="lineno">  186</span>      lon_variance, heading_variance);</div>
<div class="line"><span class="lineno">  187</span>    out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::POSE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  188</span>  }</div>
<div class="line"><span class="lineno">  189</span>  <span class="comment">// Else: No pose available</span></div>
<div class="line"><span class="lineno">  190</span> </div>
<div class="line"><span class="lineno">  191</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::POSE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  192</span> </div>
<div class="line"><span class="lineno">  194</span>  <span class="comment">// Compute predictions</span></div>
<div class="line"><span class="lineno">  195</span>  <span class="comment">// For prediction, if the prediction is available we will sample it</span></div>
<div class="line"><span class="lineno">  196</span>  <span class="comment">// If not then assume linear motion</span></div>
<div class="line"><span class="lineno">  197</span> </div>
<div class="line"><span class="lineno">  198</span>  std::vector&lt;geometry_msgs::msg::Pose&gt; predicted_poses;</div>
<div class="line"><span class="lineno">  199</span> </div>
<div class="line"><span class="lineno">  200</span>  predicted_poses = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">impl::sample_2d_linear_motion</a>(</div>
<div class="line"><span class="lineno">  201</span>    out_msg.pose.pose, out_msg.velocity.twist.linear.x, pred_period, pred_step_size);</div>
<div class="line"><span class="lineno">  202</span> </div>
<div class="line"><span class="lineno">  203</span>  out_msg.predictions = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">impl::predicted_poses_to_predicted_state</a>(</div>
<div class="line"><span class="lineno">  204</span>    predicted_poses, out_msg.velocity.twist.linear.x, rclcpp::Time(out_msg.header.stamp),</div>
<div class="line"><span class="lineno">  205</span>    rclcpp::Duration(pred_step_size * 1e9), map_frame_id, out_msg.confidence, out_msg.confidence);</div>
<div class="line"><span class="lineno">  206</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::PREDICTION_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  207</span>}</div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a50c675cb23fd3a743226b22287b32945"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">motion_computation::conversion::impl::pose_from_gnss</a></div><div class="ttdeci">geometry_msgs::msg::PoseWithCovariance pose_from_gnss(const lanelet::projection::LocalFrameProjector &amp;projector, const tf2::Quaternion &amp;ned_in_map_rotation, const lanelet::GPSPoint &amp;gps_point, const double &amp;heading, const double lat_variance, const double lon_variance, const double heading_variance)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00339">psm_to_external_object_convertor.cpp:339</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a7cf9dd84c4528278ce20562def3047c3"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">motion_computation::conversion::impl::predicted_poses_to_predicted_state</a></div><div class="ttdeci">std::vector&lt; carma_perception_msgs::msg::PredictedState &gt; predicted_poses_to_predicted_state(const std::vector&lt; geometry_msgs::msg::Pose &gt; &amp;poses, double constant_velocity, const rclcpp::Time &amp;start_time, const rclcpp::Duration &amp;step_size, const std::string &amp;frame, double initial_pose_confidence, double initial_vel_confidence)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00444">psm_to_external_object_convertor.cpp:444</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_ae5e3a18881b54fc666c13199ea6c7073"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">motion_computation::conversion::impl::sample_2d_linear_motion</a></div><div class="ttdeci">std::vector&lt; geometry_msgs::msg::Pose &gt; sample_2d_linear_motion(const geometry_msgs::msg::Pose &amp;pose, double velocity, double period, double step_size)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00293">psm_to_external_object_convertor.cpp:293</a></div></div>
<div class="ttc" id="anamespaceprocess__bag_html_af102a02c97622dd30b0dbf7bafb0d199"><div class="ttname"><a href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">process_bag.i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> <a href="process__bag_8py_source.html#l00059">process_bag.py:59</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="process__bag_8py_source.html#l00059">process_bag::i</a>, <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00339">motion_computation::conversion::impl::pose_from_gnss()</a>, <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00444">motion_computation::conversion::impl::predicted_poses_to_predicted_state()</a>, and <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00293">motion_computation::conversion::impl::sample_2d_linear_motion()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacemotion__computation_1_1conversion_a9e19fcaf4fb394f34162ae07eab989ad_cgraph.png" border="0" usemap="#anamespacemotion__computation_1_1conversion_a9e19fcaf4fb394f34162ae07eab989ad_cgraph" alt=""/></div>
<map name="anamespacemotion__computation_1_1conversion_a9e19fcaf4fb394f34162ae07eab989ad_cgraph" id="anamespacemotion__computation_1_1conversion_a9e19fcaf4fb394f34162ae07eab989ad_cgraph">
<area shape="rect" title=" " alt="" coords="5,93,145,134"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945" title=" " alt="" coords="239,5,378,61"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3" title=" " alt="" coords="193,85,424,141"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073" title=" " alt="" coords="224,165,393,221"/>
<area shape="rect" href="namespacecovariance__helper.html#af38530465ec3a2a40b4e9be14032f65e" title="Transform the covariance matrix of a PoseWithCovariance message to a new frame." alt="" coords="472,13,615,54"/>
</map>
</div>

</div>
</div>
<a id="ac015baeed44f7d5fbf23e8a71bb12876" name="ac015baeed44f7d5fbf23e8a71bb12876"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac015baeed44f7d5fbf23e8a71bb12876">&#9670;&nbsp;</a></span>convert() <span class="overload">[2/3]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void motion_computation::conversion::convert </td>
          <td>(</td>
          <td class="paramtype">const carma_v2x_msgs::msg::MobilityPath &amp;&#160;</td>
          <td class="paramname"><em>in_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">carma_perception_msgs::msg::ExternalObject &amp;&#160;</td>
          <td class="paramname"><em>out_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const lanelet::projection::LocalFrameProjector &amp;&#160;</td>
          <td class="paramname"><em>map_projector</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="mobility__path__to__external__object_8cpp_source.html#l00029">29</a> of file <a class="el" href="mobility__path__to__external__object_8cpp_source.html">mobility_path_to_external_object.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   33</span>{</div>
<div class="line"><span class="lineno">   34</span>  <span class="keyword">constexpr</span> <span class="keywordtype">double</span> mobility_path_points_timestep_size =</div>
<div class="line"><span class="lineno">   35</span>    0.1;  <span class="comment">// Mobility path timestep size per message spec</span></div>
<div class="line"><span class="lineno">   36</span> </div>
<div class="line"><span class="lineno">   37</span>  out_msg.size.x = 2.5;  <span class="comment">// TODO(carma) identify better approach for object size in mobility path</span></div>
<div class="line"><span class="lineno">   38</span>  out_msg.size.y = 2.25;</div>
<div class="line"><span class="lineno">   39</span>  out_msg.size.z = 2.0;</div>
<div class="line"><span class="lineno">   40</span> </div>
<div class="line"><span class="lineno">   41</span>  <span class="comment">// get reference origin in ECEF (convert from cm to m)</span></div>
<div class="line"><span class="lineno">   42</span>  <span class="keywordtype">double</span> ecef_x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(in_msg.trajectory.location.ecef_x) / 100.0;</div>
<div class="line"><span class="lineno">   43</span>  <span class="keywordtype">double</span> ecef_y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(in_msg.trajectory.location.ecef_y) / 100.0;</div>
<div class="line"><span class="lineno">   44</span>  <span class="keywordtype">double</span> ecef_z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(in_msg.trajectory.location.ecef_z) / 100.0;</div>
<div class="line"><span class="lineno">   45</span> </div>
<div class="line"><span class="lineno">   46</span>  <span class="comment">// Convert general information</span></div>
<div class="line"><span class="lineno">   47</span>  <span class="comment">// clang-off</span></div>
<div class="line"><span class="lineno">   48</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   49</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::POSE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   50</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::VELOCITY_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   51</span>  out_msg.presence_vector |=</div>
<div class="line"><span class="lineno">   52</span>    carma_perception_msgs::msg::ExternalObject::OBJECT_TYPE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   53</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::BSM_ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   54</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::DYNAMIC_OBJ_PRESENCE;</div>
<div class="line"><span class="lineno">   55</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::PREDICTION_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   56</span>  <span class="comment">// clang-on</span></div>
<div class="line"><span class="lineno">   57</span> </div>
<div class="line"><span class="lineno">   58</span>  out_msg.object_type = carma_perception_msgs::msg::ExternalObject::SMALL_VEHICLE;</div>
<div class="line"><span class="lineno">   59</span>  std::hash&lt;std::string&gt; hasher;</div>
<div class="line"><span class="lineno">   60</span> </div>
<div class="line"><span class="lineno">   61</span>  <span class="comment">// TODO(carma) hasher returns size_t, message accept uint32_t which we might lose info</span></div>
<div class="line"><span class="lineno">   62</span>  <span class="keyword">auto</span> hashed = hasher(in_msg.m_header.sender_id);</div>
<div class="line"><span class="lineno">   63</span>  out_msg.id = <span class="keyword">static_cast&lt;</span><a class="code hl_typedef" href="stdint_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a><span class="keyword">&gt;</span>(hashed);</div>
<div class="line"><span class="lineno">   64</span> </div>
<div class="line"><span class="lineno">   65</span>  <span class="comment">// convert hex std::string to uint8_t array</span></div>
<div class="line"><span class="lineno">   66</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; in_msg.m_header.sender_bsm_id.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> += 2) {</div>
<div class="line"><span class="lineno">   67</span>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num = 0;</div>
<div class="line"><span class="lineno">   68</span>    sscanf(in_msg.m_header.sender_bsm_id.substr(<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>, <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> + 2).c_str(), <span class="stringliteral">&quot;%x&quot;</span>, &amp;num);</div>
<div class="line"><span class="lineno">   69</span>    out_msg.bsm_id.push_back((<a class="code hl_typedef" href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a>)num);</div>
<div class="line"><span class="lineno">   70</span>  }</div>
<div class="line"><span class="lineno">   71</span> </div>
<div class="line"><span class="lineno">   72</span>  <span class="comment">// first point&#39;s timestamp</span></div>
<div class="line"><span class="lineno">   73</span>  out_msg.header.stamp =</div>
<div class="line"><span class="lineno">   74</span>    rclcpp::Time((<a class="code hl_typedef" href="stdint_8h.html#aec6fcb673ff035718c238c8c9d544c47">uint64_t</a>)in_msg.m_header.timestamp * 1e6);  <span class="comment">// ms to nanoseconds</span></div>
<div class="line"><span class="lineno">   75</span> </div>
<div class="line"><span class="lineno">   76</span>  <span class="comment">// If it is a static object, we finished processing</span></div>
<div class="line"><span class="lineno">   77</span>  <span class="keywordflow">if</span> (in_msg.trajectory.offsets.size() &lt; 2) {</div>
<div class="line"><span class="lineno">   78</span>    out_msg.dynamic_obj = <span class="keyword">false</span>;</div>
<div class="line"><span class="lineno">   79</span>    <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">   80</span>  }</div>
<div class="line"><span class="lineno">   81</span>  out_msg.dynamic_obj = <span class="keyword">true</span>;</div>
<div class="line"><span class="lineno">   82</span> </div>
<div class="line"><span class="lineno">   83</span>  <span class="comment">// get planned trajectory points</span></div>
<div class="line"><span class="lineno">   84</span>  carma_perception_msgs::msg::PredictedState prev_state;</div>
<div class="line"><span class="lineno">   85</span>  tf2::Vector3 prev_pt_ecef{ecef_x, ecef_y, ecef_z};</div>
<div class="line"><span class="lineno">   86</span> </div>
<div class="line"><span class="lineno">   87</span>  <span class="keyword">auto</span> prev_pt_map = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#aa543f123dea7c2e5476ed7e17e25456f">impl::transform_to_map_frame</a>(prev_pt_ecef, map_projector);</div>
<div class="line"><span class="lineno">   88</span>  <span class="keywordtype">double</span> prev_yaw = 0.0;</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>  <span class="keywordtype">double</span> message_offset_x = 0.0;  <span class="comment">// units cm</span></div>
<div class="line"><span class="lineno">   91</span>  <span class="keywordtype">double</span> message_offset_y = 0.0;</div>
<div class="line"><span class="lineno">   92</span>  <span class="keywordtype">double</span> message_offset_z = 0.0;</div>
<div class="line"><span class="lineno">   93</span> </div>
<div class="line"><span class="lineno">   94</span>  rclcpp::Duration mobility_path_point_delta_t(mobility_path_points_timestep_size * 1e9);</div>
<div class="line"><span class="lineno">   95</span> </div>
<div class="line"><span class="lineno">   96</span>  <span class="comment">// Note the usage of current vs previous in this loop can be a bit confusing</span></div>
<div class="line"><span class="lineno">   97</span>  <span class="comment">// The intended behavior is we our always storing our prev_point but using</span></div>
<div class="line"><span class="lineno">   98</span>  <span class="comment">// curr_pt for computing velocity at prev_point</span></div>
<div class="line"><span class="lineno">   99</span>  <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = 0; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &lt; in_msg.trajectory.offsets.size(); <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>++) {</div>
<div class="line"><span class="lineno">  100</span>    <span class="keyword">auto</span> curr_pt_msg = in_msg.trajectory.offsets[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>];</div>
<div class="line"><span class="lineno">  101</span> </div>
<div class="line"><span class="lineno">  102</span>    message_offset_x = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(curr_pt_msg.offset_x) + message_offset_x;</div>
<div class="line"><span class="lineno">  103</span>    message_offset_y = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(curr_pt_msg.offset_y) + message_offset_y;</div>
<div class="line"><span class="lineno">  104</span>    message_offset_z = <span class="keyword">static_cast&lt;</span><span class="keywordtype">double</span><span class="keyword">&gt;</span>(curr_pt_msg.offset_z) + message_offset_z;</div>
<div class="line"><span class="lineno">  105</span> </div>
<div class="line"><span class="lineno">  106</span>    tf2::Vector3 curr_pt_ecef{</div>
<div class="line"><span class="lineno">  107</span>      ecef_x + message_offset_x / 100.0, ecef_y + message_offset_y / 100.0,</div>
<div class="line"><span class="lineno">  108</span>      ecef_z + message_offset_z /</div>
<div class="line"><span class="lineno">  109</span>                 100.0};  <span class="comment">// ecef_x is in m while message_offset_x is in cm. Want m as final result</span></div>
<div class="line"><span class="lineno">  110</span>    <span class="keyword">auto</span> curr_pt_map = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#aa543f123dea7c2e5476ed7e17e25456f">impl::transform_to_map_frame</a>(curr_pt_ecef, map_projector);</div>
<div class="line"><span class="lineno">  111</span> </div>
<div class="line"><span class="lineno">  112</span>    carma_perception_msgs::msg::PredictedState curr_state;</div>
<div class="line"><span class="lineno">  113</span> </div>
<div class="line"><span class="lineno">  114</span>    <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> == 0)  <span class="comment">// First point&#39;s state should be stored outside &quot;predictions&quot;</span></div>
<div class="line"><span class="lineno">  115</span>    {</div>
<div class="line"><span class="lineno">  116</span>      rclcpp::Time prev_stamp_as_time = rclcpp::Time(out_msg.header.stamp);</div>
<div class="line"><span class="lineno">  117</span>      rclcpp::Time updated_time_step = prev_stamp_as_time + mobility_path_point_delta_t;</div>
<div class="line"><span class="lineno">  118</span> </div>
<div class="line"><span class="lineno">  119</span>      <span class="keyword">auto</span> res = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#abb4c108e6903a12b1dff436ef0e6d825">impl::composePredictedState</a>(</div>
<div class="line"><span class="lineno">  120</span>        curr_pt_map, prev_pt_map, prev_stamp_as_time, updated_time_step,</div>
<div class="line"><span class="lineno">  121</span>        prev_yaw);  <span class="comment">// Position returned is that of prev_pt_map NOT curr_pt_map</span></div>
<div class="line"><span class="lineno">  122</span>      curr_state = std::get&lt;0&gt;(res);</div>
<div class="line"><span class="lineno">  123</span>      prev_yaw = std::get&lt;1&gt;(res);</div>
<div class="line"><span class="lineno">  124</span>      <span class="comment">// Compute out_msg pose</span></div>
<div class="line"><span class="lineno">  125</span>      out_msg.pose.pose =</div>
<div class="line"><span class="lineno">  126</span>        curr_state</div>
<div class="line"><span class="lineno">  127</span>          .predicted_position;  <span class="comment">// Orientation computed from first point in offsets with location</span></div>
<div class="line"><span class="lineno">  128</span>      out_msg.velocity.twist = curr_state.predicted_velocity;  <span class="comment">// Velocity derived from first point</span></div>
<div class="line"><span class="lineno">  129</span> </div>
<div class="line"><span class="lineno">  130</span>    } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  131</span>      <span class="comment">// NOTE: This is where the time increment happens but it feels incorrect.</span></div>
<div class="line"><span class="lineno">  132</span>      <span class="comment">// since the corresponding data is actually from the original prev_state stamp</span></div>
<div class="line"><span class="lineno">  133</span>      rclcpp::Time prev_stamp_as_time =</div>
<div class="line"><span class="lineno">  134</span>        rclcpp::Time(prev_state.header.stamp) + mobility_path_point_delta_t;</div>
<div class="line"><span class="lineno">  135</span>      rclcpp::Time updated_time_step = prev_stamp_as_time + mobility_path_point_delta_t;</div>
<div class="line"><span class="lineno">  136</span> </div>
<div class="line"><span class="lineno">  137</span>      <span class="keyword">auto</span> res = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#abb4c108e6903a12b1dff436ef0e6d825">impl::composePredictedState</a>(</div>
<div class="line"><span class="lineno">  138</span>        curr_pt_map, prev_pt_map, prev_stamp_as_time, updated_time_step, prev_yaw);</div>
<div class="line"><span class="lineno">  139</span>      curr_state = std::get&lt;0&gt;(res);</div>
<div class="line"><span class="lineno">  140</span>      prev_yaw = std::get&lt;1&gt;(res);</div>
<div class="line"><span class="lineno">  141</span>      out_msg.predictions.push_back(curr_state);</div>
<div class="line"><span class="lineno">  142</span>    }</div>
<div class="line"><span class="lineno">  143</span> </div>
<div class="line"><span class="lineno">  144</span>    <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  145</span>      <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> == in_msg.trajectory.offsets.size() -</div>
<div class="line"><span class="lineno">  146</span>             1)  <span class="comment">// if last point, copy the prev_state velocity &amp; orientation to the last point too</span></div>
<div class="line"><span class="lineno">  147</span>    {</div>
<div class="line"><span class="lineno">  148</span>      curr_state.predicted_position.position.x = curr_pt_map.x();</div>
<div class="line"><span class="lineno">  149</span>      curr_state.predicted_position.position.y = curr_pt_map.y();</div>
<div class="line"><span class="lineno">  150</span>      curr_state.predicted_position.position.z = curr_pt_map.z();</div>
<div class="line"><span class="lineno">  151</span>      out_msg.predictions.push_back(curr_state);</div>
<div class="line"><span class="lineno">  152</span>    }</div>
<div class="line"><span class="lineno">  153</span> </div>
<div class="line"><span class="lineno">  154</span>    prev_state = curr_state;</div>
<div class="line"><span class="lineno">  155</span>    prev_pt_map = curr_pt_map;</div>
<div class="line"><span class="lineno">  156</span>  }</div>
<div class="line"><span class="lineno">  157</span> </div>
<div class="line"><span class="lineno">  158</span>  <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#aa87a85102ac70d15b834d6e1cd3d9429">impl::calculateAngVelocityOfPredictedStates</a>(out_msg);</div>
<div class="line"><span class="lineno">  159</span> </div>
<div class="line"><span class="lineno">  160</span>  <span class="keywordflow">return</span>;</div>
<div class="line"><span class="lineno">  161</span>}</div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_aa543f123dea7c2e5476ed7e17e25456f"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#aa543f123dea7c2e5476ed7e17e25456f">motion_computation::conversion::impl::transform_to_map_frame</a></div><div class="ttdeci">tf2::Vector3 transform_to_map_frame(const tf2::Vector3 &amp;ecef_point, const lanelet::projection::LocalFrameProjector &amp;map_projector)</div><div class="ttdoc">Transforms ecef point to map frame using internally saved map transform.</div><div class="ttdef"><b>Definition:</b> <a href="mobility__path__to__external__object_8cpp_source.html#l00253">mobility_path_to_external_object.cpp:253</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_aa87a85102ac70d15b834d6e1cd3d9429"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#aa87a85102ac70d15b834d6e1cd3d9429">motion_computation::conversion::impl::calculateAngVelocityOfPredictedStates</a></div><div class="ttdeci">void calculateAngVelocityOfPredictedStates(carma_perception_msgs::msg::ExternalObject &amp;object)</div><div class="ttdoc">Helper function to fill in the angular velocity of the external object.</div><div class="ttdef"><b>Definition:</b> <a href="mobility__path__to__external__object_8cpp_source.html#l00211">mobility_path_to_external_object.cpp:211</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_abb4c108e6903a12b1dff436ef0e6d825"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#abb4c108e6903a12b1dff436ef0e6d825">motion_computation::conversion::impl::composePredictedState</a></div><div class="ttdeci">std::pair&lt; carma_perception_msgs::msg::PredictedState, double &gt; composePredictedState(const tf2::Vector3 &amp;curr_pt, const tf2::Vector3 &amp;prev_pt, const rclcpp::Time &amp;prev_time_stamp, const rclcpp::Time &amp;curr_time_stamp, double prev_yaw)</div><div class="ttdoc">Composes a PredictedState message form a provided current point and previous point....</div><div class="ttdef"><b>Definition:</b> <a href="mobility__path__to__external__object_8cpp_source.html#l00166">mobility_path_to_external_object.cpp:166</a></div></div>
<div class="ttc" id="astdint_8h_html_a435d1572bf3f880d55459d9805097f62"><div class="ttname"><a href="stdint_8h.html#a435d1572bf3f880d55459d9805097f62">uint32_t</a></div><div class="ttdeci">unsigned int uint32_t</div><div class="ttdef"><b>Definition:</b> <a href="stdint_8h_source.html#l00126">stdint.h:126</a></div></div>
<div class="ttc" id="astdint_8h_html_aba7bc1797add20fe3efdf37ced1182c5"><div class="ttname"><a href="stdint_8h.html#aba7bc1797add20fe3efdf37ced1182c5">uint8_t</a></div><div class="ttdeci">unsigned char uint8_t</div><div class="ttdef"><b>Definition:</b> <a href="stdint_8h_source.html#l00124">stdint.h:124</a></div></div>
<div class="ttc" id="astdint_8h_html_aec6fcb673ff035718c238c8c9d544c47"><div class="ttname"><a href="stdint_8h.html#aec6fcb673ff035718c238c8c9d544c47">uint64_t</a></div><div class="ttdeci">unsigned __int64 uint64_t</div><div class="ttdef"><b>Definition:</b> <a href="stdint_8h_source.html#l00136">stdint.h:136</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="mobility__path__to__external__object_8cpp_source.html#l00211">motion_computation::conversion::impl::calculateAngVelocityOfPredictedStates()</a>, <a class="el" href="mobility__path__to__external__object_8cpp_source.html#l00166">motion_computation::conversion::impl::composePredictedState()</a>, <a class="el" href="process__bag_8py_source.html#l00059">process_bag::i</a>, and <a class="el" href="mobility__path__to__external__object_8cpp_source.html#l00253">motion_computation::conversion::impl::transform_to_map_frame()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacemotion__computation_1_1conversion_ac015baeed44f7d5fbf23e8a71bb12876_cgraph.png" border="0" usemap="#anamespacemotion__computation_1_1conversion_ac015baeed44f7d5fbf23e8a71bb12876_cgraph" alt=""/></div>
<map name="anamespacemotion__computation_1_1conversion_ac015baeed44f7d5fbf23e8a71bb12876_cgraph" id="anamespacemotion__computation_1_1conversion_ac015baeed44f7d5fbf23e8a71bb12876_cgraph">
<area shape="rect" title=" " alt="" coords="5,108,145,149"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#aa87a85102ac70d15b834d6e1cd3d9429" title="Helper function to fill in the angular velocity of the external object." alt="" coords="193,5,405,76"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#abb4c108e6903a12b1dff436ef0e6d825" title="Composes a PredictedState message form a provided current point and previous point...." alt="" coords="219,101,380,157"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#aa543f123dea7c2e5476ed7e17e25456f" title="Transforms ecef point to map frame using internally saved map transform." alt="" coords="216,181,383,237"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a3dcbeb3180ab008815e6e7749796d147" title="Gets the yaw angle in degrees described by the provided quaternion." alt="" coords="453,13,637,69"/>
</map>
</div>

</div>
</div>
<a id="a9884e63460f3d5f5e2b755354984dc29" name="a9884e63460f3d5f5e2b755354984dc29"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9884e63460f3d5f5e2b755354984dc29">&#9670;&nbsp;</a></span>convert() <span class="overload">[3/3]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void motion_computation::conversion::convert </td>
          <td>(</td>
          <td class="paramtype">const carma_v2x_msgs::msg::PSM &amp;&#160;</td>
          <td class="paramname"><em>in_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">carma_perception_msgs::msg::ExternalObject &amp;&#160;</td>
          <td class="paramname"><em>out_msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const std::string &amp;&#160;</td>
          <td class="paramname"><em>map_frame_id</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pred_period</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">double&#160;</td>
          <td class="paramname"><em>pred_step_size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const lanelet::projection::LocalFrameProjector &amp;&#160;</td>
          <td class="paramname"><em>map_projector</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const tf2::Quaternion &amp;&#160;</td>
          <td class="paramname"><em>ned_in_map_rotation</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">rclcpp::node_interfaces::NodeClockInterface::SharedPtr&#160;</td>
          <td class="paramname"><em>node_clock</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">Definition at line <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00038">38</a> of file <a class="el" href="psm__to__external__object__convertor_8cpp_source.html">psm_to_external_object_convertor.cpp</a>.</p>
<div class="fragment"><div class="line"><span class="lineno">   45</span>{</div>
<div class="line"><span class="lineno">   47</span>  out_msg.dynamic_obj = <span class="keyword">true</span>;  <span class="comment">// If a PSM is sent then the object is dynamic</span></div>
<div class="line"><span class="lineno">   48</span>                               <span class="comment">// since its a living thing</span></div>
<div class="line"><span class="lineno">   49</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::DYNAMIC_OBJ_PRESENCE;</div>
<div class="line"><span class="lineno">   50</span> </div>
<div class="line"><span class="lineno">   52</span>  <span class="comment">// Generate a unique object id from the psm id</span></div>
<div class="line"><span class="lineno">   53</span>  out_msg.id = 0;</div>
<div class="line"><span class="lineno">   54</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> = in_msg.id.id.size() - 1; <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a> &gt;= 0;</div>
<div class="line"><span class="lineno">   55</span>       <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>--) {  <span class="comment">// using signed iterator to handle empty case</span></div>
<div class="line"><span class="lineno">   56</span>    <span class="comment">// each byte of the psm id gets placed in one byte of the object id.</span></div>
<div class="line"><span class="lineno">   57</span>    <span class="comment">// This should result in very large numbers which will be unlikely to</span></div>
<div class="line"><span class="lineno">   58</span>    <span class="comment">// conflict with standard detections</span></div>
<div class="line"><span class="lineno">   59</span>    out_msg.id |= in_msg.id.id[<a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>] &lt;&lt; (8 * <a class="code hl_variable" href="namespaceprocess__bag.html#af102a02c97622dd30b0dbf7bafb0d199">i</a>);</div>
<div class="line"><span class="lineno">   60</span>  }</div>
<div class="line"><span class="lineno">   61</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   64</span>  <span class="comment">// Additionally, store the id in the bsm_id field</span></div>
<div class="line"><span class="lineno">   65</span>  out_msg.bsm_id = in_msg.id.id;</div>
<div class="line"><span class="lineno">   66</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::BSM_ID_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">   67</span> </div>
<div class="line"><span class="lineno">   69</span>  <span class="comment">// Compute the timestamp</span></div>
<div class="line"><span class="lineno">   70</span> </div>
<div class="line"><span class="lineno">   71</span>  <span class="keyword">auto</span> psm_timestamp = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">impl::get_psm_timestamp</a>(in_msg, node_clock-&gt;get_clock());</div>
<div class="line"><span class="lineno">   72</span>  out_msg.header.stamp = builtin_interfaces::msg::Time(psm_timestamp);</div>
<div class="line"><span class="lineno">   73</span>  out_msg.header.frame_id = map_frame_id;</div>
<div class="line"><span class="lineno">   74</span> </div>
<div class="line"><span class="lineno">   76</span>  <span class="comment">// Set the type</span></div>
<div class="line"><span class="lineno">   77</span> </div>
<div class="line"><span class="lineno">   78</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">   79</span>    in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PEDESTRIAN ||</div>
<div class="line"><span class="lineno">   80</span>    in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PUBLIC_SAFETY_WORKER ||</div>
<div class="line"><span class="lineno">   81</span>    in_msg.basic_type.type ==</div>
<div class="line"><span class="lineno">   82</span>      j2735_v2x_msgs::msg::PersonalDeviceUserType::AN_ANIMAL)  <span class="comment">// Treat animals</span></div>
<div class="line"><span class="lineno">   83</span>                                                               <span class="comment">// like people</span></div>
<div class="line"><span class="lineno">   84</span>                                                               <span class="comment">// since we have</span></div>
<div class="line"><span class="lineno">   85</span>                                                               <span class="comment">// no internal</span></div>
<div class="line"><span class="lineno">   86</span>                                                               <span class="comment">// class for that</span></div>
<div class="line"><span class="lineno">   87</span>  {</div>
<div class="line"><span class="lineno">   88</span>    out_msg.object_type = carma_perception_msgs::msg::ExternalObject::PEDESTRIAN;</div>
<div class="line"><span class="lineno">   89</span> </div>
<div class="line"><span class="lineno">   90</span>    <span class="comment">// Default pedestrian size</span></div>
<div class="line"><span class="lineno">   91</span>    <span class="comment">// Assume a</span></div>
<div class="line"><span class="lineno">   92</span>    <span class="comment">// ExternalObject dimensions are half actual size</span></div>
<div class="line"><span class="lineno">   93</span>    <span class="comment">// Here we assume 1.0, 1.0, 2.0</span></div>
<div class="line"><span class="lineno">   94</span>    out_msg.size.x = 0.5;</div>
<div class="line"><span class="lineno">   95</span>    out_msg.size.y = 0.5;</div>
<div class="line"><span class="lineno">   96</span>    out_msg.size.z = 1.0;</div>
<div class="line"><span class="lineno">   97</span> </div>
<div class="line"><span class="lineno">   98</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">   99</span>    in_msg.basic_type.type == j2735_v2x_msgs::msg::PersonalDeviceUserType::A_PEDALCYCLIST) {</div>
<div class="line"><span class="lineno">  100</span>    out_msg.object_type = carma_perception_msgs::msg::ExternalObject::</div>
<div class="line"><span class="lineno">  101</span>      MOTORCYCLE;  <span class="comment">// Currently external object cannot represent bicycles,</span></div>
<div class="line"><span class="lineno">  102</span>                   <span class="comment">// but motor cycle seems like the next best choice</span></div>
<div class="line"><span class="lineno">  103</span> </div>
<div class="line"><span class="lineno">  104</span>    <span class="comment">// Default bicycle size</span></div>
<div class="line"><span class="lineno">  105</span>    out_msg.size.x = 1.0;</div>
<div class="line"><span class="lineno">  106</span>    out_msg.size.y = 0.5;</div>
<div class="line"><span class="lineno">  107</span>    out_msg.size.z = 1.0;</div>
<div class="line"><span class="lineno">  108</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  109</span>    out_msg.object_type = carma_perception_msgs::msg::ExternalObject::UNKNOWN;</div>
<div class="line"><span class="lineno">  110</span> </div>
<div class="line"><span class="lineno">  111</span>    <span class="comment">// Default pedestrian size</span></div>
<div class="line"><span class="lineno">  112</span>    out_msg.size.x = 0.5;</div>
<div class="line"><span class="lineno">  113</span>    out_msg.size.y = 0.5;</div>
<div class="line"><span class="lineno">  114</span>    out_msg.size.z = 1.0;</div>
<div class="line"><span class="lineno">  115</span>  }</div>
<div class="line"><span class="lineno">  116</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::SIZE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  117</span> </div>
<div class="line"><span class="lineno">  119</span>  <span class="comment">// Set the velocity</span></div>
<div class="line"><span class="lineno">  120</span> </div>
<div class="line"><span class="lineno">  121</span>  out_msg.velocity.twist.linear.x = in_msg.speed.velocity;</div>
<div class="line"><span class="lineno">  122</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::VELOCITY_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  123</span>  <span class="comment">// NOTE: The velocity covariance is not provided in the PSM. In order to</span></div>
<div class="line"><span class="lineno">  124</span>  <span class="comment">// compute it you need at least two PSM messages</span></div>
<div class="line"><span class="lineno">  125</span>  <span class="comment">//     Tracking and associating PSM messages would be an increase in</span></div>
<div class="line"><span class="lineno">  126</span>  <span class="comment">//     complexity for this conversion which is not warranted without an</span></div>
<div class="line"><span class="lineno">  127</span>  <span class="comment">//     existing use case for the velocity covariance. If a use case is</span></div>
<div class="line"><span class="lineno">  128</span>  <span class="comment">//     presented for it, such an addition can be made at that time.</span></div>
<div class="line"><span class="lineno">  129</span> </div>
<div class="line"><span class="lineno">  131</span> </div>
<div class="line"><span class="lineno">  132</span>  <span class="keywordtype">double</span> largest_position_std = 0.0;</div>
<div class="line"><span class="lineno">  133</span>  <span class="keywordtype">double</span> lat_variance = 0.0;</div>
<div class="line"><span class="lineno">  134</span>  <span class="keywordtype">double</span> lon_variance = 0.0;</div>
<div class="line"><span class="lineno">  135</span>  <span class="keywordtype">double</span> heading_variance = 0.0;     <span class="comment">// Yaw variance is not available so mark as</span></div>
<div class="line"><span class="lineno">  136</span>                                     <span class="comment">// impossible perfect case</span></div>
<div class="line"><span class="lineno">  137</span>  <span class="keywordtype">double</span> position_confidence = 0.0;  <span class="comment">// Default will be 10% confidence. If the position accuracy is</span></div>
<div class="line"><span class="lineno">  138</span>                                     <span class="comment">// available then this value will be updated</span></div>
<div class="line"><span class="lineno">  139</span> </div>
<div class="line"><span class="lineno">  140</span>  <span class="comment">// A standard deviation which is larger than the acceptable value to give</span></div>
<div class="line"><span class="lineno">  141</span>  <span class="comment">// 95% confidence interval on fitting the pedestrian within one 3.7m lane</span></div>
<div class="line"><span class="lineno">  142</span>  <span class="keyword">constexpr</span> <span class="keywordtype">double</span> MAX_POSITION_STD = 1.85;</div>
<div class="line"><span class="lineno">  143</span> </div>
<div class="line"><span class="lineno">  144</span>  <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  145</span>    (in_msg.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  146</span>     carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) &amp;&amp;</div>
<div class="line"><span class="lineno">  147</span>    (in_msg.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  148</span>     carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE)) {</div>
<div class="line"><span class="lineno">  149</span>    <span class="comment">// Both accuracies available</span></div>
<div class="line"><span class="lineno">  150</span> </div>
<div class="line"><span class="lineno">  151</span>    <span class="comment">// Compute the position covariance</span></div>
<div class="line"><span class="lineno">  152</span>    <span class="comment">// For computing confidence we will use the largest provided standard</span></div>
<div class="line"><span class="lineno">  153</span>    <span class="comment">// deviation of position</span></div>
<div class="line"><span class="lineno">  154</span>    largest_position_std = std::max(in_msg.accuracy.semi_major, in_msg.accuracy.semi_minor);</div>
<div class="line"><span class="lineno">  155</span>    lat_variance = in_msg.accuracy.semi_minor * in_msg.accuracy.semi_minor;</div>
<div class="line"><span class="lineno">  156</span>    lon_variance = in_msg.accuracy.semi_major * in_msg.accuracy.semi_major;</div>
<div class="line"><span class="lineno">  157</span>    heading_variance = in_msg.accuracy.orientation * in_msg.accuracy.orientation;</div>
<div class="line"><span class="lineno">  158</span> </div>
<div class="line"><span class="lineno">  159</span>    <span class="comment">// NOTE: ExternalObject.msg does not clearly define what is meant by</span></div>
<div class="line"><span class="lineno">  160</span>    <span class="comment">// position confidence</span></div>
<div class="line"><span class="lineno">  161</span>    <span class="comment">//     Here we are providing a linear scale based on the positional accuracy</span></div>
<div class="line"><span class="lineno">  162</span>    <span class="comment">//     where 0 confidence would denote A standard deviation which is larger</span></div>
<div class="line"><span class="lineno">  163</span>    <span class="comment">//     than the acceptable value to give 95% confidence interval on fitting</span></div>
<div class="line"><span class="lineno">  164</span>    <span class="comment">//     the pedestrian within one 3.7m lane</span></div>
<div class="line"><span class="lineno">  165</span>    <span class="comment">// Set the confidence</span></div>
<div class="line"><span class="lineno">  166</span>    <span class="comment">// Without a way of getting the velocity confidence from the PSM we will use</span></div>
<div class="line"><span class="lineno">  167</span>    <span class="comment">// the position confidence for both</span></div>
<div class="line"><span class="lineno">  168</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><span class="lineno">  169</span>    out_msg.presence_vector |=</div>
<div class="line"><span class="lineno">  170</span>      carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  171</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  172</span>    in_msg.accuracy.presence_vector | carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_AVAILABLE) {</div>
<div class="line"><span class="lineno">  173</span>    <span class="comment">// Position accuracy available</span></div>
<div class="line"><span class="lineno">  174</span> </div>
<div class="line"><span class="lineno">  175</span>    largest_position_std = std::max(in_msg.accuracy.semi_major, in_msg.accuracy.semi_minor);</div>
<div class="line"><span class="lineno">  176</span>    lat_variance = in_msg.accuracy.semi_minor * in_msg.accuracy.semi_minor;</div>
<div class="line"><span class="lineno">  177</span>    lon_variance = in_msg.accuracy.semi_major * in_msg.accuracy.semi_major;</div>
<div class="line"><span class="lineno">  178</span>    heading_variance = 1.0;  <span class="comment">// Yaw variance is not available so mark as</span></div>
<div class="line"><span class="lineno">  179</span>                             <span class="comment">// impossible perfect case</span></div>
<div class="line"><span class="lineno">  180</span> </div>
<div class="line"><span class="lineno">  181</span>    <span class="comment">// Same calculation as shown in above condition. See that for description</span></div>
<div class="line"><span class="lineno">  182</span>    out_msg.confidence = 1.0 - std::min(1.0, fabs(largest_position_std / MAX_POSITION_STD));</div>
<div class="line"><span class="lineno">  183</span>    out_msg.presence_vector |=</div>
<div class="line"><span class="lineno">  184</span>      carma_perception_msgs::msg::ExternalObject::CONFIDENCE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  185</span> </div>
<div class="line"><span class="lineno">  186</span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (</div>
<div class="line"><span class="lineno">  187</span>    in_msg.accuracy.presence_vector |</div>
<div class="line"><span class="lineno">  188</span>    carma_v2x_msgs::msg::PositionalAccuracy::ACCURACY_ORIENTATION_AVAILABLE) {</div>
<div class="line"><span class="lineno">  189</span>    <span class="comment">// Orientation accuracy available</span></div>
<div class="line"><span class="lineno">  190</span> </div>
<div class="line"><span class="lineno">  191</span>    lat_variance = 1.0;</div>
<div class="line"><span class="lineno">  192</span>    lon_variance = 1.0;</div>
<div class="line"><span class="lineno">  193</span> </div>
<div class="line"><span class="lineno">  194</span>    heading_variance = in_msg.accuracy.orientation * in_msg.accuracy.orientation;</div>
<div class="line"><span class="lineno">  195</span>  } <span class="keywordflow">else</span> {  <span class="comment">// No accuracies available</span></div>
<div class="line"><span class="lineno">  196</span>    lat_variance = 1.0;</div>
<div class="line"><span class="lineno">  197</span>    lon_variance = 1.0;</div>
<div class="line"><span class="lineno">  198</span>    heading_variance = 1.0;</div>
<div class="line"><span class="lineno">  199</span>  }</div>
<div class="line"><span class="lineno">  200</span> </div>
<div class="line"><span class="lineno">  202</span>  <span class="comment">// Compute the pose</span></div>
<div class="line"><span class="lineno">  203</span>  lanelet::GPSPoint gps_point(</div>
<div class="line"><span class="lineno">  204</span>    {in_msg.position.latitude, in_msg.position.longitude, in_msg.position.elevation});</div>
<div class="line"><span class="lineno">  205</span>  out_msg.pose = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945">impl::pose_from_gnss</a>(</div>
<div class="line"><span class="lineno">  206</span>    map_projector, ned_in_map_rotation, gps_point, in_msg.heading.heading, lat_variance,</div>
<div class="line"><span class="lineno">  207</span>    lon_variance, heading_variance);</div>
<div class="line"><span class="lineno">  208</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::POSE_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  209</span> </div>
<div class="line"><span class="lineno">  211</span>  <span class="comment">// Compute predictions</span></div>
<div class="line"><span class="lineno">  212</span>  <span class="comment">// For prediction, if the prediction is available we will sample it</span></div>
<div class="line"><span class="lineno">  213</span>  <span class="comment">// If not then assume linear motion</span></div>
<div class="line"><span class="lineno">  214</span> </div>
<div class="line"><span class="lineno">  215</span>  std::vector&lt;geometry_msgs::msg::Pose&gt; predicted_poses;</div>
<div class="line"><span class="lineno">  216</span> </div>
<div class="line"><span class="lineno">  217</span>  <span class="keywordflow">if</span> (in_msg.presence_vector &amp; carma_v2x_msgs::msg::PSM::HAS_PATH_PREDICTION) {</div>
<div class="line"><span class="lineno">  218</span>    <span class="comment">// Based on the vehicle frame used in j2735 positive should be to the right</span></div>
<div class="line"><span class="lineno">  219</span>    <span class="comment">// and negative to the left</span></div>
<div class="line"><span class="lineno">  220</span>    predicted_poses = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">impl::sample_2d_path_from_radius</a>(</div>
<div class="line"><span class="lineno">  221</span>      out_msg.pose.pose, out_msg.velocity.twist.linear.x,</div>
<div class="line"><span class="lineno">  222</span>      -in_msg.path_prediction.radius_of_curvature, pred_period, pred_step_size);</div>
<div class="line"><span class="lineno">  223</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><span class="lineno">  224</span>    predicted_poses = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073">impl::sample_2d_linear_motion</a>(</div>
<div class="line"><span class="lineno">  225</span>      out_msg.pose.pose, out_msg.velocity.twist.linear.x, pred_period, pred_step_size);</div>
<div class="line"><span class="lineno">  226</span>  }</div>
<div class="line"><span class="lineno">  227</span> </div>
<div class="line"><span class="lineno">  228</span>  out_msg.predictions = <a class="code hl_function" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3">impl::predicted_poses_to_predicted_state</a>(</div>
<div class="line"><span class="lineno">  229</span>    predicted_poses, out_msg.velocity.twist.linear.x, rclcpp::Time(out_msg.header.stamp),</div>
<div class="line"><span class="lineno">  230</span>    rclcpp::Duration(pred_step_size * 1e9), map_frame_id, out_msg.confidence, out_msg.confidence);</div>
<div class="line"><span class="lineno">  231</span>  out_msg.presence_vector |= carma_perception_msgs::msg::ExternalObject::PREDICTION_PRESENCE_VECTOR;</div>
<div class="line"><span class="lineno">  232</span>}</div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_a48389a44ecd9e272dbbcdebea32601fb"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb">motion_computation::conversion::impl::sample_2d_path_from_radius</a></div><div class="ttdeci">std::vector&lt; geometry_msgs::msg::Pose &gt; sample_2d_path_from_radius(const geometry_msgs::msg::Pose &amp;pose, double velocity, double radius_of_curvature, double period, double step_size)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00236">psm_to_external_object_convertor.cpp:236</a></div></div>
<div class="ttc" id="anamespacemotion__computation_1_1conversion_1_1impl_html_adcf6c7b8fa415af10c0cc489388fce40"><div class="ttname"><a href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40">motion_computation::conversion::impl::get_psm_timestamp</a></div><div class="ttdeci">rclcpp::Time get_psm_timestamp(const carma_v2x_msgs::msg::PSM &amp;in_msg, rclcpp::Clock::SharedPtr clock)</div><div class="ttdef"><b>Definition:</b> <a href="psm__to__external__object__convertor_8cpp_source.html#l00477">psm_to_external_object_convertor.cpp:477</a></div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00477">motion_computation::conversion::impl::get_psm_timestamp()</a>, <a class="el" href="process__bag_8py_source.html#l00059">process_bag::i</a>, <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00339">motion_computation::conversion::impl::pose_from_gnss()</a>, <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00444">motion_computation::conversion::impl::predicted_poses_to_predicted_state()</a>, <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00293">motion_computation::conversion::impl::sample_2d_linear_motion()</a>, and <a class="el" href="psm__to__external__object__convertor_8cpp_source.html#l00236">motion_computation::conversion::impl::sample_2d_path_from_radius()</a>.</p>

<p class="reference">Referenced by <a class="el" href="motion__computation__worker_8cpp_source.html#l00249">motion_computation::MotionComputationWorker::bsmCallback()</a>, <a class="el" href="GNSSToMapConvertor_8cpp_source.html#l00036">gnss_to_map_convertor::GNSSToMapConvertor::gnssFixCb()</a>, <a class="el" href="motion__computation__worker_8cpp_source.html#l00187">motion_computation::MotionComputationWorker::mobilityPathCallback()</a>, <a class="el" href="motion__computation__worker_8cpp_source.html#l00218">motion_computation::MotionComputationWorker::psmCallback()</a>, <a class="el" href="Geometry_8cpp_source.html#l00058">carma_wm::geometry::rpyFromQuaternion()</a>, and <a class="el" href="carma__cloud__client__node_8cpp_source.html#l00099">carma_cloud_client::CarmaCloudClient::XMLconversion()</a>.</p>
<div class="dynheader">
Here is the call graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_cgraph.png" border="0" usemap="#anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_cgraph" alt=""/></div>
<map name="anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_cgraph" id="anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_cgraph">
<area shape="rect" title=" " alt="" coords="5,173,145,214"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#adcf6c7b8fa415af10c0cc489388fce40" title=" " alt="" coords="239,5,379,61"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a50c675cb23fd3a743226b22287b32945" title=" " alt="" coords="239,85,378,141"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a7cf9dd84c4528278ce20562def3047c3" title=" " alt="" coords="193,165,424,221"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#ae5e3a18881b54fc666c13199ea6c7073" title=" " alt="" coords="224,245,393,301"/>
<area shape="rect" href="namespacemotion__computation_1_1conversion_1_1impl.html#a48389a44ecd9e272dbbcdebea32601fb" title=" " alt="" coords="213,325,405,381"/>
<area shape="rect" href="namespacecovariance__helper.html#af38530465ec3a2a40b4e9be14032f65e" title="Transform the covariance matrix of a PoseWithCovariance message to a new frame." alt="" coords="472,93,615,134"/>
</map>
</div>
<div class="dynheader">
Here is the caller graph for this function:</div>
<div class="dyncontent">
<div class="center"><img src="namespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_icgraph.png" border="0" usemap="#anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_icgraph" alt=""/></div>
<map name="anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_icgraph" id="anamespacemotion__computation_1_1conversion_a9884e63460f3d5f5e2b755354984dc29_icgraph">
<area shape="rect" title=" " alt="" coords="653,213,793,254"/>
<area shape="rect" href="classmotion__computation_1_1MotionComputationWorker.html#a5e3044066ec8779205710e50b90a2c08" title=" " alt="" coords="424,5,605,61"/>
<area shape="rect" href="classgnss__to__map__convertor_1_1GNSSToMapConvertor.html#a3b37a3b059aa5da9f6e6faf1d92627fb" title="GNSS Fix callback which will publish a pose representing that fix in the map frame if the required tr..." alt="" coords="433,245,596,301"/>
<area shape="rect" href="classmotion__computation_1_1MotionComputationWorker.html#ac4b94de8991236d24c73160bfcd85902" title=" " alt="" coords="424,85,605,141"/>
<area shape="rect" href="classmotion__computation_1_1MotionComputationWorker.html#a4d67a9ee5932611188f5b8f9182520f2" title=" " alt="" coords="424,165,605,221"/>
<area shape="rect" href="namespacecarma__wm_1_1geometry.html#a33b80c2f327d0293d7bdb9b4503a1cd5" title="Extract extrinsic roll&#45;pitch&#45;yaw from quaternion." alt="" coords="442,325,587,366"/>
<area shape="rect" href="classcarma__cloud__client_1_1CarmaCloudClient.html#aa9bee7b1b058329f9121ca67e071aa08" title="Funtion to Convert the TCR into XML format." alt="" coords="445,389,584,445"/>
<area shape="rect" href="classmotion__computation_1_1MotionComputationNode.html#a6fef0cbb33460d4d3c9b0c9da36dd76a" title=" " alt="" coords="199,85,370,141"/>
<area shape="rect" href="classgnss__to__map__convertor_1_1Node.html#a0de3641c944433ac709ce9ca395c24b3" title=" " alt="" coords="193,253,376,294"/>
<area shape="rect" href="classcarma__cloud__client_1_1CarmaCloudClient.html#a235e21b0786bc1fd86185f932f8894f5" title="TCR subscription callback." alt="" coords="215,389,354,445"/>
<area shape="rect" href="classcarma__cloud__client_1_1CarmaCloudClient.html#a1813aa46114d0d36cd4de6c56bd1ab35" title=" " alt="" coords="5,389,145,445"/>
</map>
</div>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="namespacemotion__computation.html">motion_computation</a></li><li class="navelem"><a class="el" href="namespacemotion__computation_1_1conversion.html">conversion</a></li>
    <li class="footer">Generated on Mon Sep 25 2023 13:21:07 for Carma-platform by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
