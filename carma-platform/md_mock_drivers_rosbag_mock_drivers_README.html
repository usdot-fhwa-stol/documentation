<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.4"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Carma-platform: rosbag_mock_drivers</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">Carma-platform<span id="projectnumber">&#160;v4.2.0</span>
   </div>
   <div id="projectbrief">CARMA Platform is built on robot operating system (ROS) and utilizes open source software (OSS) that enables Cooperative Driving Automation (CDA) features to allow Automated Driving Systems to interact and cooperate with infrastructure and other vehicles through communication.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.4 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('md_mock_drivers_rosbag_mock_drivers_README.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">rosbag_mock_drivers </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p >This package contains a node which can mimic the behavior of different types of drivers in the CARMA Platform. These fake drivers are refereed to as <a class="el" href="namespacemock__drivers.html">mock_drivers</a>. The mock drivers in this package function using real rosbag data. The general behavior is that the rosbag is played under the <code>/bag/</code> prefix and then the node will serve as a relay between that bag topic and the CARMA Platform expected topic. If the message type included a header, then the timestamp will be updated to reflect the ros::Time::now(). This allows the nodes to function both with and without the usage of the <code>--clock</code> option for the rosbag playback. For example, the Lidar mock driver has the following behavior:</p>
<ul>
<li>It subscribes to the <code>/bag/hardware_interface/lidar/points_raw</code> topic.</li>
<li>It publishes to the <code>/hardware_interface/lidar/points_raw</code> topic.</li>
<li>When a message is received from the bag it is forwarded with an updated timestamp.</li>
<li>Status heartbeats are sent on the <code>/hardware_interface/driver_discovery</code> at an ~1 Hz frequency.</li>
</ul>
<h1><a class="anchor" id="autotoc_md200"></a>
Input Data</h1>
<p >The drivers require a rosbag located at the <code>/opt/carma/data/mock_drivers/drivers.bag</code> file location in order to properly function. This file is expected to contain all topics expected by the mock drivers which are being run.</p>
<h1><a class="anchor" id="autotoc_md201"></a>
Creating new mock drivers</h1>
<p >If a developer wants to implement a new mock driver they should extend the MockDriver class found in the <code><a class="el" href="MockDriver_8h.html">include/rosbag_mock_drivers/MockDriver.h</a></code> file. There new class should be located in <code>include/rosbag_mock_drivers/</code> This would give them something similar to the following:</p>
<div class="fragment"><div class="line">#pragma once</div>
<div class="line"> </div>
<div class="line">#include &quot;rosbag_mock_drivers/MockDriver.h&quot;</div>
<div class="line"> </div>
<div class="line">namespace mock_drivers</div>
<div class="line">{</div>
<div class="line"> </div>
<div class="line">/*! \brief Description of my new driver */</div>
<div class="line">class MockNewDriver : public MockDriver</div>
<div class="line">{</div>
<div class="line">private:</div>
<div class="line">  const std::string topic_name_ = &quot;my_topic&quot;;</div>
<div class="line"> </div>
<div class="line">protected:</div>
<div class="line">  int onRun() override; // Initialization function</div>
<div class="line"> </div>
<div class="line">public:</div>
<div class="line">  MockLidarDriver(bool dummy = false); // Dummy flag will disable creation of real publishers/subscribers for unit tests</div>
<div class="line">  ~MockLidarDriver() {};</div>
<div class="line">  std::vector&lt;DriverType&gt; getDriverTypes() override; // Returns the type of driver</div>
<div class="line">  uint8_t getDriverStatus() override; // Returns current status</div>
<div class="line">  unsigned int getRate() override; // Returns the desired spin rate. This needs to be at least as fast as incoming bag data.</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line">}  // namespace mock_drivers</div>
</div><!-- fragment --><p >The implementation for this class should go in the <code>src/</code> folder as a new .cpp file , and would look something like the following:</p>
<div class="fragment"><div class="line">#include &quot;rosbag_mock_drivers/MockNewDriver.h&quot;</div>
<div class="line">#include &lt;my_msgs/NewMsg.h&gt;</div>
<div class="line"> </div>
<div class="line">namespace mock_drivers</div>
<div class="line">{</div>
<div class="line">std::vector&lt;DriverType&gt; MockNewDriver::getDriverTypes()</div>
<div class="line">{</div>
<div class="line">  return { DriverType::NEW_TYPE };</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint8_t MockNewDriver::getDriverStatus()</div>
<div class="line">{</div>
<div class="line">  return cav_msgs::DriverStatus::OPERATIONAL;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">MockNewDriver::MockNewDriver(bool dummy)</div>
<div class="line">{</div>
<div class="line">  mock_driver_node_ = MockDriverNode(dummy);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">unsigned int MockNewDriver::getRate()</div>
<div class="line">{</div>
<div class="line">  return 20;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int MockNewDriver::onRun()</div>
<div class="line">{</div>
<div class="line">  // driver publisher and subscriber</div>
<div class="line">  // bag_prefix_ is a constant defined in MockDriver.h for identifying bag topics more easily</div>
<div class="line">  addPassthroughPub&lt;my_msgs::NewMsg&gt;(bag_prefix_ + topic_name_, topic_name_, false, 10); // Add a publisher and subscriber in one call for pass through behavior.</div>
<div class="line"> </div>
<div class="line">  return 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">}  // namespace mock_drivers</div>
</div><!-- fragment --><p >Once the classes are created, the src/main.cpp file will need to be updated to take an argument specifying the usage of this new type of driver.</p>
<div class="fragment"><div class="line">else if (strcmp(&quot;my_driver&quot;, argv[1]) == 0)</div>
<div class="line">{</div>
<div class="line">  mock_drivers::MockNewDriver node;</div>
<div class="line">  node.run();</div>
<div class="line">}</div>
</div><!-- fragment --><p >Additionally, for full integration with carma the carma-config development config will need to be updated mainly the <code>drivers.launch</code> and <code>docker-compose.yml</code> launch files. Additionally, the <code>carma/launch/mock_drivers.launch</code> file should be updated to launch this new mock_driver.</p>
<h1><a class="anchor" id="autotoc_md202"></a>
Testing</h1>
<p >Due to the nature of these drivers they are currently testing exclusively using rostest. There are no regular unit tests at this time, but it may be beneficial to add them as future work. </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Dec 16 2023 02:26:02 for Carma-platform by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.4 </li>
  </ul>
</div>
</body>
</html>
